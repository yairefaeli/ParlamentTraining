!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("geodesy"),require("util"),require("primitive-primitives"),require("json-string-mapper"),require("angular2parse"),require("lodash.get"),require("heatmap.js/build/heatmap.js"),require("@angular/common"),require("rxjs"),require("rxjs/operators"),require("@angular/core")):"function"==typeof define&&define.amd?define("angular-cesium",["exports","geodesy","util","primitive-primitives","json-string-mapper","angular2parse","lodash.get","heatmap.js/build/heatmap.js","@angular/common","rxjs","rxjs/operators","@angular/core"],e):e(t["angular-cesium"]={},t.geodesy,t.util,t.primitivePrimitives,t.jsonStringMapper,t.angular2parse,t._get,t.h337,t.ng.common,t.rxjs,t.rxjs.operators,t.ng.core)}(this,function(t,o,r,i,e,n,p,u,s,w,m,a){"use strict";var c=Cesium.AssociativeArray,M=Cesium.Color,I=Cesium.ColorGeometryInstanceAttribute,A=Cesium.defined,D=Cesium.DistanceDisplayCondition,L=Cesium.DistanceDisplayConditionGeometryInstanceAttribute,T=Cesium.ShowGeometryInstanceAttribute,O=Cesium.Primitive,R=Cesium.ShadowMode,l=Cesium.BoundingSphereState,x=Cesium.ColorMaterialProperty,j=Cesium.MaterialProperty,N=Cesium.Property,F=new M,k=new D,V=new D;function d(t,e,i,n,o,r,s){var a;this.translucent=e,this.appearanceType=i,this.depthFailAppearanceType=n,this.depthFailMaterialProperty=o,this.depthFailMaterial=undefined,this.closed=r,this.shadows=s,this.primitives=t,this.createPrimitive=!1,this.waitingOnCreate=!1,this.primitive=undefined,this.oldPrimitive=undefined,this.geometry=new c,this.updaters=new c,this.updatersWithAttributes=new c,this.attributes=new c,this.subscriptions=new c,this.showsUpdated=new c,this.itemsToRemove=[],this.invalidated=!1,A(o)&&(a=o.definitionChanged.addEventListener(d.prototype.onMaterialChanged,this)),this.removeMaterialSubscription=a}d.prototype.onMaterialChanged=function(){this.invalidated=!0},d.prototype.isMaterial=function(t){var e=this.depthFailMaterialProperty,i=t.depthFailMaterialProperty;return i===e||!!A(e)&&e.equals(i)},d.prototype.add=function(o,t){var e=o.id;if(this.createPrimitive=!0,this.geometry.set(e,t),this.updaters.set(e,o),o.hasConstantFill&&o.fillMaterialProperty.isConstant&&N.isConstant(o.distanceDisplayConditionProperty)){var r=this;this.subscriptions.set(e,o.entity.definitionChanged.addEventListener(function(t,e,i,n){"isShowing"===e&&r.showsUpdated.set(o.id,o)}))}else this.updatersWithAttributes.set(e,o)},d.prototype.remove=function(t){var e=t.id;if(this.createPrimitive=this.geometry.remove(e)||this.createPrimitive,this.updaters.remove(e)){this.updatersWithAttributes.remove(e);var i=this.subscriptions.get(e);A(i)&&(i(),this.subscriptions.remove(e))}},d.prototype.update=function(t){var e,i,n=!0,o=0,r=this.primitive,s=this.primitives;if(this.createPrimitive){var a=this.geometry.values,p=a.length;if(0<p){for(A(r)&&(A(this.oldPrimitive)?s.remove(r):this.oldPrimitive=r),i=0;i<p;i++){var c=a[i],l=c.attributes;e=this.attributes.get(c.id.id),A(e)&&(A(l.show)&&(l.show.value=e.show),A(l.color)&&(l.color.value=e.color),A(l.depthFailColor)&&(l.depthFailColor.value=e.depthFailColor))}var u;A(this.depthFailAppearanceType)&&(A(this.depthFailMaterialProperty)&&(this.depthFailMaterial=j.getValue(t,this.depthFailMaterialProperty,this.depthFailMaterial)),u=new this.depthFailAppearanceType({material:this.depthFailMaterial,translucent:this.translucent,closed:this.closed})),r=new O({show:!1,asynchronous:!0,geometryInstances:a,appearance:new this.appearanceType({flat:this.shadows===R.DISABLED||this.shadows===R.CAST_ONLY,translucent:this.translucent,closed:this.closed}),depthFailAppearance:u,shadows:this.shadows}),s.add(r),n=!1}else{A(r)&&(s.remove(r),r=undefined);var d=this.oldPrimitive;A(d)&&(s.remove(d),this.oldPrimitive=undefined)}this.attributes.removeAll(),this.primitive=r,this.createPrimitive=!1,this.waitingOnCreate=!0}else if(A(r)&&r.ready){r.show=!0,A(this.oldPrimitive)&&(s.remove(this.oldPrimitive),this.oldPrimitive=undefined),!A(this.depthFailAppearanceType)||this.depthFailMaterialProperty instanceof x||(this.depthFailMaterial=j.getValue(t,this.depthFailMaterialProperty,this.depthFailMaterial),this.primitive.depthFailAppearance.material=this.depthFailMaterial);var h=this.updatersWithAttributes.values,y=h.length,f=this.waitingOnCreate;for(i=0;i<y;i++){var m=h[i],g=this.geometry.get(m.id);if(e=this.attributes.get(g.id.id),A(e)||(e=r.getGeometryInstanceAttributes(g.id),this.attributes.set(g.id.id,e)),!m.fillMaterialProperty.isConstant||f){var v=m.fillMaterialProperty.color,P=N.getValueOrDefault(v,t,M.WHITE,F);M.equals(e._lastColor,P)||(e._lastColor=M.clone(P,e._lastColor),e.color=I.toValue(P,e.color),(this.translucent&&255===e.color[3]||!this.translucent&&255!==e.color[3])&&(this.itemsToRemove[o++]=m))}if(A(this.depthFailAppearanceType)&&m.depthFailMaterialProperty instanceof x&&(!m.depthFailMaterialProperty.isConstant||f)){var b=m.depthFailMaterialProperty.color,E=N.getValueOrDefault(b,t,M.WHITE,F);M.equals(e._lastDepthFailColor,E)||(e._lastDepthFailColor=M.clone(E,e._lastDepthFailColor),e.depthFailColor=I.toValue(E,e.depthFailColor))}var C=m.entity.isShowing&&(m.hasConstantFill||m.isFilled(t));C!==(1===e.show[0])&&(e.show=T.toValue(C,e.show));var _=m.distanceDisplayConditionProperty;if(!N.isConstant(_)){var S=N.getValueOrDefault(_,t,V,k);D.equals(S,e._lastDistanceDisplayCondition)||(e._lastDistanceDisplayCondition=D.clone(S,e._lastDistanceDisplayCondition),e.distanceDisplayCondition=L.toValue(S,e.distanceDisplayCondition))}}this.updateShows(r),this.waitingOnCreate=!1}else A(r)&&!r.ready&&(n=!1);return this.itemsToRemove.length=o,n},d.prototype.updateShows=function(t){for(var e=this.showsUpdated.values,i=e.length,n=0;n<i;n++){var o=e[n],r=this.geometry.get(o.id),s=this.attributes.get(r.id.id);A(s)||(s=t.getGeometryInstanceAttributes(r.id),this.attributes.set(r.id.id,s));var a=o.entity.isShowing;a!==(1===s.show[0])&&(s.show=T.toValue(a,s.show))}this.showsUpdated.removeAll()},d.prototype.contains=function(t){return this.updaters.contains(t.id)},d.prototype.getBoundingSphere=function(t,e){var i=this.primitive;if(!i.ready)return l.PENDING;var n=i.getGeometryInstanceAttributes(t.entity);return!A(n)||!A(n.boundingSphere)||A(n.show)&&0===n.show[0]?l.FAILED:(n.boundingSphere.clone(e),l.DONE)},d.prototype.removeAllPrimitives=function(){var t=this.primitives,e=this.primitive;A(e)&&(t.remove(e),this.primitive=undefined,this.geometry.removeAll(),this.updaters.removeAll());var i=this.oldPrimitive;A(i)&&(t.remove(i),this.oldPrimitive=undefined)};var h=!(d.prototype.destroy=function(){var t=this.primitive,e=this.primitives;A(t)&&e.remove(t);var i=this.oldPrimitive;A(i)&&e.remove(i),A(this.removeMaterialSubscription)&&this.removeMaterialSubscription()});var y=new a.InjectionToken("ANGULAR_CESIUM_CONFIG"),f=function(){function t(t){!1!==(!(this.config=t)||t.fixEntitiesShadows)&&function e(){h||(Cesium.StaticGeometryColorBatch.prototype.add=function(t,e){var i,n,o=e.createFillGeometryInstance(t);n=255===o.attributes.color.value[3]?(i=this._solidItems,!1):(i=this._translucentItems,!0);for(var r=i.length,s=0;s<r;s++){var a=i[s];if(a.isMaterial(e))return void a.add(e,o)}var p=new d(this._primitives,n,this._appearanceType,this._depthFailAppearanceType,e.depthFailMaterialProperty,this._closed,this._shadows);p.add(e,o),i.push(p)},h=!0)}()}return t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:undefined,decorators:[{type:a.Optional},{type:a.Inject,args:[y]}]}]},t}(),g={SCENE3D:0,COLUMBUS_VIEW:1,SCENE2D:2,PERFORMANCE_SCENE2D:3};g[g.SCENE3D]="SCENE3D",g[g.COLUMBUS_VIEW]="COLUMBUS_VIEW",g[g.SCENE2D]="SCENE2D",g[g.PERFORMANCE_SCENE2D]="PERFORMANCE_SCENE2D";var v=function(){function o(){this.isSceneModePerformance2D=!1}return o.prototype.init=function(t){this.viewer=t.getViewer(),this.scene=t.getScene(),this.screenSpaceCameraController=this.scene.screenSpaceCameraController,this.camera=this.scene.camera,this.lastRotate=this.screenSpaceCameraController.enableRotate,this.lastTilt=this.screenSpaceCameraController.enableTilt,this.lastLook=this.screenSpaceCameraController.enableLook},o.prototype._listenToSceneModeMorph=function(t){this.morphListenerCancelFn=this.scene.morphStart.addEventListener(t)},o.prototype._revertCameraProperties=function(){this.isSceneModePerformance2D=!1,this.enableTilt(this.lastTilt),this.enableRotate(this.lastRotate),this.enableLook(this.lastLook)},o.prototype.getCamera=function(){return this.camera},o.prototype.getScreenSpaceCameraController=function(){return this.screenSpaceCameraController},o.prototype.getMinimumZoom=function(){return this.screenSpaceCameraController.minimumZoomDistance},o.prototype.setMinimumZoom=function(t){this.screenSpaceCameraController.minimumZoomDistance=t},o.prototype.getMaximumZoom=function(){return this.screenSpaceCameraController.maximumZoomDistance},o.prototype.setMaximumZoom=function(t){this.screenSpaceCameraController.maximumZoomDistance=t},o.prototype.enableTilt=function(t){this.screenSpaceCameraController.enableTilt=t},o.prototype.enableRotate=function(t){this.screenSpaceCameraController.enableRotate=t},o.prototype.enableLook=function(t){this.screenSpaceCameraController.enableLook=t},o.prototype.enableTranslate=function(t){this.screenSpaceCameraController.enableTranslate=t},o.prototype.enableZoom=function(t){this.screenSpaceCameraController.enableZoom=t},o.prototype.enableInputs=function(t){this.screenSpaceCameraController.enableInputs=t},o.prototype.setSceneMode=function(t,e){var i=this;switch(t){case g.SCENE3D:this.isSceneModePerformance2D&&this._revertCameraProperties(),this.scene.morphTo3D(e);break;case g.COLUMBUS_VIEW:this.isSceneModePerformance2D&&this._revertCameraProperties(),this.scene.morphToColumbusView(e);break;case g.SCENE2D:this.isSceneModePerformance2D&&this._revertCameraProperties(),this.scene.morphTo2D(e);break;case g.PERFORMANCE_SCENE2D:this.isSceneModePerformance2D=!0,this.lastLook=this.screenSpaceCameraController.enableLook,this.lastTilt=this.screenSpaceCameraController.enableTilt,this.lastRotate=this.screenSpaceCameraController.enableRotate,this.screenSpaceCameraController.enableTilt=!1,this.screenSpaceCameraController.enableRotate=!1,this.screenSpaceCameraController.enableLook=!1,this.morphListenerCancelFn&&this.morphListenerCancelFn(),this.scene.morphToColumbusView(e);var n=this.scene.morphComplete.addEventListener(function(){i.camera.setView({destination:Cesium.Cartesian3.fromDegrees(0,0,Math.min(o.PERFORMANCE_2D_ALTITUDE,i.getMaximumZoom())),orientation:{pitch:Cesium.Math.toRadians(-90)}}),n(),i._listenToSceneModeMorph(i._revertCameraProperties.bind(i))})}},o.prototype.cameraFlyTo=function(t){return this.camera.flyTo(t)},o.prototype.flyTo=function(t,e){return this.viewer.flyTo(t,e)},o.prototype.zoomIn=function(t){return this.camera.zoomIn(t||this.camera.defaultZoomAmount)},o.prototype.zoomOut=function(t){return this.camera.zoomIn(t||this.camera.defaultZoomAmount)},o.prototype.zoomTo=function(t,e){return this.viewer.zoomTo(t,e)},o.prototype.setView=function(t){this.camera.setView(t)},o.prototype.setRotation=function(t){this.setView({orientation:{heading:t}})},o.prototype.lockRotation=function(t){this.scene.screenSpaceCameraController.enableRotate=!t},o.prototype.trackEntity=function(a,p){var c=this,l=p&&p.flyTo||!1;return this.viewer.trackedEntity=undefined,new Promise(function(t){if(l){var e=p&&p.flyToDuration||1,i=p&&p.altitude||1e4,n=a.position.getValue(Cesium.JulianDate.now()),o=Cesium.Cartographic.fromCartesian(n),r=i-o.height;o.height=i;var s=Cesium.Cartesian3.fromRadians(o.longitude,o.latitude,o.height);c.cameraFlyTo({duration:e,destination:s,complete:function(){c.viewer.trackedEntity=a,setTimeout(function(){0<r?c.camera.zoomOut(r):c.camera.zoomIn(r)},0),t()}})}else c.viewer.trackedEntity=a,t()})},o.prototype.untrackEntity=function(){this.trackEntity()},o.PERFORMANCE_2D_ALTITUDE=25e6,o.decorators=[{type:a.Injectable}],o.ctorParameters=function(){return[]},o}(),P=function(t,e){return(P=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function b(t,e){function i(){this.constructor=t}P(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var E=function(){return(E=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var o in e=arguments[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function C(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var n,o,r=i.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(n=r.next()).done;)s.push(n.value)}catch(a){o={error:a}}finally{try{n&&!n.done&&(i=r["return"])&&i.call(r)}finally{if(o)throw o.error}}return s}function _(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(C(arguments[e]));return t}var S=function(){function t(){this.cesium=Cesium}return t.prototype.createViewer=function(t,e){return e?new this.cesium.Viewer(t,E({contextOptions:{webgl:{preserveDrawingBuffer:!0}}},e)):new this.cesium.Viewer(t,{imageryProvider:Cesium.createTileMapServiceImageryProvider({url:Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII")}),baseLayerPicker:!1,geocoder:!1,contextOptions:{webgl:{preserveDrawingBuffer:!0}}})},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[]},t}(),H=function(){function t(){this.nextViewerOptionsIndex=0,this.nextViewerModifierIndex=0}return Object.defineProperty(t.prototype,"viewerOptions",{get:function(){return this._viewerOptions},set:function(t){this._viewerOptions=t},enumerable:!0,configurable:!0}),t.prototype.getNextViewerOptions=function(){return this._viewerOptions instanceof Array?this._viewerOptions[this.nextViewerOptionsIndex++]:this._viewerOptions},Object.defineProperty(t.prototype,"viewerModifier",{get:function(){return this._viewerModifier},set:function(t){this._viewerModifier=t},enumerable:!0,configurable:!0}),t.prototype.getNextViewerModifier=function(){return this._viewerModifier instanceof Array?this._viewerModifier[this.nextViewerModifierIndex++]:this._viewerModifier},t.decorators=[{type:a.Injectable}],t}(),B=function(){function t(t,e,i){this.ngZone=t,this.viewerFactory=e,this.viewerConfiguration=i}return t.prototype.init=function(i,t){var n=this;this.map=t,this.ngZone.runOutsideAngular(function(){var t=n.viewerConfiguration?n.viewerConfiguration.getNextViewerOptions():undefined;n.cesiumViewer=n.viewerFactory.createViewer(i,t);var e=n.viewerConfiguration&&n.viewerConfiguration.getNextViewerModifier();"function"==typeof e&&e(n.cesiumViewer)})},t.prototype.getViewer=function(){return this.cesiumViewer},t.prototype.getScene=function(){return this.cesiumViewer.scene},t.prototype.getCanvas=function(){return this.cesiumViewer.canvas},t.prototype.getMap=function(){return this.map},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:a.NgZone},{type:S},{type:H,decorators:[{type:a.Optional}]}]},t}(),G={MOUSE_MOVE:Cesium.ScreenSpaceEventType.MOUSE_MOVE,LEFT_CLICK:Cesium.ScreenSpaceEventType.LEFT_CLICK,LEFT_DOUBLE_CLICK:Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK,LEFT_DOWN:Cesium.ScreenSpaceEventType.LEFT_DOWN,LEFT_UP:Cesium.ScreenSpaceEventType.LEFT_UP,MIDDLE_CLICK:Cesium.ScreenSpaceEventType.MIDDLE_CLICK,MIDDLE_DOUBLE_CLICK:Cesium.ScreenSpaceEventType.MIDDLE_DOUBLE_CLICK,MIDDLE_DOWN:Cesium.ScreenSpaceEventType.MIDDLE_DOWN,MIDDLE_UP:Cesium.ScreenSpaceEventType.MIDDLE_UP,PINCH_START:Cesium.ScreenSpaceEventType.PINCH_START,PINCH_END:Cesium.ScreenSpaceEventType.PINCH_END,PINCH_MOVE:Cesium.ScreenSpaceEventType.PINCH_MOVE,RIGHT_CLICK:Cesium.ScreenSpaceEventType.RIGHT_CLICK,RIGHT_DOUBLE_CLICK:Cesium.ScreenSpaceEventType.RIGHT_DOUBLE_CLICK,RIGHT_DOWN:Cesium.ScreenSpaceEventType.RIGHT_DOWN,RIGHT_UP:Cesium.ScreenSpaceEventType.RIGHT_UP,WHEEL:Cesium.ScreenSpaceEventType.WHEEL,LONG_LEFT_PRESS:110,LONG_RIGHT_PRESS:111,LONG_MIDDLE_PRESS:112,LEFT_CLICK_DRAG:113,RIGHT_CLICK_DRAG:114,MIDDLE_CLICK_DRAG:115};G[G.LONG_LEFT_PRESS]="LONG_LEFT_PRESS",G[G.LONG_RIGHT_PRESS]="LONG_RIGHT_PRESS",G[G.LONG_MIDDLE_PRESS]="LONG_MIDDLE_PRESS",G[G.LEFT_CLICK_DRAG]="LEFT_CLICK_DRAG",G[G.RIGHT_CLICK_DRAG]="RIGHT_CLICK_DRAG",G[G.MIDDLE_CLICK_DRAG]="MIDDLE_CLICK_DRAG";var U={NO_PICK:0,PICK_FIRST:1,PICK_ONE:2,PICK_ALL:3};U[U.NO_PICK]="NO_PICK",U[U.PICK_FIRST]="PICK_FIRST",U[U.PICK_ONE]="PICK_ONE",U[U.PICK_ALL]="PICK_ALL";var z=function(){function t(){this._showContextMenu=!1,this._contextMenuChangeNotifier=new a.EventEmitter,this._onOpen=new a.EventEmitter,this._onClose=new a.EventEmitter,this._defaultContextMenuOptions={closeOnLeftCLick:!0,closeOnLeftClickPriority:10}}return Object.defineProperty(t.prototype,"contextMenuChangeNotifier",{get:function(){return this._contextMenuChangeNotifier},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showContextMenu",{get:function(){return this._showContextMenu},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this._options},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"content",{get:function(){return this._content},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onOpen",{get:function(){return this._onOpen},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onClose",{get:function(){return this._onClose},enumerable:!0,configurable:!0}),t.prototype.init=function(t){this.mapEventsManager=t},t.prototype.open=function(t,e,i){var n=this;void 0===i&&(i={}),this.close(),this._content=t,this._position=e,this._options=Object.assign({},this._defaultContextMenuOptions,i),this._showContextMenu=!0,this.mapEventsManager&&this._options.closeOnLeftCLick&&(this.leftClickRegistration=this.mapEventsManager.register({event:G.LEFT_CLICK,pick:U.NO_PICK,priority:this._options.closeOnLeftClickPriority}),this.leftClickSubscription=this.leftClickRegistration.subscribe(function(){n.leftClickSubscription.unsubscribe(),n.close()})),this._contextMenuChangeNotifier.emit(),this._onOpen.emit()},t.prototype.close=function(){this._content=undefined,this._position=undefined,this._options=undefined,this._showContextMenu=!1,this.leftClickRegistration&&(this.leftClickRegistration.dispose(),this.leftClickRegistration=undefined),this.leftClickSubscription&&(this.leftClickSubscription.unsubscribe(),this.leftClickSubscription=undefined),this._contextMenuChangeNotifier.emit(),this._onClose.emit()},t.decorators=[{type:a.Injectable}],t}(),K=o.LatLonVectors;window.geodesy=o;var W,$=function(){function t(t){this.cesiumService=t}return t.prototype.screenToCartesian3=function(t,e){if(this.cesiumService){var i=E({},t);if(e){var n=this.cesiumService.getViewer().canvas.getBoundingClientRect();i.x+=n.left,i.y+=n.top}return this.cesiumService.getViewer().camera.pickEllipsoid(i)}throw new Error("ANGULAR2-CESIUM - Cesium service should be provided in order to do screen position calculations")},t.prototype.screenToCartographic=function(t,e){return this.cartesian3ToCartographic(this.screenToCartesian3(t),e)},t.prototype.cartesian3ToCartographic=function(t,e){return Cesium.Cartographic.fromCartesian(t,e)},t.prototype.degreesToCartographic=function(t,e,i){return Cesium.Cartographic.fromDegrees(t,e,i)},t.prototype.radiansToCartographic=function(t,e,i){return Cesium.Cartographic.fromRadians(t,e,i)},t.prototype.degreesToUTM=function(t,e){return new o.LatLonEllipsoidal(e,t).toUtm()},t.prototype.UTMToDegrees=function(t,e,i,n){return this.geodesyToCesiumObject(new o.Utm(t,e,i,n).toLatLonE())},t.prototype.geodesyToCesiumObject=function(t){return{longitude:t.lon,latitude:t.lat,height:t.height?t.height:0}},t.prototype.midPointToCartesian3=function(t,e){var i=function(t){return Cesium.Math.toDegrees(t)},n=new K(i(t.latitude),i(t.longitude)),o=new K(i(e.latitude),i(e.longitude)),r=n.midpointTo(o);return Cesium.Cartesian3.fromDegrees(r.lon,r.lat)},t.prototype.middlePointByScreen=function(t,e){var i=this.cesiumService.getScene(),n=Cesium.SceneTransforms.wgs84ToWindowCoordinates(i,t),o=Cesium.SceneTransforms.wgs84ToWindowCoordinates(i,e),r=new Cesium.Cartesian2((o.x+n.x)/2,(o.y+n.y)/2);return i.pickPosition(r)},t.prototype.bearingTo=function(t,e){var i=function(t){return Cesium.Math.toDegrees(t)},n=new K(i(t.latitude),i(t.longitude)),o=new K(i(e.latitude),i(e.longitude));return n.bearingTo(o)},t.prototype.bearingToCartesian=function(t,e){var i=Cesium.Cartographic.fromCartesian(t),n=Cesium.Cartographic.fromCartesian(e);return this.bearingTo(i,n)},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B,decorators:[{type:a.Optional}]}]},t}(),Z=function(){function t(){}return t.prototype.setPropsAssigner=function(t){this._propsAssigner=t},t}(),Y=function(n){function t(t,e){var i=n.call(this)||this;return i.drawerType=t,i.cesiumService=e,i._show=!0,i}return b(t,n),t.prototype.init=function(){this._cesiumCollection=new this.drawerType,this._primitiveCollectionWrap=new Cesium.PrimitiveCollection,this._primitiveCollectionWrap.add(this._cesiumCollection),this.cesiumService.getScene().primitives.add(this._primitiveCollectionWrap)},t.prototype.add=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];return this._cesiumCollection.add(t)},t.prototype.update=function(t,e){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];this._propsAssigner?this._propsAssigner(t,e):Object.assign(t,e)},t.prototype.remove=function(t){this._cesiumCollection.remove(t)},t.prototype.removeAll=function(){this._cesiumCollection.removeAll()},t.prototype.setShow=function(t){this._show=t,this._primitiveCollectionWrap.show=t},t.prototype.getShow=function(){return this._show},t}(Z),q=function(){function d(t){this.cesiumService=t}return d.pointByLocationDistanceAndAzimuth=function(t,e,i,n){for(var o,r,s=e/Cesium.Ellipsoid.WGS84.maximumRadius,a=t instanceof Cesium.Cartesian3?Cesium.Cartographic.fromCartesian(t):t,p=t instanceof Cesium.Cartesian3?t:Cesium.Cartesian3.fromRadians(t.longitude,t.latitude,t.height),c=0,l=.1,u=-.1;0===c||c<16&&1.000001<Math.max(r,e)/Math.min(r,e);){o=d._pointByLocationDistanceAndAzimuth(a,s*(1+(u+(l-u)/2)),i),e<(r=this.distance(p,o))?l=u+(l-u)/2:u+=(l-u)/2,c++}return o},d._pointByLocationDistanceAndAzimuth=function(t,e,i){var n=t.latitude,o=t.longitude,r=Math.asin(Math.sin(n)*Math.cos(e)+Math.cos(n)*Math.sin(e)*Math.cos(i)),s=o+Math.atan2(Math.sin(i)*Math.sin(e)*Math.cos(n),Math.cos(e)-Math.sin(n)*Math.sin(r));return s=(s+3*Math.PI)%(2*Math.PI)-Math.PI,Cesium.Cartesian3.fromRadians(s,r)},d.distance=function(t,e){return Cesium.Cartesian3.distance(t,e)},d.getPositionsDelta=function(t,e){return{x:e.x-t.x,y:e.y-t.y,z:e.z-t.z}},d.addDeltaToPosition=function(t,e,i){if(void 0===i&&(i=!1),i){t.x+=e.x,t.y+=e.y,t.z+=e.z,(o=Cesium.Cartographic.fromCartesian(t)).height=0;var n=Cesium.Cartesian3.fromRadians(o.longitude,o.latitude,o.height);return t.x=n.x,t.y=n.y,t.z=n.z,t}var o;n=new Cesium.Cartesian3(t.x+e.x,t.y+e.y,t.z+e.z);return(o=Cesium.Cartographic.fromCartesian(n)).height=0,Cesium.Cartesian3.fromRadians(o.longitude,o.latitude,o.height)},d.middleCartesian3Point=function(t,e){return new Cesium.Cartesian3(e.x-t.x/2,e.y-t.y/2,e.z-t.z/2)},d.prototype.screenPositionToCartesian3=function(t){return this.cesiumService.getViewer().camera.pickEllipsoid(t)},d.decorators=[{type:a.Injectable}],d.ctorParameters=function(){return[{type:B}]},d}(),X=function(e){function t(t){return e.call(this,Cesium.PolylineCollection,t)||this}return b(t,e),t.prototype._calculateArcPositions=function(t){for(var e=t.quality||18,i=t.delta/e,n=[],o=0;o<e+1;++o){var r=q.pointByLocationDistanceAndAzimuth(t.center,t.radius,t.angle+i*o,!0);n.push(r)}return n},t.prototype._calculateTriangle=function(t){return[t.center,q.pointByLocationDistanceAndAzimuth(t.center,t.radius,t.angle,!0)]},t.prototype._calculateArc=function(t){var e=this._calculateArcPositions(t);return t.drawEdges?e.concat(this._calculateTriangle(t)):e},t.prototype.add=function(t){if(t.positions=this._calculateArc(t),t.color){var e=Cesium.Material.fromType("Color");e.uniforms.color=t.color,t.material=e}return this._cesiumCollection.add(t)},t.prototype.update=function(t,e){return e.constantColor||!e.color||t.material.uniforms.color.equals(e.color)||(t.material.uniforms.color=e.color),t.width=e.width!==undefined?e.width:t.width,t.show=e.show!==undefined?e.show:t.show,t.distanceDisplayCondition=e.distanceDisplayCondition!==undefined?e.distanceDisplayCondition:t.distanceDisplayCondition,t.positions=this._calculateArc(e),t},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Y),J={ellipse:Cesium.EllipseGraphics,ellipsoid:Cesium.EllipsoidGraphics,polygon:Cesium.PolygonGraphics,polyline:Cesium.PolylineGraphics,polylineVolume:Cesium.PolylineVolumeGraphics,box:Cesium.BoxGraphics,corridor:Cesium.CorridorGraphics,cylinder:Cesium.CylinderGraphics,label:Cesium.LabelGraphics,billboard:Cesium.BillboardGraphics,model:Cesium.ModelGraphics,path:Cesium.PathGraphics,point:Cesium.PointGraphics,rectangle:Cesium.RectangleGraphics,wall:Cesium.WallGraphics},Q=function(){function t(t,e,i){void 0===e&&(e=-1),void 0===i&&(i=-1),this.entityCollection=t,this._isSuspended=!1,this._isHardSuspend=!1,this._updateRate=i,this._collectionSize=e}return t.prototype.setShow=function(t){this.entityCollection.show=t},Object.defineProperty(t.prototype,"isSuspended",{get:function(){return this._isSuspended},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updateRate",{get:function(){return this._updateRate},set:function(t){this._updateRate=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"collectionSize",{get:function(){return this._collectionSize},set:function(t){this._collectionSize=t},enumerable:!0,configurable:!0}),t.prototype.collection=function(){return this.entityCollection},t.prototype.isFree=function(){return this._collectionSize<1||this.entityCollection.values.length<this._collectionSize},t.prototype.add=function(t){return this.suspend(),this.entityCollection.add(t)},t.prototype.remove=function(t){return this.suspend(),this.entityCollection.remove(t)},t.prototype.removeNoSuspend=function(t){this.entityCollection.remove(t)},t.prototype.removeAll=function(){this.suspend(),this.entityCollection.removeAll()},t.prototype.onEventSuspension=function(t,e){var i=this;return void 0===e&&(e=!1),this._onEventSuspensionCallback={callback:t,once:e},function(){i._onEventSuspensionCallback=undefined}},t.prototype.onEventResume=function(t,e){var i=this;return void 0===e&&(e=!1),this._onEventResumeCallback={callback:t,once:e},this._isSuspended||this.triggerEventResume(),function(){i._onEventResumeCallback=undefined}},t.prototype.triggerEventSuspension=function(){if(this._onEventSuspensionCallback!==undefined){var t=this._onEventSuspensionCallback.callback;this._onEventSuspensionCallback.once&&(this._onEventSuspensionCallback=undefined),t()}},t.prototype.triggerEventResume=function(){if(this._onEventResumeCallback!==undefined){var t=this._onEventResumeCallback.callback;this._onEventResumeCallback.once&&(this._onEventResumeCallback=undefined),t()}},t.prototype.suspend=function(){var t=this;this._updateRate<0||this._isHardSuspend||this._isSuspended||(this._isSuspended=!0,this.entityCollection.suspendEvents(),this.triggerEventSuspension(),this._suspensionTimeout=setTimeout(function(){t.entityCollection.resumeEvents(),t.triggerEventResume(),t._isSuspended=!1,t._suspensionTimeout=undefined},this._updateRate))},t.prototype.hardSuspend=function(){this.entityCollection.suspendEvents(),this._isHardSuspend=!0},t.prototype.hardResume=function(){this.entityCollection.resumeEvents(),this._isHardSuspend=!1},t}(),tt=function(r){function t(t,e,i){void 0===i&&(i={collectionMaxSize:-1,collectionSuspensionTime:-1,collectionsNumber:1});var n=r.call(this)||this;for(var o in n.cesiumService=t,n.graphicsType=e,n.defaultOptions=i,n.entityCollections=new Map,n.graphicsTypeName=J[n.graphicsType],J)J[o]===n.graphicsType&&(n.graphicsTypeName=o);return n}return b(t,r),t.prototype.getFreeEntitiesCollection=function(){var e=null;return this.entityCollections.forEach(function(t){t.isFree()&&(e=t)}),e},t.prototype.init=function(t){for(var e=t||this.defaultOptions,i=[],n=0;n<e.collectionsNumber;n++){var o=new Cesium.CustomDataSource(this.graphicsTypeName);i.push(o),this.cesiumService.getViewer().dataSources.add(o),this.entityCollections.set(o.entities,new Q(o.entities,e.collectionMaxSize,e.collectionSuspensionTime))}return i},t.prototype.add=function(t){var e,i=this.getFreeEntitiesCollection();if(null===i)throw new Error("No more free entity collections");this.graphicsType;var n=((e={position:t.position!==undefined?t.position:undefined,description:t.description!==undefined?t.description:undefined,orientation:t.orientation!==undefined?t.orientation:undefined,viewFrom:t.viewFrom!==undefined?t.viewFrom:undefined})[this.graphicsTypeName]=t,e);return t.name!==undefined&&(n.name=t.name),i.add(n)},t.prototype.update=function(t,e){this.suspendEntityCollection(t),t.position instanceof Cesium.CallbackProperty&&t.position._isConstant&&(t.position=e.position),t.position=e.position!==undefined?e.position:undefined,t.name=e.name!==undefined?e.name:t.name,t.description=e.description!==undefined?e.description:t.description,t.orientation=e.orientation!==undefined?e.orientation:t.orientation,t.viewFrom=e.viewFrom!==undefined?e.viewFrom:t.viewFrom,this._propsAssigner?this._propsAssigner(t[this.graphicsTypeName],e):Object.assign(t[this.graphicsTypeName],e)},t.prototype.remove=function(t){this.entityCollections.get(t.entityCollection).remove(t)},t.prototype.removeAll=function(){this.entityCollections.forEach(function(t){t.removeAll()})},t.prototype.setShow=function(e){this.entityCollections.forEach(function(t){t.setShow(e)})},t.prototype.suspendEntityCollection=function(t){var e=t.entityCollection;if(!this.entityCollections.has(e))throw new Error("No EntityCollection for entity.entityCollection");this.entityCollections.get(e).suspend()},t}(Z),et=function(e){function t(t){return e.call(this,t,J.billboard)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),it=function(i){function t(t){var e=i.call(this)||this;return e.cesiumService=t,e}return b(t,i),t.prototype.init=function(t){var e=[];return this.czmlStream=new Cesium.CzmlDataSource("czml"),e.push(this.czmlStream),this.cesiumService.getViewer().dataSources.add(this.czmlStream),e},t.prototype.add=function(t){return this.czmlStream.process(t.czmlPacket),t},t.prototype.update=function(t,e){this.czmlStream.process(e.czmlPacket)},t.prototype.remove=function(t){this.czmlStream.entities.removeById(t.acEntity.id)},t.prototype.removeAll=function(){this.czmlStream.entities.removeAll()},t.prototype.setShow=function(t){this.czmlStream.entities.show=t},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Z),nt=function(e){function t(t){return e.call(this,t,J.ellipse,{collectionsNumber:10,collectionMaxSize:450,collectionSuspensionTime:100})||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),ot=function(e){function t(t){return e.call(this,t,J.label)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),rt=function(e){function t(t){return e.call(this,t,J.point)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),st=function(e){function t(t){return e.call(this,t,J.polygon)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),at=function(e){function t(t){return e.call(this,t,J.polyline)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),pt=function(i){function t(t){return i.call(this,Cesium.PolylineCollection,t)||this}return b(t,i),t.prototype.add=function(t){return this._cesiumCollection.add(this.withColorMaterial(t))},t.prototype.update=function(t,e){e.material instanceof Cesium.Color&&(t.material&&t.material.uniforms&&t.material.uniforms.color instanceof Cesium.Color?this.withColorMaterial(e):t.material.uniforms.color.equals(e.material)||(t.material.uniforms.color=e.material)),i.prototype.update.call(this,t,e)},t.prototype.withColorMaterial=function(t){if(t.material instanceof Cesium.Color){var e=Cesium.Material.fromType("Color");e.uniforms.color=t.material,t.material=e}return t},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Y),ct={CAMERA_FORWARD:0,CAMERA_BACKWARD:1,CAMERA_RIGHT:2,CAMERA_LEFT:3,CAMERA_UP:4,CAMERA_DOWN:5,CAMERA_LOOK_RIGHT:6,CAMERA_LOOK_LEFT:7,CAMERA_LOOK_UP:8,CAMERA_LOOK_DOWN:9,CAMERA_TWIST_RIGHT:10,CAMERA_TWIST_LEFT:11,CAMERA_ROTATE_RIGHT:12,CAMERA_ROTATE_LEFT:13,CAMERA_ROTATE_UP:14,CAMERA_ROTATE_DOWN:15,CAMERA_ZOOM_IN:16,CAMERA_ZOOM_OUT:17};ct[ct.CAMERA_FORWARD]="CAMERA_FORWARD",ct[ct.CAMERA_BACKWARD]="CAMERA_BACKWARD",ct[ct.CAMERA_RIGHT]="CAMERA_RIGHT",ct[ct.CAMERA_LEFT]="CAMERA_LEFT",ct[ct.CAMERA_UP]="CAMERA_UP",ct[ct.CAMERA_DOWN]="CAMERA_DOWN",ct[ct.CAMERA_LOOK_RIGHT]="CAMERA_LOOK_RIGHT",ct[ct.CAMERA_LOOK_LEFT]="CAMERA_LOOK_LEFT",ct[ct.CAMERA_LOOK_UP]="CAMERA_LOOK_UP",ct[ct.CAMERA_LOOK_DOWN]="CAMERA_LOOK_DOWN",ct[ct.CAMERA_TWIST_RIGHT]="CAMERA_TWIST_RIGHT",ct[ct.CAMERA_TWIST_LEFT]="CAMERA_TWIST_LEFT",ct[ct.CAMERA_ROTATE_RIGHT]="CAMERA_ROTATE_RIGHT",ct[ct.CAMERA_ROTATE_LEFT]="CAMERA_ROTATE_LEFT",ct[ct.CAMERA_ROTATE_UP]="CAMERA_ROTATE_UP",ct[ct.CAMERA_ROTATE_DOWN]="CAMERA_ROTATE_DOWN",ct[ct.CAMERA_ZOOM_IN]="CAMERA_ZOOM_IN",ct[ct.CAMERA_ZOOM_OUT]="CAMERA_ZOOM_OUT";var lt=((W={})[ct.CAMERA_FORWARD]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveForward(n)},W[ct.CAMERA_BACKWARD]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveBackward(n)},W[ct.CAMERA_UP]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveUp(n)},W[ct.CAMERA_DOWN]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveDown(n)},W[ct.CAMERA_RIGHT]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveRight(n)},W[ct.CAMERA_LEFT]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveLeft(n)},W[ct.CAMERA_LOOK_RIGHT]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||.01;i.lookRight(n.latitude*o)},W[ct.CAMERA_LOOK_LEFT]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||.01;i.lookLeft(n.latitude*o)},W[ct.CAMERA_LOOK_UP]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||.01;i.lookUp(n.longitude*(-1*o))},W[ct.CAMERA_LOOK_DOWN]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||.01;i.lookDown(n.longitude*(-1*o))},W[ct.CAMERA_TWIST_RIGHT]=function(t,e){var i=t.getViewer().camera,n=e.amount||.01;i.twistRight(n)},W[ct.CAMERA_TWIST_LEFT]=function(t,e){var i=t.getViewer().camera,n=e.amount||.01;i.twistLeft(n)},W[ct.CAMERA_ROTATE_RIGHT]=function(t,e){var i=t.getViewer().camera,n=e.angle||.01;i.rotateRight(n)},W[ct.CAMERA_ROTATE_LEFT]=function(t,e){var i=t.getViewer().camera,n=e.angle||.01;i.rotateLeft(n)},W[ct.CAMERA_ROTATE_UP]=function(t,e){var i=t.getViewer().camera,n=e.angle||.01;i.rotateUp(n)},W[ct.CAMERA_ROTATE_DOWN]=function(t,e){var i=t.getViewer().camera,n=e.angle||.01;i.rotateDown(n)},W[ct.CAMERA_ZOOM_IN]=function(t,e){var i=t.getViewer().camera,n=e.amount;i.zoomIn(n)},W[ct.CAMERA_ZOOM_OUT]=function(t,e){var i=t.getViewer().camera,n=e.amount;i.zoomOut(n)},W),ut={IGNORED:0,NOT_PRESSED:1,PRESSED:2};ut[ut.IGNORED]="IGNORED",ut[ut.NOT_PRESSED]="NOT_PRESSED",ut[ut.PRESSED]="PRESSED";var dt=function(){function t(t,e,i){this.ngZone=t,this.cesiumService=e,this.document=i,this._currentDefinitions=null,this._activeDefinitions={},this._keyMappingFn=this.defaultKeyMappingFn}return t.prototype.init=function(){var t=this.cesiumService.getCanvas();t.addEventListener("click",function(){t.focus()}),this.handleKeydown=this.handleKeydown.bind(this),this.handleKeyup=this.handleKeyup.bind(this),this.handleTick=this.handleTick.bind(this)},t.prototype.setKeyboardControls=function(t,e,i){var n=this;if(void 0===i&&(i=!1),!t)return this.removeKeyboardControls();this._currentDefinitions||this.registerEvents(i),this._currentDefinitions=t,this._keyMappingFn=e||this.defaultKeyMappingFn,Object.keys(this._currentDefinitions).forEach(function(t){n._activeDefinitions[t]={state:ut.NOT_PRESSED,action:null,keyboardEvent:null}})},t.prototype.removeKeyboardControls=function(){this.unregisterEvents(),this._currentDefinitions=null},t.prototype.getAction=function(t){return this._currentDefinitions[t]||null},t.prototype.defaultKeyMappingFn=function(t){return String.fromCharCode(t.keyCode)},t.prototype.handleKeydown=function(t){var e=this._keyMappingFn(t),i=this.getAction(e);if(i&&this._activeDefinitions[e].state!==ut.IGNORED){var n=!0,o=this.getParams(i.params,t);i.validation&&(n=i.validation(this.cesiumService,o,t)),!0===n&&(this._activeDefinitions[e]={state:ut.PRESSED,action:i,keyboardEvent:t})}},t.prototype.handleKeyup=function(t){var e=this._keyMappingFn(t),i=this.getAction(e);i&&(this._activeDefinitions[e]={state:ut.NOT_PRESSED,action:null,keyboardEvent:t},i.done&&"function"==typeof i.done&&i.done(this.cesiumService,t))},t.prototype.handleTick=function(){var i=this;Object.keys(this._activeDefinitions).forEach(function(t){var e=i._activeDefinitions[t];null!==e&&null!==e.action&&e.state===ut.PRESSED&&i.executeAction(e.action,t,e.keyboardEvent)})},t.prototype.getParams=function(t,e){return t?"function"==typeof t?t(this.cesiumService,e):t:{}},t.prototype.executeAction=function(t,e,i){if(this._currentDefinitions){var n=this.getParams(t.params,i);if(r.isNumber(t.action)){var o=lt[t.action];o&&o(this.cesiumService,n,i)}else if("function"==typeof t.action){!1===t.action(this.cesiumService,n,i)&&(this._activeDefinitions[e]={state:ut.IGNORED,action:null,keyboardEvent:null})}}},t.prototype.registerEvents=function(t){var e=this,i=function(){e.document.addEventListener("keydown",e.handleKeydown),e.document.addEventListener("keyup",e.handleKeyup),e.cesiumService.getViewer().clock.onTick.addEventListener(e.handleTick)};t?this.ngZone.runOutsideAngular(i):i()},t.prototype.unregisterEvents=function(){this.document.removeEventListener("keydown",this.handleKeydown),this.document.removeEventListener("keyup",this.handleKeyup),this.cesiumService.getViewer().clock.onTick.removeEventListener(this.handleTick)},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:a.NgZone},{type:B},{type:undefined,decorators:[{type:a.Inject,args:[s.DOCUMENT]}]}]},t}(),ht=function(){function t(t,e){this.event=t,this.modifier=e}return t.prototype.init=function(t){var i=this;return this.observer=w.Observable.create(function(e){t.setInputAction(function(t){t.position&&(t.startPosition=t.position,t.endPosition=t.position),e.next(t)},i.event,i.modifier)}),this.observer},t}(),yt=function(o){function r(t,e,i){var n=o.call(this,t,e)||this;return n.event=t,n.modifier=e,n.eventFactory=i,n}return b(r,o),r.prototype.init=function(){var t,e;this.event===G.LONG_LEFT_PRESS?(t=G.LEFT_DOWN,e=G.LEFT_UP):this.event===G.LONG_RIGHT_PRESS?(t=G.RIGHT_DOWN,e=G.RIGHT_UP):this.event===G.LONG_MIDDLE_PRESS&&(t=G.MIDDLE_DOWN,e=G.MIDDLE_UP);var i=this.eventFactory.get(t,this.modifier),n=this.eventFactory.get(e,this.modifier);return m.publish()(i.pipe(m.mergeMap(function(t){return w.of(t).pipe(m.delay(r.LONG_PRESS_EVENTS_DURATION),m.takeUntil(n))})))},r.LONG_PRESS_EVENTS_DURATION=250,r}(ht),ft=function(){function o(t){this.cesiumService=t,this.cesiumEventsObservables=new Map}return o.getEventFullName=function(t,e){return e?t+"_"+e:t.toString()},o.prototype.init=function(){this.eventsHandler=this.cesiumService.getViewer().screenSpaceEventHandler},o.prototype.get=function(t,e){var i=o.getEventFullName(t,e);if(this.cesiumEventsObservables.has(i))return this.cesiumEventsObservables.get(i);var n=this.createCesiumEventObservable(t,e);return this.cesiumEventsObservables.set(i,n),n},o.prototype.createCesiumEventObservable=function(t,e){var i;return(i=o.longPressEvents.has(t)?this.createSpecialCesiumEventObservable(t,e):m.publish()(new ht(t,e).init(this.eventsHandler))).connect(),i},o.prototype.createSpecialCesiumEventObservable=function(t,e){return new yt(t,e,this).init()},o.longPressEvents=new Set([G.LONG_LEFT_PRESS,G.LONG_RIGHT_PRESS,G.LONG_MIDDLE_PRESS]),o.decorators=[{type:a.Injectable}],o.ctorParameters=function(){return[{type:B}]},o}(),mt=function(){function t(){this._entitesToPlonter=[],this._plonterChangeNotifier=new a.EventEmitter,this._plonterObserver=new w.Subject}return Object.defineProperty(t.prototype,"plonterChangeNotifier",{get:function(){return this._plonterChangeNotifier},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"plonterShown",{get:function(){return this._plonterShown},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"entitesToPlonter",{get:function(){return this._entitesToPlonter},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"plonterClickPosition",{get:function(){return this._eventResult.movement},enumerable:!0,configurable:!0}),t.prototype.plonterIt=function(t){return this._eventResult=t,this._entitesToPlonter=t.entities,this._plonterShown=!0,this._plonterChangeNotifier.emit(),this._plonterObserver},t.prototype.resolvePlonter=function(t){this._plonterShown=!1,this._eventResult.entities=[t],this._plonterChangeNotifier.emit(),this._plonterObserver.next(this._eventResult)},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[]},t}(),gt=function(t){return t.reduce(function(t,e){return t.indexOf(e)<0&&t.push(e),t},[])},vt=function(){function t(){}return t.getDragEventTypes=function(t){var e,i;return t===G.LEFT_CLICK_DRAG?(e=G.LEFT_DOWN,i=G.LEFT_UP):t===G.RIGHT_CLICK_DRAG?(e=G.RIGHT_DOWN,i=G.RIGHT_UP):t===G.MIDDLE_CLICK_DRAG&&(e=G.MIDDLE_DOWN,i=G.MIDDLE_UP),{mouseDownEvent:e,mouseUpEvent:i}},t.dragEvents=new Set([G.LEFT_CLICK_DRAG,G.RIGHT_CLICK_DRAG,G.MIDDLE_CLICK_DRAG]),t}(),Pt=function on(t,e,i,n){this.observable=t,this.stopper=e,this.priority=i,this.isPaused=n},bt=function(){function t(t,e,i){this.cesiumService=t,this.eventBuilder=e,this.plonterService=i,this.eventRegistrations=new Map}return t.prototype.init=function(){this.eventBuilder.init(),this.scene=this.cesiumService.getScene()},t.prototype.register=function(t){var e=this;if(this.scene===undefined)throw new Error("CesiumService has not been initialized yet - MapEventsManagerService must be injected  under ac-map");if(t.pick=t.pick||U.NO_PICK,t.priority=t.priority||0,t.entityType&&t.pick===U.NO_PICK)throw new Error("MapEventsManagerService: can't register an event with entityType and PickOptions.NO_PICK - It doesn't make sense ");var i=ft.getEventFullName(t.event,t.modifier);this.eventRegistrations.has(i)||this.eventRegistrations.set(i,[]);var n=this.createEventRegistration(t.event,t.modifier,t.entityType,t.pick,t.priority,t.pickFilter),o=n.observable;return o.dispose=function(){return e.disposeObservable(n,i)},this.eventRegistrations.get(i).push(n),this.sortRegistrationsByPriority(i),o},t.prototype.disposeObservable=function(t,e){t.stopper.next(1);var i=this.eventRegistrations.get(e),n=i.indexOf(t);-1!==n&&i.splice(n,1),this.sortRegistrationsByPriority(e)},t.prototype.sortRegistrationsByPriority=function(t){var e=this.eventRegistrations.get(t);if(e.sort(function(t,e){return e.priority-t.priority}),0!==e.length){var i=e[0].priority;e.forEach(function(t){t.isPaused=t.priority<i})}},t.prototype.createEventRegistration=function(t,e,i,n,o,r){var s,a=this,p=this.eventBuilder.get(t,e),c=new w.Subject,l=new Pt(undefined,c,o,!1);return s=vt.dragEvents.has(t)?this.createDragEvent(t,e,i,n,o,r).pipe(m.takeUntil(c)):p.pipe(m.filter(function(){return!l.isPaused}),m.map(function(t){return a.triggerPick(t,n)}),m.filter(function(t){return null!==t.cesiumEntities||i===undefined}),m.map(function(t){return a.addEntities(t,i,n,r)}),m.filter(function(t){return null!==t.entities||i===undefined&&!r}),m.switchMap(function(t){return a.plonter(t,n)}),m.takeUntil(c)),l.observable=s,l},t.prototype.createDragEvent=function(t,e,i,n,o,r){var s=vt.getDragEventTypes(t),a=s.mouseDownEvent,p=s.mouseUpEvent,c=this.eventBuilder.get(p),l=this.eventBuilder.get(G.MOUSE_MOVE),u=this.createEventRegistration(a,e,i,n,o,r),d=new w.Subject,h=u.observable.pipe(m.mergeMap(function(e){var i=null,n=e.movement.startPosition.x,o=e.movement.startPosition.y;return l.pipe(m.map(function(t){return i={movement:{drop:!1,startPosition:{x:n,y:o},endPosition:t.endPosition},entities:e.entities,cesiumEntities:e.cesiumEntities}}),m.takeUntil(c),m.tap(undefined,undefined,function(){if(i){var t=Object.assign({},i);t.movement.drop=!0,d.next(t)}}))}));return w.merge(h,d)},t.prototype.triggerPick=function(t,e){var i=[];switch(e){case U.PICK_ONE:case U.PICK_ALL:i=0===(i=this.scene.drillPick(t.endPosition)).length?null:i;break;case U.PICK_FIRST:var n=this.scene.pick(t.endPosition);i=n===undefined?null:[n];break;case U.NO_PICK:}return i&&(i=i.map(function(t){return t.id&&t.id instanceof Cesium.Entity?t.id:t.primitive})),{movement:t,cesiumEntities:i}},t.prototype.addEntities=function(t,e,i,n){if(null===t.cesiumEntities)return t.entities=null,t;var o=[];return i!==U.NO_PICK&&(o=e?t.cesiumEntities.map(function(t){return t.acEntity}).filter(function(t){return t&&t instanceof e}):t.cesiumEntities.map(function(t){return t.acEntity}),o=gt(o),0===(o=n&&o?o.filter(n):o).length&&(o=null)),t.entities=o,t},t.prototype.plonter=function(t,e){return e===U.PICK_ONE&&null!==t.entities&&1<t.entities.length?this.plonterService.plonterIt(t):w.of(t)},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B},{type:ft},{type:mt}]},t}(),Et=function(){function t(t){this.cesiumService=t,this.layersDataSources=[]}return t.prototype.registerLayerDataSources=function(t,e){var i=this;t.forEach(function(t){t.zIndex=e,i.layersDataSources.push(t)})},t.prototype.drawAllLayers=function(){var e=this;this.layersDataSources.sort(function(t,e){return t.zIndex-e.zIndex}),this.layersDataSources.forEach(function(t){e.cesiumService.getViewer().dataSources.add(t)})},t.prototype.updateAndRefresh=function(t,i){var n=this;t&&t.length&&(t.forEach(function(t){var e=n.layersDataSources.indexOf(t);-1!==e&&(n.layersDataSources[e].zIndex=i)}),this.cesiumService.getViewer().dataSources.removeAll(),this.drawAllLayers())},t.prototype.removeDataSources=function(t){var i=this;t.forEach(function(t){var e=i.layersDataSources.indexOf(t);-1!==e&&(i.layersDataSources.splice(e,1),i.cesiumService.getViewer().dataSources.remove(t,!0))})},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(),Ct=function(){function t(){this.defaultIdCounter=0,this._Maps=new Map,this.eventRemoveCallbacks=[]}return t.prototype.getMap=function(t){return t?this._Maps.get(t):this.firstMap},t.prototype._registerMap=function(t,e){this.firstMap||(this.firstMap=e);var i=t||this.generateDefaultId();if(this._Maps.has(i))throw new Error("Map with id: "+i+" already exist");return this._Maps.set(i,e),i},t.prototype._removeMapById=function(t){return this._Maps["delete"](t)},t.prototype.generateDefaultId=function(){return this.defaultIdCounter++,"default-map-id-"+this.defaultIdCounter},t.prototype.sync2DMapsCameras=function(t){var o=this;this.unsyncMapsCameras();var r=t.map(function(t){var e=o.getMap(t.id);if(!e)throw new Error("Couldn't find map with id: "+t.id);return{map:e,options:{sensitivity:t.sensitivity,bindZoom:t.bindZoom}}});r.forEach(function(t){var s=t.map,e=t.options,i=s.getCameraService().getCamera(),a=i.positionCartographic;i.percentageChanged=e.sensitivity||.01;var n=i.changed.addEventListener(function(){r.forEach(function(t){var e=t.map,i=t.options;if(e!==s){var n=e.getCameraService().getCamera(),o=n.positionCartographic,r=Cesium.Ellipsoid.WGS84.cartographicToCartesian({longitude:a.longitude,latitude:a.latitude,height:i.bindZoom?a.height:o.height});e.getCesiumViewer().scene.mode!==Cesium.SceneMode.MORPHING&&n.setView({destination:r,orientation:{heading:n.heading,pitch:n.pitch}})}})});o.eventRemoveCallbacks.push(n)})},t.prototype.unsyncMapsCameras=function(){this.eventRemoveCallbacks.forEach(function(t){return t()}),this.eventRemoveCallbacks=[]},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[]},t}(),_t=function(){function t(t){this.cesiumService=t}return t.prototype.getMapScreenshotDataUrlBase64=function(){return this.cesiumService.getCanvas().toDataURL()},t.prototype.downloadMapScreenshot=function(t){void 0===t&&(t="map.png");var e=this.getMapScreenshotDataUrlBase64();this.downloadURI(e,t)},t.prototype.downloadURI=function(t,e){var i=document.createElement("a");i.download=e,i.href=t,document.body.appendChild(i),i.click(),document.body.removeChild(i)},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(),St=function(){function t(t,e,i,n,o,r,s,a,p,c,l,u,d,h,y,f,m,g,v,P){this._cesiumService=t,this._cameraService=e,this._elemRef=i,this.document=n,this.mapsManagerService=o,this.billboardDrawerService=r,this.labelDrawerService=s,this.ellipseDrawerService=a,this.polylineDrawerService=p,this.polygonDrawerService=c,this.arcDrawerService=l,this.pointDrawerService=u,this.czmlDrawerService=d,this.mapEventsManager=h,this.keyboardControlService=y,this.mapLayersService=f,this.configurationService=m,this.screenshotService=g,this.contextMenuService=v,this.coordinateConverter=P,this.disableDefaultPlonter=!1,this.mapContainer=this.document.createElement("div"),this.mapContainer.style.width="100%",this.mapContainer.style.height="100%",this.mapContainer.className="map-container",this._cesiumService.init(this.mapContainer,this),this._cameraService.init(this._cesiumService),this.mapEventsManager.init(),this.billboardDrawerService.init(),this.labelDrawerService.init(),this.ellipseDrawerService.init(),this.polylineDrawerService.init(),this.polygonDrawerService.init(),this.arcDrawerService.init(),this.pointDrawerService.init(),this.czmlDrawerService.init(),this.keyboardControlService.init(),this.contextMenuService.init(this.mapEventsManager)}return t.prototype.ngOnInit=function(){this.mapId=this.mapsManagerService._registerMap(this.mapId,this),this.containerId||this._elemRef.nativeElement.appendChild(this.mapContainer)},t.prototype.ngOnChanges=function(t){if(t.sceneMode&&this._cameraService.setSceneMode(t.sceneMode.currentValue),t.flyTo&&this._cameraService.cameraFlyTo(t.flyTo.currentValue),t.containerId&&!t.containerId.firstChange){var e=this.document.getElementById(t.containerId.currentValue);if(!e)throw new Error("No element found with id: "+t.containerId.currentValue);e.appendChild(this.mapContainer)}},t.prototype.ngAfterViewInit=function(){var e=this;this.mapLayersService.drawAllLayers(),this.containerId&&setTimeout(function(){var t=e.document.getElementById(e.containerId);if(!t)throw new Error("No element found with id: "+e.containerId);t.appendChild(e.mapContainer)},0)},t.prototype.ngOnDestroy=function(){this.mapContainer.remove(),this.mapsManagerService._removeMapById(this.mapId)},t.prototype.getCesiumService=function(){return this._cesiumService},t.prototype.getCesiumViewer=function(){return this._cesiumService.getViewer()},t.prototype.getCameraService=function(){return this._cameraService},t.prototype.getId=function(){return this.mapId},t.prototype.getMapContainer=function(){return this.mapContainer},t.prototype.getMapEventsManager=function(){return this.mapEventsManager},t.prototype.getContextMenuService=function(){return this.contextMenuService},t.prototype.getScreenshotService=function(){return this.screenshotService},t.prototype.getKeyboardControlService=function(){return this.keyboardControlService},t.prototype.getCoordinateConverter=function(){return this.coordinateConverter},t.decorators=[{type:a.Component,args:[{selector:"ac-map",template:'\n    <ac-default-plonter *ngIf="!disableDefaultPlonter"></ac-default-plonter>\n    <ac-context-menu-wrapper></ac-context-menu-wrapper>\n    <ng-content></ng-content>\n  ',providers:[B,et,ft,dt,bt,mt,ot,at,pt,nt,rt,X,it,st,Et,v,_t,z,$]}]}],t.ctorParameters=function(){return[{type:B},{type:v},{type:a.ElementRef},{type:undefined,decorators:[{type:a.Inject,args:[s.DOCUMENT]}]},{type:Ct},{type:et},{type:ot},{type:nt},{type:at},{type:st},{type:X},{type:rt},{type:it},{type:bt},{type:dt},{type:Et},{type:f},{type:_t},{type:z},{type:$}]},t.propDecorators={disableDefaultPlonter:[{type:a.Input}],mapId:[{type:a.Input}],flyTo:[{type:a.Input}],sceneMode:[{type:a.Input}],containerId:[{type:a.Input}]},t}(),Mt=function(){function t(){this._cache=!0,this.descriptions=[],this.layerUpdate=new a.EventEmitter}return Object.defineProperty(t.prototype,"cache",{get:function(){return this._cache},set:function(t){this._cache=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"zIndex",{get:function(){return this._zIndex},set:function(t){t!==this._zIndex&&this.layerUpdate.emit(),this._zIndex=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"show",{get:function(){return this._show},set:function(t){t!==this._show&&this.layerUpdate.emit(),this._show=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this._options},set:function(t){this._options=t,this.layerUpdate.emit()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t,this.layerUpdate.emit()},enumerable:!0,configurable:!0}),t.prototype.setEntityName=function(t){this._entityName=t},t.prototype.getEntityName=function(){return this._entityName},t.prototype.registerDescription=function(t){this.descriptions.indexOf(t)<0&&this.descriptions.push(t)},t.prototype.unregisterDescription=function(t){var e=this.descriptions.indexOf(t);-1<e&&this.descriptions.splice(e,1)},t.prototype.getDescriptions=function(){return this.descriptions},t.prototype.layerUpdates=function(){return this.layerUpdate},t.decorators=[{type:a.Injectable}],t}(),It={ADD_UPDATE:0,DELETE:1};It[It.ADD_UPDATE]="ADD_UPDATE",It[It.DELETE]="DELETE";var At=function(){function t(){this._cache=new Map}return t.prototype.get=function(t,e){if(this._cache.has(t))return this._cache.get(t);var i=e();return this._cache.set(t,i),i},t.prototype.clear=function(){this._cache.clear()},t.decorators=[{type:a.Injectable}],t}(),Dt=function(){function i(){}return i.throwIfAnyNotPresent=function(e,t){t.forEach(function(t){return i.throwIfNotPresent(e,t)})},i.throwIfNotPresent=function(t,e){if(!i.present(t[e]))throw new Error("Error: "+e+" was not given.")},i.present=function(t){return t!==undefined&&null!==t},i}(),Lt=function(e){function t(t){return e.call(this,Cesium.PrimitiveCollection,t)||this}return b(t,e),t.prototype.add=function(t){return Dt.throwIfAnyNotPresent(t,["center","semiMajorAxis","semiMinorAxis"]),e.prototype.add.call(this,new i.EllipsePrimitive(t))},t.prototype.update=function(t,e){return t.updateLocationData(e),t},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Y),wt=function(e){function t(t){return e.call(this,Cesium.PolylineCollection,t)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Y),Tt=function(o){function t(t,e){var i=o.call(this,Cesium.PrimitiveCollection,e)||this;return i.geometryType=t,i}return b(t,o),t.prototype.add=function(t,e,i){e.geometry=new this.geometryType(t),i.geometryInstances=new Cesium.GeometryInstance(e),i.asynchronous=!1;var n=new Cesium.Primitive(i);return o.prototype.add.call(this,n)},t.prototype.update=function(t,e,i,n){return i.geometry=new this.geometryType(e),n.geometryInstances=new Cesium.GeometryInstance(i),this._cesiumCollection.remove(t),o.prototype.add.call(this,new Cesium.Primitive(n))},t}(Y),Ot=function(e){function t(t){return e.call(this,Cesium.CircleGeometry,t)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Tt),Rt=function(e){function t(t){return e.call(this,Cesium.PolylineGeometry,t)||this}return b(t,e),t.prototype.update=function(t,e,i,n){var o=i.attributes.color.value;return t.ready?t.getGeometryInstanceAttributes().color=o:Cesium.when(t.readyPromise).then(function(t){t.getGeometryInstanceAttributes().color.value=o}),t},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Tt),xt=function(e){function t(t){return e.call(this,Cesium.PolygonGeometry,t)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Tt),jt=function(e){function t(t){return e.call(this,Cesium.EllipseGeometry,t)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Tt),Nt=function(e){function t(t){return e.call(this,t,J.model)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),Ft=function(e){function t(t){return e.call(this,t,J.box)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),kt=function(e){function t(t){return e.call(this,t,J.corridor)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),Vt=function(e){function t(t){return e.call(this,t,J.cylinder)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),Ht=function(e){function t(t){return e.call(this,t,J.ellipsoid)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),Bt=function(e){function t(t){return e.call(this,t,J.polylineVolume)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),Gt=function(e){function t(t){return e.call(this,t,J.wall)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),Ut=function(e){function t(t){return e.call(this,t,J.rectangle)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(tt),zt=function(e){function t(t){return e.call(this,Cesium.LabelCollection,t)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Y),Kt=function(e){function t(t){return e.call(this,Cesium.BillboardCollection,t)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Y),Wt=function(e){function t(t){return e.call(this,Cesium.PointPrimitiveCollection,t)||this}return b(t,e),t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Y),$t=function(i){function t(t){var e=i.call(this,Cesium.HtmlCollection,t)||this;return e._cesiumService=t,e}return b(t,i),t.prototype.add=function(t){return t.scene=this._cesiumService.getScene(),t.mapContainer=this._cesiumService.getMap().getMapContainer(),i.prototype.add.call(this,t)},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:B}]},t}(Y),Zt=function(){function t(t,e,i,n,o,r,s,a,p,c,l,u,d,h,y,f,m,g,v,P,b,E,C,_,S,M,I,A,D,L){this.layerService=t,this._computationCache=e,this.mapLayersService=i,this.show=!0,this.store=!1,this.zIndex=0,this.acForRgx=/^let\s+.+\s+of\s+.+$/,this.stopObservable=new w.Subject,this._updateStream=new w.Subject,this.entitiesStore=new Map,this.layerDrawerDataSources=[],this._drawerList=new Map([["billboard",n],["label",o],["ellipse",r],["polyline",s],["polygon",a],["arc",p],["point",c],["model",l],["box",u],["corridor",d],["cylinder",h],["ellipsoid",y],["polylineVolume",f],["rectangle",g],["wall",m],["polylinePrimitive",S],["labelPrimitive",M],["billboardPrimitive",I],["pointPrimitive",A],["html",D],["czml",L],["dynamicEllipse",v],["dynamicPolyline",P],["staticCircle",b],["staticPolyline",E],["staticPolygon",C],["staticEllipse",_]])}return t.prototype.init=function(){var n=this;this.initValidParams(),w.merge(this._updateStream,this.observable).pipe(m.takeUntil(this.stopObservable)).subscribe(function(e){n._computationCache.clear();var i=e.entity;n.store&&(i=n.updateStore(e)),n.context[n.entityName]=i,n.layerService.getDescriptions().forEach(function(t){switch(e.actionType){case It.ADD_UPDATE:t.draw(n.context,e.id,i);break;case It.DELETE:t.remove(e.id);break;default:console.error("[ac-layer] unknown AcNotification.actionType for notification: "+e)}})})},t.prototype.updateStore=function(t){if(t.actionType===It.DELETE)return this.entitiesStore["delete"](t.id),undefined;if(this.entitiesStore.has(t.id)){var e=this.entitiesStore.get(t.id);return Object.assign(e,t.entity),e}return this.entitiesStore.set(t.id,t.entity),t.entity},t.prototype.initValidParams=function(){if(!this.context)throw new Error("ac-layer: must initialize [context] ");if(!this.acForRgx.test(this.acFor))throw new Error('ac-layer: Invalid [acFor] syntax. Expected: [acFor]="let item of observable" .Instead received: '+this.acFor);var t=this.acFor.split(" ");if(this.observable=this.context[t[3]],this.entityName=t[1],!this.isObservable(this.observable))throw new Error("ac-layer: must initailize [acFor] with rx observable, instead received: "+this.observable);this.layerService.context=this.context,this.layerService.setEntityName(this.entityName)},t.prototype.isObservable=function(t){return t&&"function"==typeof t.subscribe},t.prototype.ngAfterContentInit=function(){this.init()},t.prototype.ngOnInit=function(){var r=this;this.layerService.context=this.context,this.layerService.options=this.options,this.layerService.show=this.show,this.layerService.zIndex=this.zIndex,this._drawerList.forEach(function(t,e){var i,n=r.options?r.options[e]:undefined,o=t.init(n);o&&(i=r.layerDrawerDataSources).push.apply(i,_(o)),t.setShow(r.show)})},t.prototype.ngOnChanges=function(t){if(t.show&&!t.show.firstChange){var e=t.show.currentValue;this.layerService.show=e,this._drawerList.forEach(function(t){return t.setShow(e)})}if(t.zIndex&&!t.zIndex.firstChange){var i=t.zIndex.currentValue;this.layerService.zIndex=i,this.mapLayersService.updateAndRefresh(this.layerDrawerDataSources,i)}},t.prototype.ngOnDestroy=function(){this.mapLayersService.removeDataSources(this.layerDrawerDataSources),this.stopObservable.next(!0),this.removeAll()},t.prototype.getLayerService=function(){return this.layerService},t.prototype.getLayerDrawerDataSources=function(){return this.layerDrawerDataSources},t.prototype.getDrawerDataSourcesByName=function(e){return this.layerDrawerDataSources.filter(function(t){return t.name===e})},t.prototype.getStore=function(){return this.entitiesStore},t.prototype.removeAll=function(){this.layerService.getDescriptions().forEach(function(t){return t.removeAll()}),this.entitiesStore.clear()},t.prototype.remove=function(t){this._updateStream.next({id:t,actionType:It.DELETE}),this.entitiesStore["delete"](t)},t.prototype.updateNotification=function(t){this._updateStream.next(t)},t.prototype.update=function(t,e){this._updateStream.next({entity:t,id:e,actionType:It.ADD_UPDATE})},t.prototype.refreshAll=function(t){var e=this;w.from(t).subscribe(function(t){return e._updateStream.next(t)})},t.decorators=[{type:a.Component,args:[{selector:"ac-layer",template:"<ng-content></ng-content>",providers:[Mt,At,et,ot,nt,at,X,rt,st,Nt,Ft,kt,Vt,Ht,Bt,Gt,Ut,pt,zt,Kt,Wt,$t,it,Lt,wt,Ot,Rt,xt,jt],changeDetection:a.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:Mt},{type:At},{type:Et},{type:et},{type:ot},{type:nt},{type:at},{type:st},{type:X},{type:rt},{type:Nt},{type:Ft},{type:kt},{type:Vt},{type:Ht},{type:Bt},{type:Gt},{type:Ut},{type:Lt},{type:wt},{type:Ot},{type:Rt},{type:xt},{type:jt},{type:pt},{type:zt},{type:Kt},{type:Wt},{type:$t},{type:it}]},t.propDecorators={show:[{type:a.Input}],acFor:[{type:a.Input}],context:[{type:a.Input}],store:[{type:a.Input}],options:[{type:a.Input}],zIndex:[{type:a.Input}]},t}(),Yt=function(){function t(t,e){this._drawer=t,this.mapLayers=e}return t.prototype.ngOnInit=function(){this.selfPrimitiveIsDraw=!1;var t=this._drawer.init();t&&(this.dataSources=t),this.drawOnMap()},t.prototype.ngOnChanges=function(t){var e=t.props;e.currentValue!==e.previousValue&&this.updateOnMap()},t.prototype.drawOnMap=function(){return this.selfPrimitiveIsDraw=!0,this.selfPrimitive=this._drawer.add(this.props)},t.prototype.removeFromMap=function(){return this.selfPrimitiveIsDraw=!1,this._drawer.remove(this.selfPrimitive)},t.prototype.updateOnMap=function(){if(this.selfPrimitiveIsDraw)return this._drawer.update(this.selfPrimitive,this.props)},t.prototype.ngOnDestroy=function(){this.mapLayers.removeDataSources(this.dataSources),this.removeFromMap()},t.propDecorators={props:[{type:a.Input}]},t}(),qt=function(i){function t(t,e){return i.call(this,t,e)||this}return b(t,i),t.decorators=[{type:a.Component,args:[{selector:"ac-billboard",template:""}]}],t.ctorParameters=function(){return[{type:et},{type:Et}]},t}(Yt),Xt=function(){function t(t,e,i,n){this._drawer=t,this._layerService=e,this._computationCache=i,this._cesiumProperties=n,this.onDraw=new a.EventEmitter,this.onRemove=new a.EventEmitter,this._cesiumObjectsMap=new Map}return t.prototype._propsEvaluator=function(t){return this._propsEvaluateFn(this._computationCache,t)},t.prototype._getPropsAssigner=function(){var i=this;return function(t,e){return i._propsAssignerFn(t,e)}},t.prototype.getLayerService=function(){return this._layerService},t.prototype.setLayerService=function(t){this._layerService.unregisterDescription(this),this._layerService=t,this._layerService.registerDescription(this),this._propsEvaluateFn=this._cesiumProperties.createEvaluator(this.props,this._layerService.cache,!0),this._propsAssignerFn=this._cesiumProperties.createAssigner(this.props)},t.prototype.ngOnInit=function(){this.props||console.error("ac-desc components error: [props] input is mandatory"),this._layerService.registerDescription(this),this._propsEvaluateFn=this._cesiumProperties.createEvaluator(this.props,this._layerService.cache),this._propsAssignerFn=this._cesiumProperties.createAssigner(this.props)},t.prototype.getCesiumObjectsMap=function(){return this._cesiumObjectsMap},t.prototype.draw=function(t,e,i){var n=this._propsEvaluator(t);if(this._cesiumObjectsMap.has(e)){o=this._cesiumObjectsMap.get(e);this.onDraw.emit({acEntity:i,cesiumEntity:o,entityId:e}),o.acEntity=i,this._drawer.setPropsAssigner(this._getPropsAssigner()),this._drawer.update(o,n)}else{var o=this._drawer.add(n);this.onDraw.emit({acEntity:i,cesiumEntity:o,entityId:e}),o.acEntity=i,this._cesiumObjectsMap.set(e,o)}},t.prototype.remove=function(t){var e=this._cesiumObjectsMap.get(t);e&&(this.onRemove.emit({acEntity:e.acEntity,cesiumEntity:e,entityId:t}),this._drawer.remove(e),this._cesiumObjectsMap["delete"](t))},t.prototype.removeAll=function(){this._cesiumObjectsMap.clear(),this._drawer.removeAll()},t.prototype.ngOnDestroy=function(){this._layerService.unregisterDescription(this),this.removeAll()},t.propDecorators={props:[{type:a.Input}],onDraw:[{type:a.Output}],onRemove:[{type:a.Output}]},t}(),Jt=function(){function t(){this._mapper=new e.JsonStringMapper}return t.prototype.map=function(t){return this._mapper.map(t)},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[]},t}(),Qt=function(){function t(){}return t.create=function(t,e){void 0===t&&(t=[]),void 0===e&&(e=!0);var i="";t.forEach(function(t){i+=e?"if(!(obj1['"+t+"'] instanceof Cesium.CallbackProperty))obj1['"+t+"'] = obj2['"+t+"']; ":"if (!(obj1['"+t+"'] instanceof Cesium.CallbackProperty) && obj2['"+t+"'] !== undefined) { obj1['"+t+"'] = obj2['"+t+"']; } "}),i+="return obj1";var n=new Function("obj1","obj2",i);return function(t,e){return n(t,e)}},t}(),te=function(){function t(t,e){this._parser=t,this._jsonMapper=e,this._assignersCache=new Map,this._evaluatorsCache=new Map}return t.prototype._compile=function(t,i){var n=this;void 0===i&&(i=!0);var o={},r=new Map;this._jsonMapper.map(t).forEach(function(t,e){return r.set(e,{expression:t,get:n._parser.eval(t)})}),r.forEach(function(t,e){o[e||"undefined"]=i?"cache.get(`"+t.expression+"`, () => propsMap.get('"+e+"').get(context))":"propsMap.get('"+e+"').get(context)"});var e="return "+JSON.stringify(o).replace(/"/g,"")+";",s=new Function("propsMap","cache","context",e);return function(t,e){return s(r,t,e)}},t.prototype._build=function(t){var e=Array.from(this._jsonMapper.map(t).keys()),i=Qt.create(e);return function(t,e){return i(t,e)}},t.prototype.createEvaluator=function(t,e,i){if(void 0===e&&(e=!0),void 0===i&&(i=!1),!i&&this._evaluatorsCache.has(t))return this._evaluatorsCache.get(t);var n=this._compile(t,e);return this._evaluatorsCache.set(t,n),n},t.prototype.createAssigner=function(t){if(this._assignersCache.has(t))return this._assignersCache.get(t);var e=this._build(t);return this._assignersCache.set(t,e),e},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:n.Parse},{type:Jt}]},t}(),ee=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-billboard-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:et},{type:Mt},{type:At},{type:te}]},t}(Xt),ie=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-ellipse-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:nt},{type:Mt},{type:At},{type:te}]},t}(Xt),ne=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-polyline-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:at},{type:Mt},{type:At},{type:te}]},t}(Xt),oe=function(){function t(){}return t.prototype.transform=function(t,e){return new Cesium.Cartesian2(t[0],t[1])},t.decorators=[{type:a.Pipe,args:[{name:"pixelOffset"}]}],t}(),re=function(){function t(){}return t.prototype.transform=function(t,e){return(360-Math.round(180*t/Math.PI))%360},t.decorators=[{type:a.Pipe,args:[{name:"radiansToDegrees"}]}],t}(),se=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-label-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:ot},{type:Mt},{type:At},{type:te}]},t}(Xt),ae=function(){function t(){}return t.decorators=[{type:a.NgModule,args:[{imports:[s.CommonModule],providers:[]}]}],t}(),pe=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.prototype._propsEvaluator=function(t){var e=o.prototype._propsEvaluator.call(this,t);return e.semiMajorAxis=e.radius,e.semiMinorAxis=e.radius,delete e.radius,e},t.prototype._getPropsAssigner=function(){return function(t,e){return Object.assign(t,e)}},t.decorators=[{type:a.Component,args:[{selector:"ac-circle-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:nt},{type:Mt},{type:At},{type:te}]},t}(Xt),ce=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-arc-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:X},{type:Mt},{type:At},{type:te}]},t}(Xt),le=function(){function e(t){Object.assign(this,t)}return e.create=function(t){return t?Object.assign(new e,t):new e},e}(),ue=function rn(){},de={ArcGisMapServer:Cesium.ArcGisMapServerImageryProvider,WebMapTileService:Cesium.WebMapTileServiceImageryProvider,MapTileService:Cesium.createTileMapServiceImageryProvider,WebMapService:Cesium.WebMapServiceImageryProvider,SingleTileImagery:Cesium.SingleTileImageryProvider,OpenStreetMap:Cesium.createOpenStreetMapImageryProvider,BingMaps:Cesium.BingMapsImageryProvider,GoogleEarthEnterpriseMaps:Cesium.GoogleEarthEnterpriseMapsProvider,MapBox:Cesium.MapboxImageryProvider,UrlTemplateImagery:Cesium.UrlTemplateImageryProvider,OFFLINE:null},he=function(){function t(t){this.cesiumService=t,this.options={},this.provider=de.OFFLINE,this.show=!0,this.alpha=1,this.brightness=1,this.contrast=1,this.imageryLayersCollection=this.cesiumService.getScene().imageryLayers}return t.prototype.createOfflineMapProvider=function(){return Cesium.createTileMapServiceImageryProvider({url:Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII")})},t.prototype.ngOnInit=function(){if(!Dt.present(this.options.url)&&this.provider!==de.OFFLINE)throw new Error("options must have a url");switch(this.provider){case de.WebMapService:case de.WebMapTileService:case de.ArcGisMapServer:case de.SingleTileImagery:case de.BingMaps:case de.GoogleEarthEnterpriseMaps:case de.MapBox:case de.UrlTemplateImagery:this.layerProvider=new this.provider(this.options);break;case de.MapTileService:case de.OpenStreetMap:this.layerProvider=this.provider(this.options);break;case de.OFFLINE:this.layerProvider=this.createOfflineMapProvider();break;default:console.log("ac-map-layer-provider: [provider] wasn't found. setting OFFLINE provider as default"),this.layerProvider=this.createOfflineMapProvider()}this.show&&(this.imageryLayer=this.imageryLayersCollection.addImageryProvider(this.layerProvider,this.index),this.imageryLayer.alpha=this.alpha,this.imageryLayer.contrast=this.contrast,this.imageryLayer.brightness=this.brightness)},t.prototype.ngOnChanges=function(t){t.show&&!t.show.isFirstChange()&&(t.show.currentValue?this.imageryLayer?this.imageryLayersCollection.add(this.imageryLayer,this.index):(this.imageryLayer=this.imageryLayersCollection.addImageryProvider(this.layerProvider,this.index),this.imageryLayer.alpha=this.alpha,this.imageryLayer.contrast=this.contrast,this.imageryLayer.brightness=this.brightness):this.imageryLayer&&this.imageryLayersCollection.remove(this.imageryLayer,!1));t.alpha&&!t.alpha.isFirstChange()&&this.imageryLayer&&(this.imageryLayer.alpha=this.alpha),t.contrast&&!t.contrast.isFirstChange()&&this.imageryLayer&&(this.imageryLayer.contrast=this.contrast),t.brightness&&!t.brightness.isFirstChange()&&this.imageryLayer&&(this.imageryLayer.brightness=this.brightness)},t.prototype.ngOnDestroy=function(){this.imageryLayer&&this.imageryLayersCollection.remove(this.imageryLayer,!0)},t.decorators=[{type:a.Component,args:[{selector:"ac-map-layer-provider",template:""}]}],t.ctorParameters=function(){return[{type:B}]},t.propDecorators={options:[{type:a.Input}],provider:[{type:a.Input}],index:[{type:a.Input}],show:[{type:a.Input}],alpha:[{type:a.Input}],brightness:[{type:a.Input}],contrast:[{type:a.Input}]},t}(),ye=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-point-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:rt},{type:Mt},{type:At},{type:te}]},t}(Xt),fe=function(i){function t(t,e){return i.call(this,t,e)||this}return b(t,i),t.decorators=[{type:a.Component,args:[{selector:"ac-label",template:""}]}],t.ctorParameters=function(){return[{type:ot},{type:Et}]},t}(Yt),me=function(i){function t(t,e){return i.call(this,t,e)||this}return b(t,i),t.decorators=[{type:a.Component,args:[{selector:"ac-polyline",template:""}]}],t.ctorParameters=function(){return[{type:at},{type:Et}]},t}(Yt),ge=function(i){function t(t,e){return i.call(this,t,e)||this}return b(t,i),t.decorators=[{type:a.Component,args:[{selector:"ac-ellipse",template:""}]}],t.ctorParameters=function(){return[{type:nt},{type:Et}]},t}(Yt),ve=function(i){function t(t,e){return i.call(this,t,e)||this}return b(t,i),t.decorators=[{type:a.Component,args:[{selector:"ac-point",template:""}]}],t.ctorParameters=function(){return[{type:rt},{type:Et}]},t}(Yt),Pe=function(){function t(t,e,i){this.cesiumService=t,this.elementRef=e,this.renderer=i,this.isDraw=!1}return t.prototype.setScreenPosition=function(t){t&&(this.renderer.setStyle(this.elementRef.nativeElement,"top",t.y+"px"),this.renderer.setStyle(this.elementRef.nativeElement,"left",t.x+"px"))},t.prototype.ngOnInit=function(){this.cesiumService.getMap().getMapContainer().appendChild(this.elementRef.nativeElement),!1===this.props.show&&this.hideElement()},t.prototype.remove=function(){this.isDraw&&(this.isDraw=!1,this.cesiumService.getScene().preRender.removeEventListener(this.preRenderEventListener),this.hideElement())},t.prototype.hideElement=function(){this.renderer.setStyle(this.elementRef.nativeElement,"display","none")},t.prototype.add=function(){var e=this;this.isDraw||(this.isDraw=!0,this.preRenderEventListener=function(){var t=Cesium.SceneTransforms.wgs84ToWindowCoordinates(e.cesiumService.getScene(),e.props.position);e.setScreenPosition(t)},this.renderer.setStyle(this.elementRef.nativeElement,"display","block"),this.cesiumService.getScene().preRender.addEventListener(this.preRenderEventListener))},t.prototype.ngDoCheck=function(){this.props.show===undefined||this.props.show?this.add():this.remove()},t.prototype.ngOnDestroy=function(){this.remove()},t.decorators=[{type:a.Component,args:[{selector:"ac-html",template:"<ng-content></ng-content>",styles:[":host {\n                position: absolute;\n                z-index: 100;\n\t\t\t\t}"]}]}],t.ctorParameters=function(){return[{type:B},{type:a.ElementRef},{type:a.Renderer2}]},t.propDecorators={props:[{type:a.Input}]},t}(),be=function(i){function t(t,e){return i.call(this,t,e)||this}return b(t,i),t.prototype.updateEllipseProps=function(){this.props.semiMajorAxis=this.props.radius,this.props.semiMinorAxis=this.props.radius,this.props.rotation=0},t.prototype.drawOnMap=function(){this.updateEllipseProps(),i.prototype.drawOnMap.call(this)},t.prototype.updateOnMap=function(){this.updateEllipseProps(),i.prototype.updateOnMap.call(this)},t.decorators=[{type:a.Component,args:[{selector:"ac-circle",template:""}]}],t.ctorParameters=function(){return[{type:nt},{type:Et}]},t}(Yt),Ee=function(i){function t(t,e){return i.call(this,t,e)||this}return b(t,i),t.prototype.updateOnMap=function(){this.selfPrimitiveIsDraw&&(this.removeFromMap(),this.drawOnMap())},t.prototype.drawOnMap=function(){return this.selfPrimitiveIsDraw=!0,this.selfPrimitive=this._drawer.add(this.geometryProps,this.instanceProps,this.primitiveProps)},t.prototype.ngOnChanges=function(t){var e=t.geometryProps,i=t.instanceProps,n=t.primitiveProps;e.currentValue===e.previousValue&&i.currentValue===i.previousValue&&n.currentValue===n.previousValue||this.updateOnMap()},t.decorators=[{type:a.Component,args:[{selector:"ac-arc",template:""}]}],t.ctorParameters=function(){return[{type:X},{type:Et}]},t.propDecorators={geometryProps:[{type:a.Input}],instanceProps:[{type:a.Input}],primitiveProps:[{type:a.Input}]},t}(Yt),Ce=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-polygon-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:st},{type:Mt},{type:At},{type:te}]},t}(Xt),_e=function(){function t(t,e,i){this.plonterService=t,this.cd=e,this.geoConverter=i}return t.prototype.ngOnInit=function(){var t=this;this.plonterService.plonterChangeNotifier.subscribe(function(){return t.cd.detectChanges()})},Object.defineProperty(t.prototype,"plonterPosition",{get:function(){if(this.plonterService.plonterShown){var t=this.plonterService.plonterClickPosition.endPosition;return this.geoConverter.screenToCartesian3(t)}},enumerable:!0,configurable:!0}),t.prototype.chooseEntity=function(t){this.plonterService.resolvePlonter(t)},t.decorators=[{type:a.Component,args:[{selector:"ac-default-plonter",template:'\n      <ac-html *ngIf="plonterService.plonterShown" [props]="{\n        position: plonterPosition\n      }">\n        <div class="plonter-context-menu">\n          <div *ngFor="let entity of plonterService.entitesToPlonter">\n            <div class="plonter-item" (click)="chooseEntity(entity)">{{ entity?.name || entity?.id }}\n            </div>\n          </div>\n        </div>\n      </ac-html>\n    ',changeDetection:a.ChangeDetectionStrategy.OnPush,providers:[$],styles:["\n        .plonter-context-menu {\n            background-color: rgba(250, 250, 250, 0.8);\n            box-shadow: 1px 1px 5px 0px rgba(0, 0, 0, 0.15);\n        }\n\n        .plonter-item {\n            cursor: pointer;\n            padding: 2px 15px;\n            text-align: start;\n        }\n\n        .plonter-item:hover {\n            background-color: rgba(0, 0, 0, 0.15);\n        }\n\n    "]}]}],t.ctorParameters=function(){return[{type:mt},{type:a.ChangeDetectorRef},{type:$}]},t}(),Se=function(i){function t(t,e){return i.call(this,t,e)||this}return b(t,i),t.decorators=[{type:a.Component,args:[{selector:"ac-polygon",template:""}]}],t.ctorParameters=function(){return[{type:st},{type:Et}]},t}(Yt),Me=function(r){function t(t,e,i,n){var o=r.call(this,t,e,i,n)||this;return o._staticPrimitiveDrawer=t,o}return b(t,r),t.prototype.ngOnInit=function(){this._layerService.registerDescription(this),this._geometryPropsEvaluator=this._cesiumProperties.createEvaluator(this.geometryProps),this._instancePropsEvaluator=this._cesiumProperties.createEvaluator(this.instanceProps),this._primitivePropsEvaluator=this._cesiumProperties.createEvaluator(this.primitiveProps)},t.prototype.draw=function(t,e,i){var n=this._geometryPropsEvaluator(this._computationCache,t),o=this._instancePropsEvaluator(this._computationCache,t),r=this._primitivePropsEvaluator(this._computationCache,t);if(this._cesiumObjectsMap.has(e)){s=this._cesiumObjectsMap.get(e);this._staticPrimitiveDrawer.update(s,n,o,r)}else{var s;(s=this._staticPrimitiveDrawer.add(n,o,r)).acEntity=i,this._cesiumObjectsMap.set(e,s)}},t.propDecorators={geometryProps:[{type:a.Input}],instanceProps:[{type:a.Input}],primitiveProps:[{type:a.Input}]},t}(Xt),Ie=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-static-ellipse-desc",template:""}]}],t.ctorParameters=function(){return[{type:jt},{type:Mt},{type:At},{type:te}]},t}(Me),Ae=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-dynamic-ellipse-desc",template:""}]}],t.ctorParameters=function(){return[{type:Lt},{type:Mt},{type:At},{type:te}]},t}(Xt),De=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-dynamic-polyline-desc",template:""}]}],t.ctorParameters=function(){return[{type:wt},{type:Mt},{type:At},{type:te}]},t}(Xt),Le=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-static-polygon-desc",template:""}]}],t.ctorParameters=function(){return[{type:xt},{type:Mt},{type:At},{type:te}]},t}(Me),we=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-static-circle",template:""}]}],t.ctorParameters=function(){return[{type:Ot},{type:Mt},{type:At},{type:te}]},t}(Me),Te=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.prototype._propsEvaluator=function(t){var e=o.prototype._propsEvaluator.call(this,t);return e.semiMajorAxis=e.radius,e.semiMinorAxis=e.radius,e},t.decorators=[{type:a.Component,args:[{selector:"ac-dynamic-circle-desc",template:""}]}],t.ctorParameters=function(){return[{type:Lt},{type:Mt},{type:At},{type:te}]},t}(Xt),Oe=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-static-polyline-desc",template:""}]}],t.ctorParameters=function(){return[{type:Rt},{type:Mt},{type:At},{type:te}]},t}(Me),Re=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-model-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:Nt},{type:Mt},{type:At},{type:te}]},t}(Xt),xe=function(){function t(t){this.cesiumService=t,this.options={},this.show=!0,this.tilesetInstance=null}return t.prototype.ngOnInit=function(){if(!Dt.present(this.options.url))throw new Error("Options must have a url");this._3dtilesCollection=new Cesium.PrimitiveCollection,this.cesiumService.getScene().primitives.add(this._3dtilesCollection),this.show&&(this.tilesetInstance=this._3dtilesCollection.add(new Cesium.Cesium3DTileset(this.options),this.index),this.style&&(this.tilesetInstance.style=new Cesium.Cesium3DTileStyle(this.style)))},t.prototype.ngOnChanges=function(t){t.show&&!t.show.isFirstChange()&&(t.show.currentValue?this.tilesetInstance?this._3dtilesCollection.add(this.tilesetInstance,this.index):(this.tilesetInstance=this._3dtilesCollection.add(new Cesium.Cesium3DTileset(this.options),this.index),this.style&&(this.tilesetInstance.style=new Cesium.Cesium3DTileStyle(this.style))):this.tilesetInstance&&this._3dtilesCollection.remove(this.tilesetInstance,!1));if(t.style&&!t.style.isFirstChange()){t.style.currentValue;this.tilesetInstance&&(this.tilesetInstance.style=new Cesium.Cesium3DTileStyle(this.style))}},t.prototype.ngOnDestroy=function(){this.tilesetInstance&&this._3dtilesCollection.remove(this.tilesetInstance,!1)},t.decorators=[{type:a.Component,args:[{selector:"ac-3d-tile-layer",template:""}]}],t.ctorParameters=function(){return[{type:B}]},t.propDecorators={options:[{type:a.Input}],index:[{type:a.Input}],show:[{type:a.Input}],style:[{type:a.Input}]},t}(),je=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-box-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:Ft},{type:Mt},{type:At},{type:te}]},t}(Xt),Ne=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-cylinder-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:Vt},{type:Mt},{type:At},{type:te}]},t}(Xt),Fe=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-corridor-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:kt},{type:Mt},{type:At},{type:te}]},t}(Xt),ke=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-ellipsoid-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:Ht},{type:Mt},{type:At},{type:te}]},t}(Xt),Ve=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-polyline-volume-desc",template:""}]}],t.ctorParameters=function(){return[{type:Bt},{type:Mt},{type:At},{type:te}]},t}(Xt),He=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-wall-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:Gt},{type:Mt},{type:At},{type:te}]},t}(Xt),Be=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-rectangle-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:Ut},{type:Mt},{type:At},{type:te}]},t}(Xt),Ge=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-billboard-primitive-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:Kt},{type:Mt},{type:At},{type:te}]},t}(Xt),Ue=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-label-primitive-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:zt},{type:Mt},{type:At},{type:te}]},t}(Xt),ze=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-polyline-primitive-desc",template:"",providers:[{provide:Xt,useExisting:a.forwardRef(function(){return t})}]}]}],t.ctorParameters=function(){return[{type:pt},{type:Mt},{type:At},{type:te}]},t}(Xt),Ke=function(){function t(t,e){if(void 0===e&&(e=null),"object"!=typeof t)throw new Error("HtmlPrimitive ERROR: invalid html options!");this.scene=t.scene,this._mapContainer=t.mapContainer,this.show=t.show||!0,this.position=t.position,this.pixelOffset=t.pixelOffset,this.element=t.element,this.collection=e}return Object.defineProperty(t.prototype,"scene",{set:function(t){this._scene=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"show",{get:function(){return this._show},set:function(t){this._show=t,Cesium.defined(this.element)&&(this._element.style.display=t?"block":"none")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pixelOffset",{get:function(){return this._pixelOffset},set:function(t){this._pixelOffset=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"element",{get:function(){return this._element},set:function(t){this._element=t,Cesium.defined(t)&&(this._mapContainer.appendChild(t),this._element.style.position="absolute",this._element.style.zIndex=Number.MAX_VALUE.toString())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"collection",{get:function(){return this._collection},set:function(t){this._collection=t},enumerable:!0,configurable:!0}),t.prototype.update=function(){if(Cesium.defined(this._show)&&Cesium.defined(this._element)){var t=Cesium.SceneTransforms.wgs84ToWindowCoordinates(this._scene,this._position);Cesium.defined(t)?Cesium.defined(this._pixelOffset)&&Cesium.defined(this._pixelOffset.x)&&Cesium.defined(this._pixelOffset.y)&&(t.y+=this._pixelOffset.y,t.x+=this._pixelOffset.x):t=new Cesium.Cartesian2(-1e3,-1e3),this._lastPosition&&this._lastPosition.equals(t)||(this._element.style.top=t.y+"px",this._element.style.left=t.x+"px",this._lastPosition=t)}},t}(),We=function(){function t(){this._collection=[]}return Object.defineProperty(t.prototype,"length",{get:function(){return this._collection.length},enumerable:!0,configurable:!0}),t.prototype.get=function(t){return this._collection[t]},t.prototype.add=function(t){var e=new Ke(t,this);return this._collection.push(e),e},t.prototype.remove=function(t){var e=this._collection.indexOf(t);return-1!==e&&(this._collection.splice(e,1),!0)},t.prototype.update=function(){for(var t=0,e=this._collection.length;t<e;t++)this._collection[t].update()},t.prototype.removeAll=function(){for(;0<this._collection.length;)this._collection.pop()},t.prototype.contains=function(t){return Cesium.defined(t)&&t.collection===this},t}(),$e=function(){function t(){}return t.extend=function(){Cesium.HtmlPrimitive=Ke,Cesium.HtmlCollection=We},t}(),Ze=function(){function t(){this._entities=new Map}return t.prototype.has=function(t){return this._entities.has(t)},t.prototype.get=function(t){return this._entities.get(t)},t.prototype.addOrUpdate=function(t,e){this._entities.set(t,e)},t.prototype.remove=function(t){this._entities["delete"](t)},t.prototype.forEach=function(t){this._entities.forEach(t)},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[]},t}(),Ye=function sn(t,e){this.id=t,this.context=e},qe=function(){function t(t,e,i,n,o){this._templateRef=t,this._viewContainerRef=e,this._changeDetector=i,this._layerService=n,this._acHtmlManager=o,this._views=new Map}return t.prototype.ngOnInit=function(){},t.prototype._handleView=function(t,e,i){if(!this._views.has(t)&&e.show){var n=new Ye(t,{$implicit:i}),o=this._viewContainerRef.createEmbeddedView(this._templateRef,n);this._views.set(t,{viewRef:o,context:n}),this._changeDetector.detectChanges()}else this._views.has(t)&&!e.show?this.remove(t,e):this._views.has(t)&&e.show&&this._changeDetector.detectChanges()},t.prototype.addOrUpdate=function(t,e){var i=this._layerService.context[this._layerService.getEntityName()];this._views.has(t)&&(this._views.get(t).context.context.$implicit=i),this._acHtmlManager.addOrUpdate(t,{entity:i,primitive:e}),this._handleView(t,e,i)},t.prototype.remove=function(t,e){if(this._views.has(t)){var i=this._views.get(t).viewRef;this._viewContainerRef.remove(this._viewContainerRef.indexOf(i)),this._views["delete"](t),this._acHtmlManager.remove(t),e.element=null}},t.decorators=[{type:a.Directive,args:[{selector:"[acHtml]"}]}],t.ctorParameters=function(){return[{type:a.TemplateRef},{type:a.ViewContainerRef},{type:a.ChangeDetectorRef},{type:Mt},{type:Ze}]},t}(),Xe=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.prototype.ngOnInit=function(){if(o.prototype.ngOnInit.call(this),!this.acHtmlCreator)throw new Error("AcHtml desc ERROR: ac html directive not found.");if(!this.acHtmlTemplate)throw new Error("AcHtml desc ERROR: html template not found.")},t.prototype.draw=function(t,e){var i=this._propsEvaluator(t);if(this._cesiumObjectsMap.has(e)){n=this._cesiumObjectsMap.get(e);this._drawer.update(n,i),this.acHtmlCreator.addOrUpdate(e,n)}else{var n=this._drawer.add(i);this._cesiumObjectsMap.set(e,n),this.acHtmlCreator.addOrUpdate(e,n)}},t.prototype.remove=function(t){var e=this._cesiumObjectsMap.get(t);this._drawer.remove(e),this._cesiumObjectsMap["delete"](t),this.acHtmlCreator.remove(t,e)},t.prototype.removeAll=function(){var i=this;this._cesiumObjectsMap.forEach(function(t,e){i.acHtmlCreator.remove(e,t)}),this._cesiumObjectsMap.clear(),this._drawer.removeAll()},t.decorators=[{type:a.Component,args:[{selector:"ac-html-desc",providers:[Ze],template:'\n      <div *acHtml="let acHtmlEntityId = id; let acHtmlContext = context">\n          <div [acHtmlContainer]="acHtmlEntityId">\n              <ng-template [ngTemplateOutlet]="acHtmlTemplate"\n                           [ngTemplateOutletContext]="acHtmlContext"></ng-template>\n          </div>\n      </div>'}]}],t.ctorParameters=function(){return[{type:$t},{type:Mt},{type:At},{type:te}]},t.propDecorators={acHtmlCreator:[{type:a.ViewChild,args:[qe]}],acHtmlTemplate:[{type:a.ContentChild,args:[a.TemplateRef]}]},t}(Xt),Je=function(){function t(t,e){this._element=t,this._acHtmlManager=e}return Object.defineProperty(t.prototype,"acHtmlContainer",{set:function(t){this._id=t},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){if(this._id===undefined)throw new Error("AcHtml container ERROR: entity id not defined");this._acHtmlManager.get(this._id).primitive.element=this._element.nativeElement},t.decorators=[{type:a.Directive,args:[{selector:"[acHtmlContainer]"}]}],t.ctorParameters=function(){return[{type:a.ElementRef},{type:Ze}]},t.propDecorators={acHtmlContainer:[{type:a.Input}]},t}(),Qe=function(){function t(t,e,i){this.contextMenuService=t,this.cd=e,this.componentFactoryResolver=i}return t.prototype.ngOnInit=function(){var e=this;this.contextMenuChangeSubscription=this.contextMenuService.contextMenuChangeNotifier.subscribe(function(){return e.cd.detectChanges()}),this.contextMenuOpenSubscription=this.contextMenuService.onOpen.subscribe(function(){var t=e.componentFactoryResolver.resolveComponentFactory(e.contextMenuService.content);e.viewContainerRef.clear(),e.viewContainerRef.createComponent(t).instance.data=e.contextMenuService.options.data,e.cd.detectChanges()})},t.prototype.ngOnDestroy=function(){this.contextMenuChangeSubscription&&this.contextMenuChangeSubscription.unsubscribe(),this.contextMenuOpenSubscription&&this.contextMenuOpenSubscription.unsubscribe()},t.decorators=[{type:a.Component,args:[{selector:"ac-context-menu-wrapper",template:'\n    <ac-html *ngIf="contextMenuService.showContextMenu" [props]="{position: contextMenuService.position}">\n      <div #contextMenuContainer></div>\n    </ac-html>\n  ',changeDetection:a.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:z},{type:a.ChangeDetectorRef},{type:a.ComponentFactoryResolver}]},t.propDecorators={viewContainerRef:[{type:a.ViewChild,args:["contextMenuContainer",{read:a.ViewContainerRef}]}]},t}(),ti=function(){function t(t,e){this.layerService=t,this.cd=e,this.show=!0,this.entitiesMap=new Map,this.id=0,this.acForRgx=/^let\s+.+\s+of\s+.+$/,this.arrayObservable$=new w.Subject}return t.prototype.ngOnChanges=function(t){if(t.acFor.firstChange){var e=t.acFor.currentValue;if(!this.acForRgx.test(e))throw new Error('ac-layer: Invalid [acFor] syntax. Expected: [acFor]="let item of observable" .Instead received: '+e);var i=t.acFor.currentValue.split(" ");this.arrayPath=i[3],this.entityName=i[1]}},t.prototype.ngOnInit=function(){var t=this;this.layer.getLayerService().cache=!1,this.layerServiceSubscription=this.layerService.layerUpdates().subscribe(function(){t.cd.detectChanges()})},t.prototype.ngAfterContentInit=function(){var e=this;this.layerService.context.arrayObservable$=this.arrayObservable$,this.layerService.registerDescription(this),this.basicDescs._results.forEach(function(t){t.setLayerService(e.layer.getLayerService())}),this.arrayDescs._results.splice(0,1),this.arrayDescs._results.forEach(function(t){e.layerService.unregisterDescription(t),e.layer.getLayerService().registerDescription(t),t.layerService=e.layer.getLayerService(),t.setLayerService(e.layer.getLayerService())})},t.prototype.ngOnDestroy=function(){this.layerServiceSubscription&&this.layerServiceSubscription.unsubscribe()},t.prototype.setLayerService=function(t){this.layerService=t},t.prototype.draw=function(t,n,o){var r=this,e=p(t,this.arrayPath);if(e){var i=this.entitiesMap.get(n),s=[];if(this.entitiesMap.set(n,s),e.forEach(function(t,e){r.layerService.context[r.entityName]=t;var i=r.generateCombinedId(n,t,e);s.push(i),r.layer.update(o,i)}),i){var a=this.idGetter?i.filter(function(t){return s.indexOf(t)<0}):i;a&&a.forEach(function(t){return r.layer.remove(t)})}}},t.prototype.remove=function(t){var e=this,i=this.entitiesMap.get(t);i&&i.forEach(function(t){return e.layer.remove(t)}),this.entitiesMap["delete"](t)},t.prototype.removeAll=function(){this.layer.removeAll(),this.entitiesMap.clear()},t.prototype.getAcForString=function(){return"let "+this.entityName+"___temp of arrayObservable$"},t.prototype.generateCombinedId=function(t,e,i){return t+(this.idGetter?this.idGetter(e,i):this.id++%Number.MAX_SAFE_INTEGER)},t.decorators=[{type:a.Component,args:[{selector:"ac-array-desc",template:'\n    <ac-layer #layer [acFor]="getAcForString()"\n              [context]="layerService.context"\n              [options]="layerService.options"\n              [show]="layerService.show && show"\n              [zIndex]="layerService.zIndex">\n      <ng-content #content></ng-content>\n    </ac-layer>\n  ',changeDetection:a.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:Mt},{type:a.ChangeDetectorRef}]},t.propDecorators={acFor:[{type:a.Input}],idGetter:[{type:a.Input}],show:[{type:a.Input}],layer:[{type:a.ViewChild,args:["layer"]}],basicDescs:[{type:a.ContentChildren,args:[Xt,{descendants:!1}]}],arrayDescs:[{type:a.ContentChildren,args:[t,{descendants:!1}]}]},t}(),ei=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-point-primitive-desc",template:""}]}],t.ctorParameters=function(){return[{type:Wt},{type:Mt},{type:At},{type:te}]},t}(Xt),ii=function(i){function t(t,e){return i.call(this,t,e)||this}return b(t,i),t.decorators=[{type:a.Component,args:[{selector:"ac-primitive-polyline",template:""}]}],t.ctorParameters=function(){return[{type:pt},{type:Et}]},t}(Yt),ni=[{pipeName:"pixelOffset",pipeInstance:new oe},{pipeName:"radiansToDegrees",pipeInstance:new re}],oi=function(o){function t(t,e,i,n){return o.call(this,t,e,i,n)||this}return b(t,o),t.decorators=[{type:a.Component,args:[{selector:"ac-czml-desc",template:""}]}],t.ctorParameters=function(){return[{type:it},{type:Mt},{type:At},{type:te}]},t}(Xt),ri=function(){function e(){$e.extend()}return e.forRoot=function(t){return{ngModule:e,providers:[{provide:y,useValue:t},{provide:n.PIPES_CONFIG,multi:!0,useValue:t&&t.customPipes||[]},{provide:n.PIPES_CONFIG,multi:!0,useValue:ni}]}},e.decorators=[{type:a.NgModule,args:[{imports:[s.CommonModule,n.Angular2ParseModule,ae],declarations:[St,Zt,qt,ee,Ge,se,Ue,ie,ne,ze,oe,re,pe,ce,he,ye,fe,me,ii,ge,ve,qt,Pe,be,Ee,Ce,Se,_e,Re,xe,je,Ne,Fe,ke,Ve,He,Be,Qe,ei,Xe,qe,Je,ti,oi,Ie,Ae,De,Oe,Te,we,Le],exports:[St,qt,ee,Ge,se,Ue,ie,ne,ze,Zt,pe,ce,he,ye,fe,me,ii,ge,ve,qt,Pe,be,Ee,Ce,Se,_e,Re,xe,je,Ne,Fe,ke,Ve,He,Be,Qe,ei,Xe,ti,oi,Ie,Ae,De,Oe,Te,we,Le],providers:[Jt,te,q,S,Ct,f]}]}],e.ctorParameters=function(){return[]},e}(),si=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return b(e,t),e}(w.Observable),ai={ALT:Cesium.KeyboardEventModifier.ALT,CTRL:Cesium.KeyboardEventModifier.CTRL,SHIFT:Cesium.KeyboardEventModifier.SHIFT},pi=function(){function t(t){this.mapsManager=t,this.selectedEntitiesItems$=new w.BehaviorSubject([]),this.selectedEntitySubject$=new w.Subject}return t.prototype.selectedEntities$=function(){return this.selectedEntitiesItems$.asObservable()},t.prototype.selectedEntities=function(){return this.selectedEntitiesItems$.getValue()},t.prototype.selectedEntity$=function(){return this.selectedEntitySubject$},t.prototype.toggleSelection=function(t,e){-1===this.selectedEntities().indexOf(t)?this.addToSelected(t,e):this.removeSelected(t,e)},t.prototype.addToSelected=function(t,e){e&&(t.selected=!0);var i=this.selectedEntities();this.selectedEntitySubject$.next(t),this.selectedEntitiesItems$.next(_(i,[t]))},t.prototype.removeSelected=function(t,e){e&&(t.selected=!1);var i=this.selectedEntities(),n=i.indexOf(t);-1!==n&&(i.splice(n,1),this.selectedEntitiesItems$.next(i),this.selectedEntitySubject$.next(t))},t.prototype.initSelection=function(t,i,e,n){var o=this;void 0===i&&(i=!0);var r=this.mapsManager.getMap(n);r&&(this.mapEventsManagerService=r.getMapEventsManager(),t||Object.assign(t,{event:G.LEFT_CLICK}),this.mapEventsManagerService.register({event:t.event,pick:U.PICK_ONE,modifier:t.modifier,entityType:t.entityType,priority:e}).pipe(m.map(function(t){return t.entities}),m.filter(function(t){return t&&0<t.length})).subscribe(function(t){var e=t[0];o.toggleSelection(e,i)}))},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:Ct}]},t}();if(!u)throw new Error("must install heatmap.js. please do npm -i heatmap.js ");var ci=function(){function o(){this.heatmapOptionsDefaults={minCanvasSize:700,maxCanvasSize:2e3,radiusFactor:60,spacingFactor:1,maxOpacity:.8,minOpacity:.1,blur:.85,gradient:{".3":"blue",".65":"yellow",".8":"orange",".95":"red"}},this.WMP=new Cesium.WebMercatorProjection,this.wgs84PointToHeatmapPoint=function(t){return this.mercatorPointToHeatmapPoint(this.wgs84ToMercator(t))},this.rad2deg=function(t){return t/(Math.PI/180)}}return o.calcCircleContainingRect=function(t,e){return o.calcEllipseContainingRect(t,e,e)},o.calcEllipseContainingRect=function(t,e,i){var n=[q.pointByLocationDistanceAndAzimuth(t,i,0,!0),q.pointByLocationDistanceAndAzimuth(t,e,Math.PI/2,!0),q.pointByLocationDistanceAndAzimuth(t,e,Math.PI,!0),q.pointByLocationDistanceAndAzimuth(t,e,1.5*Math.PI,!0)];return Cesium.Rectangle.fromCartesianArray(n)},o.calculateContainingRectFromPoints=function(t){return Cesium.Rectangle.fromCartesianArray(t)},o.prototype.setData=function(t,e,i){return!!(i&&0<i.length&&null!==t&&!1!==t&&null!==e&&!1!==e)&&(this.heatmap.setData({min:t,max:e,data:i}),!0)},o.prototype.setWGS84Data=function(t,e,i){if(i&&0<i.length&&null!==t&&!1!==t&&null!==e&&!1!==e){for(var n=[],o=0;o<i.length;o++){var r=i[o],s=this.wgs84PointToHeatmapPoint(r);(r.value||0===r.value)&&(s.value=r.value),n.push(s)}return this.setData(t,e,n)}return!1},o.prototype.mercatorPointToHeatmapPoint=function(t){var e={};return e.x=Math.round((t.x-this._xoffset)/this._factor+this._spacing),e.y=Math.round((t.y-this._yoffset)/this._factor+this._spacing),e.y=this.height-e.y,e},o.prototype.createContainer=function(t,e){var i="heatmap"+o.containerCanvasCounter++,n=document.createElement("div");return n.setAttribute("id",i),n.setAttribute("style","width: "+e+"px; height: "+t+"px; margin: 0px; display: none;"),document.body.appendChild(n),{container:n,id:i}},o.prototype.wgs84ToMercator=function(t){var e=this.WMP.project(Cesium.Cartographic.fromDegrees(t.x,t.y));return{x:e.x,y:e.y}},o.prototype.wgs84ToMercatorBB=function(t){var e=this.WMP.project(Cesium.Cartographic.fromRadians(t.west,t.south)),i=this.WMP.project(Cesium.Cartographic.fromRadians(t.east,t.north));return{north:i.y,east:i.x,south:e.y,west:e.x}},o.prototype.mercatorToWgs84BB=function(t){var e=this.WMP.unproject(new Cesium.Cartesian3(t.west,t.south)),i=this.WMP.unproject(new Cesium.Cartesian3(t.east,t.north));return{north:this.rad2deg(i.latitude),east:this.rad2deg(i.longitude),south:this.rad2deg(e.latitude),west:this.rad2deg(e.longitude)}},o.prototype.setWidthAndHeight=function(t){this.width=0<t.east&&t.west<0?t.east+Math.abs(t.west):Math.abs(t.east-t.west),this.height=0<t.north&&t.south<0?t.north+Math.abs(t.south):Math.abs(t.north-t.south),this._factor=1,this.width>this.height&&this.width>this.heatmapOptionsDefaults.maxCanvasSize?(this._factor=this.width/this.heatmapOptionsDefaults.maxCanvasSize,this.height/this._factor<this.heatmapOptionsDefaults.minCanvasSize&&(this._factor=this.height/this.heatmapOptionsDefaults.minCanvasSize)):this.height>this.width&&this.height>this.heatmapOptionsDefaults.maxCanvasSize?(this._factor=this.height/this.heatmapOptionsDefaults.maxCanvasSize,this.width/this._factor<this.heatmapOptionsDefaults.minCanvasSize&&(this._factor=this.width/this.heatmapOptionsDefaults.minCanvasSize)):this.width<this.height&&this.width<this.heatmapOptionsDefaults.minCanvasSize?(this._factor=this.width/this.heatmapOptionsDefaults.minCanvasSize,this.height/this._factor>this.heatmapOptionsDefaults.maxCanvasSize&&(this._factor=this.height/this.heatmapOptionsDefaults.maxCanvasSize)):this.height<this.width&&this.height<this.heatmapOptionsDefaults.minCanvasSize&&(this._factor=this.height/this.heatmapOptionsDefaults.minCanvasSize,this.width/this._factor>this.heatmapOptionsDefaults.maxCanvasSize&&(this._factor=this.width/this.heatmapOptionsDefaults.maxCanvasSize)),this.width=this.width/this._factor,this.height=this.height/this._factor},o.prototype.create=function(t,e,i){var n=t,o=e.heatPointsData,r=(e.min,e.max,Object.assign({},this.heatmapOptionsDefaults,i));this._mbounds=this.wgs84ToMercatorBB(n),this.setWidthAndHeight(this._mbounds),r.radius=Math.round(i.radius?i.radius:this.width>this.height?this.width/this.heatmapOptionsDefaults.radiusFactor:this.height/this.heatmapOptionsDefaults.radiusFactor),this._spacing=r.radius*this.heatmapOptionsDefaults.spacingFactor,this._xoffset=this._mbounds.west,this._yoffset=this._mbounds.south,this.width=Math.round(this.width+2*this._spacing),this.height=Math.round(this.height+2*this._spacing),this._mbounds.west-=this._spacing*this._factor,this._mbounds.east+=this._spacing*this._factor,this._mbounds.south-=this._spacing*this._factor,this._mbounds.north+=this._spacing*this._factor,this.bounds=this.mercatorToWgs84BB(this._mbounds),this._rectangle=Cesium.Rectangle.fromDegrees(this.bounds.west,this.bounds.south,this.bounds.east,this.bounds.north);var s=this.createContainer(this.height,this.width),a=s.container,p=s.id;Object.assign(r,{container:a}),this.heatmap=u.create(r),this.setWGS84Data(0,100,o);var c=this.heatmap._renderer.canvas,l=new Cesium.ImageMaterialProperty({image:c,transparent:!0});return this.setClear(l,p),l},o.prototype.setClear=function(t,e){t.clear=function(){var t=document.getElementById(e);return t.parentNode.removeChild(t)}},o.containerCanvasCounter=0,o.decorators=[{type:a.Injectable}],o}(),li={CREATE:0,EDIT:1,CREATE_OR_EDIT:2};li[li.CREATE]="CREATE",li[li.EDIT]="EDIT",li[li.CREATE_OR_EDIT]="CREATE_OR_EDIT";var ui={INIT:0,MOUSE_MOVE:1,ADD_POINT:2,ADD_LAST_POINT:3,CHANGE_TO_EDIT:4,REMOVE_POINT:5,DRAG_POINT:6,DRAG_POINT_FINISH:7,DRAG_SHAPE:8,DRAG_SHAPE_FINISH:9,DONE:10,DISABLE:11,ENABLE:12,DISPOSE:13,SET_EDIT_LABELS_RENDER_CALLBACK:14,UPDATE_EDIT_LABELS:15,SET_MANUALLY:16,TRANSFORM:17};ui[ui.INIT]="INIT",ui[ui.MOUSE_MOVE]="MOUSE_MOVE",ui[ui.ADD_POINT]="ADD_POINT",ui[ui.ADD_LAST_POINT]="ADD_LAST_POINT",ui[ui.CHANGE_TO_EDIT]="CHANGE_TO_EDIT",ui[ui.REMOVE_POINT]="REMOVE_POINT",ui[ui.DRAG_POINT]="DRAG_POINT",ui[ui.DRAG_POINT_FINISH]="DRAG_POINT_FINISH",ui[ui.DRAG_SHAPE]="DRAG_SHAPE",ui[ui.DRAG_SHAPE_FINISH]="DRAG_SHAPE_FINISH",ui[ui.DONE]="DONE",ui[ui.DISABLE]="DISABLE",ui[ui.ENABLE]="ENABLE",ui[ui.DISPOSE]="DISPOSE",ui[ui.SET_EDIT_LABELS_RENDER_CALLBACK]="SET_EDIT_LABELS_RENDER_CALLBACK",ui[ui.UPDATE_EDIT_LABELS]="UPDATE_EDIT_LABELS",ui[ui.SET_MANUALLY]="SET_MANUALLY",ui[ui.TRANSFORM]="TRANSFORM";var di=function(r){function t(t,e,i,n){void 0===n&&(n=!1);var o=r.call(this)||this;return o._show=!0,o.editedEntityId=t,o.position=e,o.id=o.generateId(),o.pointProps=i,o._virtualEditPoint=n,o}return b(t,r),Object.defineProperty(t.prototype,"show",{get:function(){return this._show},set:function(t){this._show=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"props",{get:function(){return this.pointProps},set:function(t){this.pointProps=t},enumerable:!0,configurable:!0}),t.prototype.isVirtualEditPoint=function(){return this._virtualEditPoint},t.prototype.setVirtualEditPoint=function(t){this._virtualEditPoint=t},t.prototype.getEditedEntityId=function(){return this.editedEntityId},t.prototype.getPosition=function(){return this.position},t.prototype.setPosition=function(t){this.position.x=t.x,this.position.y=t.y,this.position.z=t.z},t.prototype.getId=function(){return this.id},t.prototype.generateId=function(){return"edit-point-"+t.counter++},t.counter=0,t}(le),hi=function(r){function t(t,e,i,n){var o=r.call(this)||this;return o.editedEntityId=t,o.id=o.generateId(),o.positions=[e,i],o._polylineProps=n,o}return b(t,r),Object.defineProperty(t.prototype,"props",{get:function(){return this._polylineProps},set:function(t){this._polylineProps=t},enumerable:!0,configurable:!0}),t.prototype.getEditedEntityId=function(){return this.editedEntityId},t.prototype.getPositions=function(){return this.positions},t.prototype.validatePositions=function(){return this.positions[0]!==undefined&&this.positions[1]!==undefined},t.prototype.getStartPosition=function(){return this.positions[0]},t.prototype.getEndPosition=function(){return this.positions[1]},t.prototype.setStartPosition=function(t){this.positions[0]=t},t.prototype.setEndPosition=function(t){this.positions[1]=t},t.prototype.getId=function(){return this.id},t.prototype.generateId=function(){return"edit-polyline-"+t.counter++},t.counter=0,t}(le),yi={backgroundColor:new Cesium.Color(.165,.165,.165,.7),backgroundPadding:new Cesium.Cartesian2(7,5),distanceDisplayCondition:undefined,eyeOffset:new Cesium.Cartesian3(0,0,-999),fillColor:Cesium.Color.WHITE,font:"30px sans-serif",heightReference:Cesium.HeightReference.NONE,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,outlineColor:Cesium.Color.BLACK,outlineWidth:1,pixelOffset:Cesium.Cartesian2.ZERO,pixelOffsetScaleByDistance:undefined,scale:1,scaleByDistance:undefined,show:!0,showBackground:!1,style:Cesium.LabelStyle.FILL,text:"",translucencyByDistance:undefined,verticalOrigin:Cesium.VerticalOrigin.BASELINE},fi=function(p){function t(t,e,i,n,o,r,s){var a=p.call(this)||this;return a.id=t,a.polygonsLayer=e,a.pointsLayer=i,a.polylinesLayer=n,a.coordinateConverter=o,a.positions=[],a.polylines=[],a.doneCreation=!1,a._enableEdit=!0,a._labels=[],a.polygonProps=r.polygonProps,a.defaultPointProps=r.pointProps,a.defaultPolylineProps=r.polylineProps,s&&3<=s.length&&a.createFromExisting(s),a}return b(t,p),Object.defineProperty(t.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var i=this.getRealPositions();this._labels=t.map(function(t,e){return t.position||(t.position=i[e]),Object.assign({},yi,t)})}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"defaultPolylineProps",{get:function(){return this._defaultPolylineProps},set:function(t){this._defaultPolylineProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"defaultPointProps",{get:function(){return this._defaultPointProps},set:function(t){this._defaultPointProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"polygonProps",{get:function(){return this._polygonProps},set:function(t){this._polygonProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(e){var i=this;this._enableEdit=e,this.positions.forEach(function(t){t.show=e,i.updatePointsLayer(!1,t)})},enumerable:!0,configurable:!0}),t.prototype.createFromExisting=function(t){var e=this;t.forEach(function(t){e.addPointFromExisting(t)}),this.addAllVirtualEditPoints(),this.updatePolygonsLayer(),this.doneCreation=!0},t.prototype.setPointsManually=function(t,e){var i=this;if(!this.doneCreation)throw new Error("Update manually only in edit mode, after polygon is created");this.positions.forEach(function(t){return i.pointsLayer.remove(t.getId())});for(var n=[],o=0;o<t.length;o++){var r=t[o],s=null;s=r.pointProps?new di(this.id,r.position,r.pointProps):new di(this.id,r,this.defaultPointProps),n.push(s)}this.positions=n,this.polygonProps=e||this.polygonProps,this.updatePointsLayer.apply(this,_([!0],this.positions)),this.addAllVirtualEditPoints(),this.updatePolygonsLayer()},t.prototype.addAllVirtualEditPoints=function(){var s=this,a=_(this.positions);a.forEach(function(t,e){var i=t,n=(e+1)%a.length,o=a[n],r=s.setMiddleVirtualPoint(i,o);s.updatePointsLayer(!1,r)})},t.prototype.setMiddleVirtualPoint=function(t,e){var i=Cesium.Cartographic.fromCartesian(t.getPosition()),n=Cesium.Cartographic.fromCartesian(e.getPosition()),o=this.coordinateConverter.midPointToCartesian3(i,n),r=new di(this.id,o,this.defaultPointProps);r.setVirtualEditPoint(!0);var s=this.positions.indexOf(t);return this.positions.splice(s+1,0,r),r},t.prototype.updateMiddleVirtualPoint=function(t,e,i){var n=Cesium.Cartographic.fromCartesian(e.getPosition()),o=Cesium.Cartographic.fromCartesian(i.getPosition());t.setPosition(this.coordinateConverter.midPointToCartesian3(n,o))},t.prototype.changeVirtualPointToRealPoint=function(t){t.setVirtualEditPoint(!1);var e=this.positions.length,i=this.positions.indexOf(t),n=(i+1)%e,o=(i-1+e)%e,r=this.positions[n],s=this.positions[o],a=this.setMiddleVirtualPoint(s,t),p=this.setMiddleVirtualPoint(t,r);this.updatePointsLayer(!0,a,p,t),this.updatePolygonsLayer()},t.prototype.renderPolylines=function(){var r=this;this.polylines.forEach(function(t){return r.polylinesLayer.remove(t.getId())}),this.polylines=[];var s=this.positions.filter(function(t){return!t.isVirtualEditPoint()});s.forEach(function(t,e){var i=(e+1)%s.length,n=s[i],o=new hi(r.id,t.getPosition(),n.getPosition(),r.defaultPolylineProps);r.polylines.push(o),r.polylinesLayer.update(o,o.getId())})},t.prototype.addPointFromExisting=function(t){var e=new di(this.id,t,this.defaultPointProps);this.positions.push(e),this.updatePointsLayer(!0,e)},t.prototype.addPoint=function(t){if(!this.doneCreation){if(!this.positions.length){var e=new di(this.id,t,this.defaultPointProps);this.positions.push(e),this.updatePointsLayer(!0,e)}this.movingPoint=new di(this.id,t.clone(),this.defaultPointProps),this.positions.push(this.movingPoint),this.updatePointsLayer(!0,this.movingPoint),this.updatePolygonsLayer()}},t.prototype.movePoint=function(t,e){if(e.setPosition(t),this.updatePolygonsLayer(),this.doneCreation){e.isVirtualEditPoint()&&this.changeVirtualPointToRealPoint(e);var i=this.positions.length,n=this.positions.indexOf(e),o=this.positions[(n+1)%i],r=this.positions[(n+2)%i],s=this.positions[(n-1+i)%i],a=this.positions[(n-2+i)%i];this.updateMiddleVirtualPoint(o,e,r),this.updateMiddleVirtualPoint(s,e,a),this.updatePointsLayer(!1,o),this.updatePointsLayer(!1,s)}this.updatePointsLayer(!0,e)},t.prototype.moveTempMovingPoint=function(t){this.movingPoint&&this.movePoint(t,this.movingPoint)},t.prototype.movePolygon=function(t,e){var i=this;if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var n=q.getPositionsDelta(this.lastDraggedToPosition,e);this.positions.forEach(function(t){q.addDeltaToPosition(t.getPosition(),n,!0)}),this.updatePointsLayer(),this.lastDraggedToPosition=e,this.positions.forEach(function(t){return i.updatePointsLayer(!0,t)})}},t.prototype.endMovePolygon=function(){this.lastDraggedToPosition=undefined},t.prototype.removePoint=function(t){var e=this;this.removePosition(t),this.positions.filter(function(t){return t.isVirtualEditPoint()}).forEach(function(t){return e.removePosition(t)}),this.addAllVirtualEditPoints(),this.renderPolylines(),3<=this.getPointsCount()&&this.polygonsLayer.update(this,this.id)},t.prototype.addLastPoint=function(t){this.doneCreation=!0,this.removePosition(this.movingPoint),this.movingPoint=null,this.updatePolygonsLayer(),this.addAllVirtualEditPoints()},t.prototype.getRealPositions=function(){return this.getRealPoints().map(function(t){return t.getPosition()})},t.prototype.getRealPoints=function(){var e=this;return this.positions.filter(function(t){return!t.isVirtualEditPoint()&&t!==e.movingPoint})},t.prototype.getPositionsHierarchy=function(){return this.positions.filter(function(t){return!t.isVirtualEditPoint()}).map(function(t){return t.getPosition()})},t.prototype.getPositionsHierarchyCallbackProperty=function(){return new Cesium.CallbackProperty(this.getPositionsHierarchy.bind(this),!1)},t.prototype.removePosition=function(e){var t=this.positions.findIndex(function(t){return t===e});t<0||(this.positions.splice(t,1),this.pointsLayer.remove(e.getId()))},t.prototype.updatePolygonsLayer=function(){3<=this.getPointsCount()&&this.polygonsLayer.update(this,this.id)},t.prototype.updatePointsLayer=function(t){var e=this;void 0===t&&(t=!0);for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];t&&this.renderPolylines(),i.forEach(function(t){return e.pointsLayer.update(t,t.getId())})},t.prototype.dispose=function(){var e=this;this.polygonsLayer.remove(this.id),this.positions.forEach(function(t){e.pointsLayer.remove(t.getId())}),this.polylines.forEach(function(t){return e.polylinesLayer.remove(t.getId())}),this.movingPoint&&(this.pointsLayer.remove(this.movingPoint.getId()),this.movingPoint=undefined),this.positions.length=0},t.prototype.getPointsCount=function(){return this.positions.length},t.prototype.getId=function(){return this.id},t}(le),mi=function(){function t(){this.polygons=new Map}return t.prototype.createEditablePolygon=function(t,e,i,n,o,r,s){var a=new fi(t,e,i,n,o,r,s);this.polygons.set(t,a)},t.prototype.dispose=function(t){this.polygons.get(t).dispose(),this.polygons["delete"](t)},t.prototype.get=function(t){return this.polygons.get(t)},t.prototype.clear=function(){this.polygons.forEach(function(t){return t.dispose()}),this.polygons.clear()},t.decorators=[{type:a.Injectable}],t}();function gi(t){void 0===t&&(t=12);for(var e="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<t;n++)e+=i.charAt(Math.floor(Math.random()*i.length));return e}var vi={addPointEvent:G.LEFT_CLICK,addLastPointEvent:G.LEFT_DOUBLE_CLICK,removePointEvent:G.RIGHT_CLICK,dragPointEvent:G.LEFT_CLICK_DRAG,dragShapeEvent:G.LEFT_CLICK_DRAG,allowDrag:!0,pointProps:{color:Cesium.Color.WHITE.withAlpha(.9),outlineColor:Cesium.Color.BLACK,outlineWidth:1,pixelSize:15,virtualPointPixelSize:8,show:!0,showVirtual:!0},polygonProps:{material:new Cesium.Color(.1,.5,.2,.4)},polylineProps:{material:function(){return Cesium.Color.BLACK},width:1}},Pi=function(){function t(){this.updateSubject=new w.Subject,this.updatePublisher=m.publish()(this.updateSubject),this.observablesMap=new Map}return t.prototype.init=function(t,e,i,n){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.polygonsManager=n,this.updatePublisher.connect()},t.prototype.onUpdate=function(){return this.updatePublisher},t.prototype.create=function(t,r){var s=this;void 0===t&&(t=vi),void 0===r&&(r=100);var a=[],p=gi(),c=this.setOptions(t),l=new w.BehaviorSubject({id:p,editAction:null,editMode:li.CREATE}),u=!1;this.updateSubject.next({id:p,positions:a,editMode:li.CREATE,editAction:ui.INIT,polygonOptions:c});var e=this.mapEventsManager.register({event:G.MOUSE_MOVE,pick:U.NO_PICK,priority:r}),i=this.mapEventsManager.register({event:c.addPointEvent,pick:U.NO_PICK,priority:r}),n=this.mapEventsManager.register({event:c.addLastPointEvent,pick:U.NO_PICK,priority:r});this.observablesMap.set(p,[e,i,n]);var d=this.createEditorObservable(l,p);return e.subscribe(function(t){var e=t.movement.endPosition,i=s.coordinateConverter.screenToCartesian3(e);i&&s.updateSubject.next({id:p,positions:s.getPositions(p),editMode:li.CREATE,updatedPosition:i,editAction:ui.MOUSE_MOVE})}),i.subscribe(function(t){var e=t.movement.endPosition;if(!u){var i=s.coordinateConverter.screenToCartesian3(e);if(i){var n=s.getPositions(p);if(!n.find(function(t){return t.equals(i)})){var o={id:p,positions:n,editMode:li.CREATE,updatedPosition:i,editAction:ui.ADD_POINT};s.updateSubject.next(o),l.next(E({},o,{positions:s.getPositions(p),points:s.getPoints(p)})),c.maximumNumberOfPoints&&n.length+1===c.maximumNumberOfPoints&&(u=s.switchToEditMode(p,i,l,a,r,c,d,u))}}}}),n.subscribe(function(t){var e=t.movement.endPosition,i=s.coordinateConverter.screenToCartesian3(e);i&&(u=s.switchToEditMode(p,i,l,a,r,c,d,u))}),d},t.prototype.switchToEditMode=function(t,e,i,n,o,r,s,a){var p={id:t,positions:this.getPositions(t),editMode:li.CREATE,updatedPosition:e,editAction:ui.ADD_LAST_POINT};this.updateSubject.next(p),i.next(E({},p,{positions:this.getPositions(t),points:this.getPoints(t)}));var c={id:t,editMode:li.CREATE,editAction:ui.CHANGE_TO_EDIT};return this.updateSubject.next(c),i.next(c),this.observablesMap.has(t)&&this.observablesMap.get(t).forEach(function(t){return t.dispose()}),this.observablesMap["delete"](t),this.editPolygon(t,n,o,i,r,s),!0},t.prototype.edit=function(t,e,i){if(void 0===e&&(e=vi),void 0===i&&(i=100),t.length<3)throw new Error("Polygons editor error edit(): polygon should have at least 3 positions");var n=gi(),o=this.setOptions(e),r=new w.BehaviorSubject({id:n,editAction:null,editMode:li.EDIT}),s={id:n,positions:t,editMode:li.EDIT,editAction:ui.INIT,polygonOptions:o};return this.updateSubject.next(s),r.next(E({},s,{positions:this.getPositions(n),points:this.getPoints(n)})),this.editPolygon(n,t,i,r,o)},t.prototype.editPolygon=function(p,t,e,c,i,n){var o,l=this,r=this.mapEventsManager.register({event:i.dragPointEvent,entityType:di,pick:U.PICK_FIRST,priority:e,pickFilter:function(t){return p===t.editedEntityId}});i.allowDrag&&(o=this.mapEventsManager.register({event:i.dragShapeEvent,entityType:fi,pick:U.PICK_FIRST,priority:e,pickFilter:function(t){return p===t.id}}));var s=this.mapEventsManager.register({event:i.removePointEvent,entityType:di,pick:U.PICK_FIRST,priority:e,pickFilter:function(t){return p===t.editedEntityId}});r.pipe(m.tap(function(t){var e=t.movement.drop;return l.cameraService.enableInputs(e)})).subscribe(function(t){var e=t.movement,i=e.endPosition,n=e.drop,o=t.entities,r=l.coordinateConverter.screenToCartesian3(i);if(r){var s=o[0],a={id:p,positions:l.getPositions(p),editMode:li.EDIT,updatedPosition:r,updatedPoint:s,editAction:n?ui.DRAG_POINT_FINISH:ui.DRAG_POINT};l.updateSubject.next(a),c.next(E({},a,{positions:l.getPositions(p),points:l.getPoints(p)}))}}),o&&o.pipe(m.tap(function(t){var e=t.movement.drop;return l.cameraService.enableInputs(e)})).subscribe(function(t){var e=t.movement,i=e.startPosition,n=e.endPosition,o=e.drop,r=(t.entities,l.coordinateConverter.screenToCartesian3(n)),s=l.coordinateConverter.screenToCartesian3(i);if(r){var a={id:p,positions:l.getPositions(p),editMode:li.EDIT,updatedPosition:r,draggedPosition:s,editAction:o?ui.DRAG_SHAPE_FINISH:ui.DRAG_SHAPE};l.updateSubject.next(a),c.next(E({},a,{positions:l.getPositions(p),points:l.getPoints(p)}))}}),s.subscribe(function(t){var e=t.entities[0],i=_(l.getPositions(p));if(!(i.length<4)&&!(i.findIndex(function(t){return e.getPosition().equals(t)})<0)){var n={id:p,positions:i,editMode:li.EDIT,updatedPoint:e,editAction:ui.REMOVE_POINT};l.updateSubject.next(n),c.next(E({},n,{positions:l.getPositions(p),points:l.getPoints(p)}))}});var a=[r,s];return o&&a.push(o),this.observablesMap.set(p,a),n||this.createEditorObservable(c,p)},t.prototype.setOptions=function(t){t.maximumNumberOfPoints&&t.maximumNumberOfPoints<3&&(console.warn("Warn: PolygonEditor invalid option. maximumNumberOfPoints smaller then 3, maximumNumberOfPoints changed to 3"),t.maximumNumberOfPoints=3);var e=JSON.parse(JSON.stringify(vi)),i=Object.assign(e,t);return i.pointProps=Object.assign({},vi.pointProps,t.pointProps),i.polygonProps=Object.assign({},vi.polygonProps,t.polygonProps),i.polylineProps=Object.assign({},vi.polylineProps,t.polylineProps),i},t.prototype.createEditorObservable=function(t,i){var n=this;return t.dispose=function(){var t=n.observablesMap.get(i);t&&t.forEach(function(t){return t.dispose()}),n.observablesMap["delete"](i),n.updateSubject.next({id:i,positions:n.getPositions(i),editMode:li.CREATE_OR_EDIT,editAction:ui.DISPOSE})},t.enable=function(){n.updateSubject.next({id:i,positions:n.getPositions(i),editMode:li.EDIT,editAction:ui.ENABLE})},t.disable=function(){n.updateSubject.next({id:i,positions:n.getPositions(i),editMode:li.EDIT,editAction:ui.DISABLE})},t.setManually=function(t,e){n.polygonsManager.get(i).setPointsManually(t,e),n.updateSubject.next({id:i,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_MANUALLY})},t.setLabelsRenderFn=function(t){n.updateSubject.next({id:i,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:t})},t.updateLabels=function(t){n.updateSubject.next({id:i,editMode:li.CREATE_OR_EDIT,editAction:ui.UPDATE_EDIT_LABELS,updateLabels:t})},t.getCurrentPoints=function(){return n.getPoints(i)},t.getEditValue=function(){return t.getValue()},t.getLabels=function(){return n.polygonsManager.get(i).labels},t},t.prototype.getPositions=function(t){return this.polygonsManager.get(t).getRealPositions()},t.prototype.getPoints=function(t){return this.polygonsManager.get(t).getRealPoints()},t.decorators=[{type:a.Injectable}],t}(),bi=function(){function t(t,e,i,n,o){this.polygonsEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.polygonsManager=o,this.Cesium=Cesium,this.editPoints$=new w.Subject,this.editPolylines$=new w.Subject,this.editPolygons$=new w.Subject,this.appearance=new Cesium.PerInstanceColorAppearance({flat:!0}),this.attributes={color:Cesium.ColorGeometryInstanceAttribute.fromColor(new Cesium.Color(.2,.2,.5,.5))},this.polygonColor=new Cesium.Color(.1,.5,.2,.4),this.lineColor=new Cesium.Color(0,0,0,.6),this.polygonsEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,o),this.startListeningToEditorUpdates()}return t.prototype.startListeningToEditorUpdates=function(){var e=this;this.polygonsEditor.onUpdate().subscribe(function(t){t.editMode===li.CREATE||t.editMode===li.CREATE_OR_EDIT?e.handleCreateUpdates(t):t.editMode===li.EDIT&&e.handleEditUpdates(t)})},t.prototype.getLabelId=function(t,e){return e.toString()},t.prototype.renderEditLabels=function(t,e,i){if(e.positions=t.getRealPositions(),e.points=t.getRealPoints(),i)return t.labels=i,void this.editPolygonsLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editPolygonsLayer.update(t,t.getId()))},t.prototype.removeEditLabels=function(t){t.labels=[],this.editPolygonsLayer.update(t,t.getId())},t.prototype.handleCreateUpdates=function(t){switch(t.editAction){case ui.INIT:this.polygonsManager.createEditablePolygon(t.id,this.editPolygonsLayer,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,t.polygonOptions);break;case ui.MOUSE_MOVE:var e=this.polygonsManager.get(t.id);t.updatedPosition&&(e.moveTempMovingPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.ADD_POINT:e=this.polygonsManager.get(t.id);t.updatedPosition&&(e.addPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.ADD_LAST_POINT:e=this.polygonsManager.get(t.id);t.updatedPosition&&(e.addLastPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DISPOSE:(e=this.polygonsManager.get(t.id)).dispose(),this.removeEditLabels(e),this.editLabelsRenderFn=undefined;break;case ui.SET_EDIT_LABELS_RENDER_CALLBACK:e=this.polygonsManager.get(t.id);this.editLabelsRenderFn=t.labelsRenderFn,this.renderEditLabels(e,t);break;case ui.UPDATE_EDIT_LABELS:case ui.SET_MANUALLY:e=this.polygonsManager.get(t.id);this.renderEditLabels(e,t,t.updateLabels);break;default:return}},t.prototype.handleEditUpdates=function(t){switch(t.editAction){case ui.INIT:this.polygonsManager.createEditablePolygon(t.id,this.editPolygonsLayer,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,t.polygonOptions,t.positions);break;case ui.DRAG_POINT:(e=this.polygonsManager.get(t.id))&&e.enableEdit&&(e.movePoint(t.updatedPosition,t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DRAG_POINT_FINISH:(e=this.polygonsManager.get(t.id))&&e.enableEdit&&t.updatedPoint.isVirtualEditPoint()&&(e.changeVirtualPointToRealPoint(t.updatedPoint),this.renderEditLabels(e,t));break;case ui.REMOVE_POINT:(e=this.polygonsManager.get(t.id))&&e.enableEdit&&(e.removePoint(t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DISABLE:(e=this.polygonsManager.get(t.id))&&(e.enableEdit=!1,this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE:(e=this.polygonsManager.get(t.id))&&e.enableEdit&&(e.movePolygon(t.draggedPosition,t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE_FINISH:(e=this.polygonsManager.get(t.id))&&e.enableEdit&&(e.endMovePolygon(),this.renderEditLabels(e,t));break;case ui.ENABLE:var e;(e=this.polygonsManager.get(t.id))&&(e.enableEdit=!0,this.renderEditLabels(e,t));break;default:return}},t.prototype.ngOnDestroy=function(){this.polygonsManager.clear()},t.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},t.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},t.decorators=[{type:a.Component,args:[{selector:"polygons-editor",template:'\n    <ac-layer #editPolylinesLayer acFor="let polyline of editPolylines$" [context]="this">\n      <ac-polyline-primitive-desc\n        props="{\n        positions: polyline.getPositions(),\n        width: polyline.props.width,\n        material: polyline.props.material()\n    }"\n      >\n      </ac-polyline-primitive-desc>\n    </ac-layer>\n\n    <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPosition(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point)\n    }"\n      >\n      </ac-point-desc>\n    </ac-layer>\n\n    <ac-layer #editPolygonsLayer acFor="let polygon of editPolygons$" [context]="this">\n      <ac-polygon-desc\n        props="{\n        hierarchy: polygon.getPositionsHierarchyCallbackProperty(),\n        material: polygon.polygonProps.material\n    }"\n      >\n      </ac-polygon-desc>\n      \x3c!-- <ac-static-polygon-desc --\x3e\n      \x3c!-- geometryProps="{ --\x3e\n      \x3c!-- polygonHierarchy: polygon.getHierarchy(), --\x3e\n      \x3c!-- height: 1 --\x3e\n      \x3c!-- }" --\x3e\n      \x3c!-- instanceProps="{ --\x3e\n      \x3c!-- attributes: attributes --\x3e\n      \x3c!-- }" --\x3e\n      \x3c!-- primitiveProps="{ --\x3e\n      \x3c!-- appearance: appearance --\x3e\n      \x3c!-- }"> --\x3e\n      \x3c!-- </ac-static-polygon-desc --\x3e\n      <ac-array-desc acFor="let label of polygon.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n  ',providers:[$,mi],changeDetection:a.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:Pi},{type:$},{type:bt},{type:v},{type:mi}]},t.propDecorators={editPolygonsLayer:[{type:a.ViewChild,args:["editPolygonsLayer"]}],editPointsLayer:[{type:a.ViewChild,args:["editPointsLayer"]}],editPolylinesLayer:[{type:a.ViewChild,args:["editPolylinesLayer"]}]},t}(),Ei=function(a){function t(t,e,i,n,o,r){var s=a.call(this)||this;return s._arcProps=r,s.id=s.generateId(),s.editedEntityId=t,s._center=e,s._radius=i,s._delta=n,s._angle=o,s}return b(t,a),Object.defineProperty(t.prototype,"props",{get:function(){return this._arcProps},set:function(t){this._arcProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"angle",{get:function(){return this._angle},set:function(t){this._angle=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"delta",{get:function(){return this._delta},set:function(t){this._delta=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"center",{get:function(){return this._center},set:function(t){this._center=t},enumerable:!0,configurable:!0}),t.prototype.updateCenter=function(t){this._center.x=t.x,this._center.y=t.y,this._center.z=t.z},t.prototype.getId=function(){return this.id},t.prototype.generateId=function(){return"edit-arc-"+t.counter++},t.counter=0,t}(le),Ci=function(s){function t(t,e,i,n,o){var r=s.call(this)||this;return r.id=t,r.circlesLayer=e,r.pointsLayer=i,r.arcsLayer=n,r.options=o,r.doneCreation=!1,r._enableEdit=!0,r._labels=[],r._circleProps=o.circleProps,r._pointProps=o.pointProps,r._polylineProps=o.polylineProps,r}return b(t,s),Object.defineProperty(t.prototype,"labels",{get:function(){return this._labels},set:function(i){var n=this;i&&this._center&&this._radiusPoint&&(this._labels=i.map(function(t,e){return t.position||(e!==i.length-1?t.position=n._center.getPosition():t.position=n._radiusPoint.getPosition()),Object.assign({},yi,t)}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"polylineProps",{get:function(){return this._polylineProps},set:function(t){this._polylineProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointProps",{get:function(){return this._pointProps},set:function(t){this._pointProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"circleProps",{get:function(){return this._circleProps},set:function(t){this._circleProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"center",{get:function(){return this._center},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"radiusPoint",{get:function(){return this._radiusPoint},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){this._enableEdit=t,this._center.show=t,this._radiusPoint.show=t,this.updatePointsLayer()},enumerable:!0,configurable:!0}),t.prototype.setManually=function(t,e,i,n,o){void 0===i&&(i=this.pointProps),void 0===n&&(n=this.pointProps),void 0===o&&(o=this.circleProps),this._center?this._center.setPosition(t):this._center=new di(this.id,t,i),this._radiusPoint?this._radiusPoint.setPosition(e):this._radiusPoint=new di(this.id,e,n),this._outlineArc?this._outlineArc.radius=this.getRadius():this.createOutlineArc(),this.circleProps=o,this.doneCreation=!0,this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer()},t.prototype.addPoint=function(t){this.doneCreation||(this._center||(this._center=new di(this.id,t,this.pointProps),this._radiusPoint=new di(this.id,t.clone(),this.pointProps),this._outlineArc||this.createOutlineArc()),this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer())},t.prototype.addLastPoint=function(t){!this.doneCreation&&this._center&&this._radiusPoint&&(this._radiusPoint.setPosition(t),this.doneCreation=!0,this.updatePointsLayer(),this.updateCirclesLayer())},t.prototype.movePoint=function(t){this._center&&this._radiusPoint&&(this._radiusPoint.setPosition(t),this._outlineArc.radius=this.getRadius(),this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer())},t.prototype.moveCircle=function(t,e){if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=this.getRadius(),n=q.getPositionsDelta(this.lastDraggedToPosition,e);q.addDeltaToPosition(this.getCenter(),n,!0),this.radiusPoint.setPosition(q.pointByLocationDistanceAndAzimuth(this.getCenter(),i,Math.PI/2,!0)),this._outlineArc.radius=this.getRadius(),this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer(),this.lastDraggedToPosition=e}},t.prototype.endMovePolygon=function(){this.lastDraggedToPosition=undefined},t.prototype.getRadius=function(){return this._center&&this._radiusPoint?q.distance(this._center.getPosition(),this._radiusPoint.getPosition()):0},t.prototype.getRadiusCallbackProperty=function(){return new Cesium.CallbackProperty(this.getRadius.bind(this),!1)},t.prototype.getCenter=function(){return this._center?this._center.getPosition():undefined},t.prototype.getCenterCallbackProperty=function(){return new Cesium.CallbackProperty(this.getCenter.bind(this),!1)},t.prototype.getRadiusPoint=function(){return this._radiusPoint?this._radiusPoint.getPosition():undefined},t.prototype.dispose=function(){this._center&&this.pointsLayer.remove(this._center.getId()),this._radiusPoint&&this.pointsLayer.remove(this._radiusPoint.getId()),this._outlineArc&&this.arcsLayer.remove(this._outlineArc.getId()),this.circlesLayer.remove(this.id)},t.prototype.getId=function(){return this.id},t.prototype.updateCirclesLayer=function(){this.circlesLayer.update(this,this.id)},t.prototype.updatePointsLayer=function(){this._center&&this.pointsLayer.update(this._center,this._center.getId()),this._radiusPoint&&this.pointsLayer.update(this._radiusPoint,this._radiusPoint.getId())},t.prototype.updateArcsLayer=function(){this._outlineArc&&this.arcsLayer.update(this._outlineArc,this._outlineArc.getId())},t.prototype.createOutlineArc=function(){this._center&&this._radiusPoint&&(this._outlineArc=new Ei(this.id,this.getCenter(),this.getRadius(),2*Math.PI,0,this.polylineProps))},t}(le),_i=function(){function t(){this.circles=new Map}return t.prototype.createEditableCircle=function(t,e,i,n,o){var r=new Ci(t,e,i,n,o);return this.circles.set(t,r),r},t.prototype.dispose=function(t){this.circles.get(t).dispose(),this.circles["delete"](t)},t.prototype.get=function(t){return this.circles.get(t)},t.prototype.clear=function(){this.circles.forEach(function(t){return t.dispose()}),this.circles.clear()},t.decorators=[{type:a.Injectable}],t}(),Si={addPointEvent:G.LEFT_CLICK,dragPointEvent:G.LEFT_CLICK_DRAG,dragShapeEvent:G.LEFT_CLICK_DRAG,allowDrag:!0,circleProps:{material:Cesium.Color.GREEN.withAlpha(.5),outline:!1,outlineWidth:1,outlineColor:Cesium.Color.BLACK},pointProps:{color:Cesium.Color.WHITE.withAlpha(.9),outlineColor:Cesium.Color.BLACK,outlineWidth:1,pixelSize:15,virtualPointPixelSize:8,show:!0,showVirtual:!0},polylineProps:{width:1,material:function(){return Cesium.Color.BLACK}}},Mi=function(){function t(){this.updateSubject=new w.Subject,this.updatePublisher=m.publish()(this.updateSubject),this.observablesMap=new Map}return t.prototype.init=function(t,e,i,n){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.circlesManager=n,this.updatePublisher.connect()},t.prototype.onUpdate=function(){return this.updatePublisher},t.prototype.create=function(t,r){var s,a=this;void 0===t&&(t=Si),void 0===r&&(r=100);var p=gi(),c=this.setOptions(t),l=new w.BehaviorSubject({id:p,editAction:null,editMode:li.CREATE}),u=!1;this.updateSubject.next({id:p,editMode:li.CREATE,editAction:ui.INIT,circleOptions:c});var e=this.mapEventsManager.register({event:G.MOUSE_MOVE,pick:U.NO_PICK,priority:r}),i=this.mapEventsManager.register({event:G.LEFT_CLICK,pick:U.NO_PICK,priority:r});this.observablesMap.set(p,[e,i]);var d=this.createEditorObservable(l,p);return i.subscribe(function(t){var e=t.movement.endPosition;if(!u){var i=a.coordinateConverter.screenToCartesian3(e);if(i)if(s){o={id:p,center:s,radiusPoint:i,editMode:li.CREATE,editAction:ui.ADD_LAST_POINT};a.updateSubject.next(o),l.next(E({},o,a.getCircleProperties(p)));var n={id:p,center:s,radiusPoint:i,editMode:li.CREATE,editAction:ui.CHANGE_TO_EDIT};a.updateSubject.next(n),l.next(E({},o,a.getCircleProperties(p))),a.observablesMap.has(p)&&a.observablesMap.get(p).forEach(function(t){return t.dispose()}),a.observablesMap["delete"](p),a.editCircle(p,r,l,c,d),u=!0}else{var o={id:p,center:i,editMode:li.CREATE,editAction:ui.ADD_POINT};a.updateSubject.next(o),l.next(E({},o,a.getCircleProperties(p))),s=i}}}),e.subscribe(function(t){var e=t.movement.endPosition;if(s){var i=a.coordinateConverter.screenToCartesian3(e);if(i){var n={id:p,center:s,radiusPoint:i,editMode:li.CREATE,editAction:ui.MOUSE_MOVE};a.updateSubject.next(n),l.next(E({},n,a.getCircleProperties(p)))}}}),d},t.prototype.edit=function(t,e,i,n){void 0===i&&(i=Si),void 0===n&&(n=100);var o=gi(),r=this.setOptions(i),s=new w.BehaviorSubject({id:o,editAction:null,editMode:li.EDIT}),a={id:o,center:t,radiusPoint:q.pointByLocationDistanceAndAzimuth(t,e,Math.PI/2,!0),editMode:li.EDIT,editAction:ui.INIT,circleOptions:r};return this.updateSubject.next(a),s.next(E({},a,this.getCircleProperties(o))),this.editCircle(o,n,s,r)},t.prototype.editCircle=function(u,t,d,h,e){var i,y=this,n=this.mapEventsManager.register({event:G.LEFT_CLICK_DRAG,entityType:di,pick:U.PICK_FIRST,priority:t,pickFilter:function(t){return u===t.editedEntityId}});h.allowDrag&&(i=this.mapEventsManager.register({event:G.LEFT_CLICK_DRAG,entityType:Ci,pick:U.PICK_FIRST,priority:t,pickFilter:function(t){return u===t.id}})),n.pipe(m.tap(function(t){var e=t.movement.drop;return y.cameraService.enableInputs(e)})).subscribe(function(t){var e=t.movement,i=e.endPosition,n=e.startPosition,o=e.drop,r=t.entities,s=y.coordinateConverter.screenToCartesian3(n),a=y.coordinateConverter.screenToCartesian3(i);if(a){var p,c=r[0]===y.getCenterPoint(u);if(p=o?c?ui.DRAG_SHAPE_FINISH:ui.DRAG_POINT_FINISH:c?ui.DRAG_SHAPE:ui.DRAG_POINT,h.allowDrag||p!==ui.DRAG_SHAPE&&p!==ui.DRAG_SHAPE_FINISH){var l={id:u,center:y.getCenterPosition(u),radiusPoint:y.getRadiusPosition(u),startDragPosition:s,endDragPosition:a,editMode:li.EDIT,editAction:p};y.updateSubject.next(l),d.next(E({},l,y.getCircleProperties(u)))}else y.cameraService.enableInputs(!0)}}),i&&i.pipe(m.tap(function(t){var e=t.movement.drop;return y.cameraService.enableInputs(e)})).subscribe(function(t){var e=t.movement,i=e.startPosition,n=e.endPosition,o=e.drop,r=y.coordinateConverter.screenToCartesian3(i),s=y.coordinateConverter.screenToCartesian3(n);if(s&&r){var a={id:u,center:y.getCenterPosition(u),radiusPoint:y.getRadiusPosition(u),startDragPosition:r,endDragPosition:s,editMode:li.EDIT,editAction:o?ui.DRAG_SHAPE_FINISH:ui.DRAG_SHAPE};y.updateSubject.next(a),d.next(E({},a,y.getCircleProperties(u)))}});var o=[n];return i&&o.push(i),this.observablesMap.set(u,o),e||this.createEditorObservable(d,u)},t.prototype.createEditorObservable=function(t,s){var a=this;return t.dispose=function(){var t=a.observablesMap.get(s);t&&t.forEach(function(t){return t.dispose()}),a.observablesMap["delete"](s),a.updateSubject.next({id:s,center:a.getCenterPosition(s),radiusPoint:a.getRadiusPosition(s),editMode:li.CREATE_OR_EDIT,editAction:ui.DISPOSE})},t.enable=function(){a.updateSubject.next({id:s,center:a.getCenterPosition(s),radiusPoint:a.getRadiusPosition(s),editMode:li.EDIT,editAction:ui.ENABLE})},t.disable=function(){a.updateSubject.next({id:s,center:a.getCenterPosition(s),radiusPoint:a.getRadiusPosition(s),editMode:li.EDIT,editAction:ui.DISABLE})},t.setManually=function(t,e,i,n,o){var r=q.pointByLocationDistanceAndAzimuth(t,e,Math.PI/2,!0);a.circlesManager.get(s).setManually(t,r,i,n,o),a.updateSubject.next({id:s,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_MANUALLY})},t.setLabelsRenderFn=function(t){a.updateSubject.next({id:s,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:t})},t.updateLabels=function(t){a.updateSubject.next({id:s,editMode:li.CREATE_OR_EDIT,editAction:ui.UPDATE_EDIT_LABELS,updateLabels:t})},t.getEditValue=function(){return t.getValue()},t.getLabels=function(){return a.circlesManager.get(s).labels},t.getCenter=function(){return a.getCenterPosition(s)},t.getRadius=function(){return a.getRadius(s)},t},t.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Si)),i=Object.assign(e,t);return i.pointProps=Object.assign({},Si.pointProps,t.pointProps),i.circleProps=Object.assign({},Si.circleProps,t.circleProps),i.polylineProps=Object.assign({},Si.polylineProps,t.polylineProps),i},t.prototype.getCenterPosition=function(t){return this.circlesManager.get(t).getCenter()},t.prototype.getCenterPoint=function(t){return this.circlesManager.get(t).center},t.prototype.getRadiusPosition=function(t){return this.circlesManager.get(t).getRadiusPoint()},t.prototype.getRadius=function(t){return this.circlesManager.get(t).getRadius()},t.prototype.getCircleProperties=function(t){var e=this.circlesManager.get(t);return{center:e.getCenter(),radiusPoint:e.getRadiusPoint(),radius:e.getRadius()}},t.decorators=[{type:a.Injectable}],t}(),Ii=function(){function t(t,e,i,n,o){this.circlesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.circlesManager=o,this.Cesium=Cesium,this.editPoints$=new w.Subject,this.editCircles$=new w.Subject,this.editArcs$=new w.Subject,this.circlesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,this.circlesManager),this.startListeningToEditorUpdates()}return t.prototype.startListeningToEditorUpdates=function(){var e=this;this.circlesEditor.onUpdate().subscribe(function(t){t.editMode===li.CREATE||t.editMode===li.CREATE_OR_EDIT?e.handleCreateUpdates(t):t.editMode===li.EDIT&&e.handleEditUpdates(t)})},t.prototype.getLabelId=function(t,e){return e.toString()},t.prototype.renderEditLabels=function(t,e,i){if(e.center=t.getCenter(),e.radiusPoint=t.getRadiusPoint(),e.radius=t.getRadius(),i)return t.labels=i,void this.editCirclesLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editCirclesLayer.update(t,t.getId()))},t.prototype.removeEditLabels=function(t){t.labels=[],this.editCirclesLayer.update(t,t.getId())},t.prototype.handleCreateUpdates=function(t){switch(t.editAction){case ui.INIT:this.circlesManager.createEditableCircle(t.id,this.editCirclesLayer,this.editPointsLayer,this.editArcsLayer,t.circleOptions);break;case ui.MOUSE_MOVE:var e=this.circlesManager.get(t.id);t.radiusPoint&&(e.movePoint(t.radiusPoint),this.renderEditLabels(e,t));break;case ui.ADD_POINT:e=this.circlesManager.get(t.id);t.center&&(e.addPoint(t.center),this.renderEditLabels(e,t));break;case ui.ADD_LAST_POINT:e=this.circlesManager.get(t.id);t.radiusPoint&&(e.addLastPoint(t.radiusPoint),this.renderEditLabels(e,t));break;case ui.DISPOSE:e=this.circlesManager.get(t.id);this.removeEditLabels(e),this.circlesManager.dispose(t.id);break;case ui.SET_EDIT_LABELS_RENDER_CALLBACK:e=this.circlesManager.get(t.id);this.editLabelsRenderFn=t.labelsRenderFn,this.renderEditLabels(e,t);break;case ui.UPDATE_EDIT_LABELS:case ui.SET_MANUALLY:e=this.circlesManager.get(t.id);this.renderEditLabels(e,t,t.updateLabels);break;default:return}},t.prototype.handleEditUpdates=function(t){switch(t.editAction){case ui.INIT:(e=this.circlesManager.createEditableCircle(t.id,this.editCirclesLayer,this.editPointsLayer,this.editArcsLayer,t.circleOptions)).setManually(t.center,t.radiusPoint);break;case ui.DRAG_POINT_FINISH:case ui.DRAG_POINT:(e=this.circlesManager.get(t.id))&&e.enableEdit&&(e.movePoint(t.endDragPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE:(e=this.circlesManager.get(t.id))&&e.enableEdit&&(e.moveCircle(t.startDragPosition,t.endDragPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE_FINISH:(e=this.circlesManager.get(t.id))&&e.enableEdit&&(e.endMovePolygon(),this.renderEditLabels(e,t));break;case ui.DISABLE:(e=this.circlesManager.get(t.id))&&(e.enableEdit=!1,this.renderEditLabels(e,t));break;case ui.ENABLE:var e;(e=this.circlesManager.get(t.id))&&(e.enableEdit=!0,this.renderEditLabels(e,t));break;default:return}},t.prototype.ngOnDestroy=function(){this.circlesManager.clear()},t.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},t.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},t.decorators=[{type:a.Component,args:[{selector:"circles-editor",template:'\n    <ac-layer #editArcsLayer acFor="let arc of editArcs$" [context]="this">\n      <ac-arc-desc\n        props="{\n        angle: arc.angle,\n        delta: arc.delta,\n        center: arc.center,\n        radius: arc.radius,\n        quality: 30,\n        color: arc.props.material()\n    }"\n      >\n      </ac-arc-desc>\n    </ac-layer>\n\n    <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPosition(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point)\n    }"\n      >\n      </ac-point-desc>\n    </ac-layer>\n\n    <ac-layer #editCirclesLayer acFor="let circle of editCircles$" [context]="this" [zIndex]="0">\n      <ac-ellipse-desc\n        props="{\n        position: circle.getCenterCallbackProperty(),\n        semiMajorAxis: circle.getRadiusCallbackProperty(),\n        semiMinorAxis: circle.getRadiusCallbackProperty(),\n        material: circle.circleProps.material,\n        outline: circle.circleProps.outline,\n        height: 0\n    }"\n      >\n      </ac-ellipse-desc>\n\n      <ac-array-desc acFor="let label of circle.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n  ',providers:[$,_i],changeDetection:a.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:Mi},{type:$},{type:bt},{type:v},{type:_i}]},t.propDecorators={editCirclesLayer:[{type:a.ViewChild,args:["editCirclesLayer"]}],editArcsLayer:[{type:a.ViewChild,args:["editArcsLayer"]}],editPointsLayer:[{type:a.ViewChild,args:["editPointsLayer"]}]},t}(),Ai=function(s){function t(t,e,i,n,o){var r=s.call(this)||this;return r.id=t,r.ellipsesLayer=e,r.pointsLayer=i,r.coordinateConverter=n,r.options=o,r._rotation=0,r.doneCreation=!1,r._enableEdit=!0,r._minorRadiusPoints=[],r._labels=[],r._ellipseProps=o.ellipseProps,r._pointProps=o.pointProps,r}return b(t,s),Object.defineProperty(t.prototype,"labels",{get:function(){return this._labels},set:function(t){var i=this;t&&this._center&&(this._labels=t.map(function(t,e){return t.position||(0===e?t.position=i._center.getPosition():1===e?t.position=i._majorRadiusPoint?Cesium.Cartesian3.midpoint(i.getCenter(),i._majorRadiusPoint.getPosition(),new Cesium.Cartesian3):new Cesium.Cartesian3:2===e&&(t.position=0<i._minorRadiusPoints.length&&i._minorRadius?Cesium.Cartesian3.midpoint(i.getCenter(),i.getMinorRadiusPointPosition(),new Cesium.Cartesian3):new Cesium.Cartesian3)),Object.assign({},yi,t)}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"polylineProps",{get:function(){return this._polylineProps},set:function(t){this._polylineProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointProps",{get:function(){return this._pointProps},set:function(t){this._pointProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ellipseProps",{get:function(){return this._ellipseProps},set:function(t){this._ellipseProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"center",{get:function(){return this._center},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"majorRadiusPoint",{get:function(){return this._majorRadiusPoint},enumerable:!0,configurable:!0}),t.prototype.getMajorRadiusPointPosition=function(){return this._majorRadiusPoint?this._majorRadiusPoint.getPosition():undefined},t.prototype.getMinorRadiusPointPosition=function(){return this._minorRadiusPoints.length<1?undefined:this._minorRadiusPoints[0].getPosition()},Object.defineProperty(t.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){this._enableEdit=t,this._center.show=t,this._majorRadiusPoint.show=t,this.updatePointsLayer()},enumerable:!0,configurable:!0}),t.prototype.setManually=function(t,e,i,n,o,r,s){if(void 0===i&&(i=Math.PI/2),void 0===o&&(o=this.pointProps),void 0===r&&(r=this.pointProps),void 0===s&&(s=this.ellipseProps),e<n)throw new Error("Major radius muse be equal or greater than minor radius");this._rotation=i,this._majorRadius=e,this._center?this._center.setPosition(t):this._center=new di(this.id,t,o);var a=q.pointByLocationDistanceAndAzimuth(this.center.getPosition(),e,i);this._majorRadiusPoint?this._majorRadiusPoint.setPosition(a):this._majorRadiusPoint=new di(this.id,a,r),n&&(this._minorRadius=n),this.ellipseProps=s,this.doneCreation=!0,this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer()},t.prototype.addPoint=function(t){this.doneCreation||(this._center||(this._center=new di(this.id,t,this.pointProps),this._majorRadiusPoint=new di(this.id,t.clone(),this.pointProps),this._majorRadius=0),this.updateRotation(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer())},t.prototype.transformToEllipse=function(){this._minorRadius||(this._minorRadius=this.getMajorRadius(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer())},t.prototype.addLastPoint=function(t){if(!this.doneCreation&&this._center&&this._majorRadiusPoint){var e=q.distance(this._center.getPosition(),t);this._majorRadiusPoint.setPosition(t),this._majorRadius=e,this.doneCreation=!0,this.options.circleToEllipseTransformation||(this._minorRadius=this._majorRadius),this.updateRotation(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer()}},t.prototype.movePoint=function(t,e){if(this._center&&this._majorRadiusPoint){var i=q.distance(this._center.getPosition(),t);this.majorRadiusPoint===e?i<this._minorRadius?(this._majorRadius=this._minorRadius,this._majorRadiusPoint.setPosition(q.pointByLocationDistanceAndAzimuth(this.getCenter(),this._minorRadius,this._rotation))):(this.majorRadiusPoint.setPosition(t),this._majorRadius=i):i>this._majorRadius?this._minorRadius=this._majorRadius:this._minorRadius=i,this.updateRotation(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer()}},t.prototype.moveEllipse=function(t,e){if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=this.getMajorRadius(),n=this.getRotation(),o=q.getPositionsDelta(this.lastDraggedToPosition,e);q.addDeltaToPosition(this.getCenter(),o,!0),this.majorRadiusPoint.setPosition(q.pointByLocationDistanceAndAzimuth(this.getCenter(),i,n)),this.updatePointsLayer(),this.updateMinorRadiusEditPoints(),this.updateEllipsesLayer(),this.lastDraggedToPosition=e}},t.prototype.endMoveEllipse=function(){this.lastDraggedToPosition=undefined},t.prototype.updateMinorRadiusEditPoints=function(){this._minorRadius!==undefined&&(0===this._minorRadiusPoints.length&&(this._minorRadiusPoints.push(new di(this.id,new Cesium.Cartesian3,this.pointProps,!0)),this._minorRadiusPoints.push(new di(this.id,new Cesium.Cartesian3,this.pointProps,!0))),this._minorRadiusPoints[0].setPosition(q.pointByLocationDistanceAndAzimuth(this._center.getPosition(),this._minorRadius,this.getRotation()-Math.PI/2)),this._minorRadiusPoints[1].setPosition(q.pointByLocationDistanceAndAzimuth(this._center.getPosition(),this._minorRadius,this.getRotation()+Math.PI/2)))},t.prototype.getMajorRadius=function(){return this._majorRadius||0},t.prototype.getMinorRadius=function(){return this._minorRadius===undefined?this.getMajorRadius():this._minorRadius},t.prototype.getRotation=function(){return this._rotation||0},t.prototype.updateRotation=function(){if(!this._majorRadiusPoint)return 0;var t=this.coordinateConverter.bearingToCartesian(this.getCenter(),this._majorRadiusPoint.getPosition());return this._rotation=Cesium.Math.toRadians(t),this._rotation},t.prototype.getRotationCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty(function(){return Math.PI/2-t.getRotation()},!1)},t.prototype.getMinorRadiusCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty(function(){return t.getMinorRadius()},!1)},t.prototype.getMajorRadiusCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty(function(){return t.getMajorRadius()},!1)},t.prototype.getCenter=function(){return this._center?this._center.getPosition():undefined},t.prototype.getCenterCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty(function(){return t.getCenter()},!1)},t.prototype.dispose=function(){var e=this;this._center&&this.pointsLayer.remove(this._center.getId()),this._majorRadiusPoint&&this.pointsLayer.remove(this._majorRadiusPoint.getId()),this._minorRadiusPoints&&this._minorRadiusPoints.forEach(function(t){return e.pointsLayer.remove(t.getId())}),this.ellipsesLayer.remove(this.id)},t.prototype.getId=function(){return this.id},t.prototype.updateEllipsesLayer=function(){this.ellipsesLayer.update(this,this.id)},t.prototype.updatePointsLayer=function(){this._center&&this.pointsLayer.update(this._center,this._center.getId()),this._majorRadiusPoint&&this.pointsLayer.update(this._majorRadiusPoint,this._majorRadiusPoint.getId()),0<this._minorRadiusPoints.length&&(this.pointsLayer.update(this._minorRadiusPoints[0],this._minorRadiusPoints[0].getId()),this.pointsLayer.update(this._minorRadiusPoints[1],this._minorRadiusPoints[1].getId()))},t}(le),Di=function(){function t(){this.ellipses=new Map}return t.prototype.createEditableEllipse=function(t,e,i,n,o){var r=new Ai(t,e,i,n,o);return this.ellipses.set(t,r),r},t.prototype.dispose=function(t){this.ellipses.get(t).dispose(),this.ellipses["delete"](t)},t.prototype.get=function(t){return this.ellipses.get(t)},t.prototype.clear=function(){this.ellipses.forEach(function(t){return t.dispose()}),this.ellipses.clear()},t.decorators=[{type:a.Injectable}],t}(),Li={addPointEvent:G.LEFT_CLICK,dragPointEvent:G.LEFT_CLICK_DRAG,dragShapeEvent:G.LEFT_CLICK_DRAG,circleToEllipseTransformEvent:G.LEFT_CLICK,circleToEllipseTransformEventModifier:ai.ALT,allowDrag:!0,ellipseProps:{material:Cesium.Color.GREEN.withAlpha(.5),outline:!0,outlineWidth:1,outlineColor:Cesium.Color.BLACK},pointProps:{color:Cesium.Color.WHITE.withAlpha(.9),outlineColor:Cesium.Color.BLACK,outlineWidth:1,pixelSize:15,virtualPointPixelSize:8,show:!0,showVirtual:!0},polylineProps:{width:1,material:function(){return Cesium.Color.BLACK}},circleToEllipseTransformation:!1},wi=function(){function t(){this.updateSubject=new w.Subject,this.updatePublisher=m.publish()(this.updateSubject),this.observablesMap=new Map}return t.prototype.init=function(t,e,i,n){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.ellipsesManager=n,this.updatePublisher.connect()},t.prototype.onUpdate=function(){return this.updatePublisher},t.prototype.create=function(t,r){var s,a=this;void 0===t&&(t=Li),void 0===r&&(r=100);var p=gi(),c=this.setOptions(t),l=new w.BehaviorSubject({id:p,editAction:null,editMode:li.CREATE}),u=!1;this.updateSubject.next({id:p,editMode:li.CREATE,editAction:ui.INIT,ellipseOptions:c});var e=this.mapEventsManager.register({event:G.MOUSE_MOVE,pick:U.NO_PICK,priority:r}),i=this.mapEventsManager.register({event:c.addPointEvent,pick:U.NO_PICK,priority:r});this.observablesMap.set(p,[e,i]);var d=this.createEditorObservable(l,p);return i.subscribe(function(t){var e=t.movement.endPosition;if(!u){var i=a.coordinateConverter.screenToCartesian3(e);if(i)if(s){o={id:p,center:s,updatedPosition:i,editMode:li.CREATE,editAction:ui.ADD_LAST_POINT};a.updateSubject.next(o),l.next(E({},o));var n={id:p,center:s,editMode:li.CREATE,editAction:ui.CHANGE_TO_EDIT};a.updateSubject.next(n),l.next(E({},o)),a.observablesMap.has(p)&&a.observablesMap.get(p).forEach(function(t){return t.dispose()}),a.observablesMap["delete"](p),a.editEllipse(p,r,l,c,d),u=!0}else{var o={id:p,center:i,editMode:li.CREATE,editAction:ui.ADD_POINT};a.updateSubject.next(o),l.next(E({},o)),s=i}}}),e.subscribe(function(t){var e=t.movement.endPosition;if(s){var i=a.coordinateConverter.screenToCartesian3(e);if(i){var n={id:p,center:s,updatedPosition:i,editMode:li.CREATE,editAction:ui.MOUSE_MOVE};a.updateSubject.next(n),l.next(E({},n))}}}),d},t.prototype.edit=function(t,e,i,n,o,r){void 0===i&&(i=Math.PI/2),void 0===o&&(o=Li),void 0===r&&(r=100);var s=gi(),a=this.setOptions(o),p=new w.BehaviorSubject({id:s,editAction:null,editMode:li.EDIT}),c={id:s,center:t,majorRadius:e,rotation:i,minorRadius:n,editMode:li.EDIT,editAction:ui.INIT,ellipseOptions:a};return this.updateSubject.next(c),p.next(E({},c)),this.editEllipse(s,r,p,a)},t.prototype.editEllipse=function(d,t,h,y,e){var i,n,f=this,o=this.mapEventsManager.register({event:y.dragPointEvent,entityType:di,pick:U.PICK_FIRST,priority:t,pickFilter:function(t){return d===t.editedEntityId}});y.circleToEllipseTransformation&&(i=this.mapEventsManager.register({event:y.circleToEllipseTransformEvent,modifier:y.circleToEllipseTransformEventModifier,entityType:Ai,pick:U.PICK_FIRST,priority:t,pickFilter:function(t){return d===t.id}})),y.allowDrag&&(n=this.mapEventsManager.register({event:y.dragShapeEvent,entityType:Ai,pick:U.PICK_FIRST,priority:t,pickFilter:function(t){return d===t.id}})),o.pipe(m.tap(function(t){var e=t.movement.drop;return f.cameraService.enableInputs(e)})).subscribe(function(t){var e=t.movement,i=e.endPosition,n=e.startPosition,o=e.drop,r=t.entities,s=f.coordinateConverter.screenToCartesian3(n),a=f.coordinateConverter.screenToCartesian3(i);if(a){var p,c=r[0],l=c===f.getCenterPoint(d);if(p=o?l?ui.DRAG_SHAPE_FINISH:ui.DRAG_POINT_FINISH:l?ui.DRAG_SHAPE:ui.DRAG_POINT,y.allowDrag||p!==ui.DRAG_SHAPE&&p!==ui.DRAG_SHAPE_FINISH){var u=E({id:d,updatedPoint:c,startDragPosition:s,endDragPosition:a,editMode:li.EDIT,editAction:p},f.getEllipseProperties(d));f.updateSubject.next(u),h.next(E({},u))}else f.cameraService.enableInputs(!0)}}),i&&i.subscribe(function(t){var e=t.movement,i=(e.endPosition,e.startPosition,e.drop,t.entities,E({id:d,editMode:li.EDIT,editAction:ui.TRANSFORM},f.getEllipseProperties(d)));f.updateSubject.next(i),h.next(E({},i))}),n&&n.pipe(m.tap(function(t){var e=t.movement.drop;return f.cameraService.enableInputs(e)})).subscribe(function(t){var e=t.movement,i=e.startPosition,n=e.endPosition,o=e.drop,r=f.coordinateConverter.screenToCartesian3(i),s=f.coordinateConverter.screenToCartesian3(n);if(s&&r){var a=E({id:d,startDragPosition:r,endDragPosition:s,editMode:li.EDIT,editAction:o?ui.DRAG_SHAPE_FINISH:ui.DRAG_SHAPE},f.getEllipseProperties(d));f.updateSubject.next(a),h.next(E({},a))}});var r=[o,i];return n&&r.push(n),i&&r.push(i),this.observablesMap.set(d,r),e||this.createEditorObservable(h,d)},t.prototype.createEditorObservable=function(t,a){var p=this;return t.dispose=function(){var t=p.observablesMap.get(a);t&&t.forEach(function(t){return t.dispose()}),p.observablesMap["delete"](a),p.updateSubject.next(E({id:a,editMode:li.CREATE_OR_EDIT,editAction:ui.DISPOSE},p.getEllipseProperties(a)))},t.enable=function(){p.updateSubject.next(E({id:a,editMode:li.EDIT,editAction:ui.ENABLE},p.getEllipseProperties(a)))},t.disable=function(){p.updateSubject.next(E({id:a,editMode:li.EDIT,editAction:ui.DISABLE},p.getEllipseProperties(a)))},t.setManually=function(t,e,i,n,o,r,s){p.ellipsesManager.get(a).setManually(t,e,i,n,o,r,s),p.updateSubject.next({id:a,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_MANUALLY})},t.setLabelsRenderFn=function(t){p.updateSubject.next({id:a,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:t})},t.updateLabels=function(t){p.updateSubject.next({id:a,editMode:li.CREATE_OR_EDIT,editAction:ui.UPDATE_EDIT_LABELS,updateLabels:t})},t.getEditValue=function(){return t.getValue()},t.getLabels=function(){return p.ellipsesManager.get(a).labels},t.getCenter=function(){return p.getCenterPosition(a)},t.getMajorRadius=function(){return p.getMajorRadius(a)},t.getMinorRadius=function(){return p.getMinorRadius(a)},t},t.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Li)),i=Object.assign(e,t);return i.pointProps=Object.assign({},Li.pointProps,t.pointProps),i.ellipseProps=Object.assign({},Li.ellipseProps,t.ellipseProps),i.polylineProps=Object.assign({},Li.polylineProps,t.polylineProps),i},t.prototype.getCenterPosition=function(t){return this.ellipsesManager.get(t).getCenter()},t.prototype.getCenterPoint=function(t){return this.ellipsesManager.get(t).center},t.prototype.getMajorRadius=function(t){return this.ellipsesManager.get(t).getMajorRadius()},t.prototype.getMinorRadius=function(t){return this.ellipsesManager.get(t).getMinorRadius()},t.prototype.getEllipseProperties=function(t){var e=this.ellipsesManager.get(t);return{center:e.getCenter(),rotation:e.getRotation(),minorRadius:e.getMinorRadius(),majorRadius:e.getMajorRadius(),minorRadiusPointPosition:e.getMinorRadiusPointPosition(),majorRadiusPointPosition:e.getMajorRadiusPointPosition()}},t.decorators=[{type:a.Injectable}],t}(),Ti=function(){function t(t,e,i,n,o){this.ellipsesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.ellipsesManager=o,this.Cesium=Cesium,this.editPoints$=new w.Subject,this.editEllipses$=new w.Subject,this.ellipsesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,this.ellipsesManager),this.startListeningToEditorUpdates()}return t.prototype.startListeningToEditorUpdates=function(){var e=this;this.ellipsesEditor.onUpdate().subscribe(function(t){t.editMode===li.CREATE||t.editMode===li.CREATE_OR_EDIT?e.handleCreateUpdates(t):t.editMode===li.EDIT&&e.handleEditUpdates(t)})},t.prototype.getLabelId=function(t,e){return e.toString()},t.prototype.renderEditLabels=function(t,e,i){if(e.center=t.getCenter(),e.majorRadius=t.getMajorRadius(),e.minorRadius=t.getMinorRadius(),e.rotation=t.getRotation(),i)return t.labels=i,void this.editEllipsesLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editEllipsesLayer.update(t,t.getId()))},t.prototype.removeEditLabels=function(t){t.labels=[],this.editEllipsesLayer.update(t,t.getId())},t.prototype.handleCreateUpdates=function(t){switch(t.editAction){case ui.INIT:this.ellipsesManager.createEditableEllipse(t.id,this.editEllipsesLayer,this.editPointsLayer,this.coordinateConverter,t.ellipseOptions);break;case ui.MOUSE_MOVE:var e=this.ellipsesManager.get(t.id);t.updatedPosition&&(e.movePoint(t.updatedPosition,e.majorRadiusPoint),this.renderEditLabels(e,t));break;case ui.ADD_POINT:e=this.ellipsesManager.get(t.id);t.center&&(e.addPoint(t.center),this.renderEditLabels(e,t));break;case ui.ADD_LAST_POINT:e=this.ellipsesManager.get(t.id);t.updatedPosition&&(e.addLastPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DISPOSE:e=this.ellipsesManager.get(t.id);this.removeEditLabels(e),this.ellipsesManager.dispose(t.id);break;case ui.SET_EDIT_LABELS_RENDER_CALLBACK:e=this.ellipsesManager.get(t.id);this.editLabelsRenderFn=t.labelsRenderFn,this.renderEditLabels(e,t);break;case ui.UPDATE_EDIT_LABELS:case ui.SET_MANUALLY:e=this.ellipsesManager.get(t.id);this.renderEditLabels(e,t,t.updateLabels);break;default:return}},t.prototype.handleEditUpdates=function(t){switch(t.editAction){case ui.INIT:(e=this.ellipsesManager.createEditableEllipse(t.id,this.editEllipsesLayer,this.editPointsLayer,this.coordinateConverter,t.ellipseOptions)).setManually(t.center,t.majorRadius,t.rotation,t.minorRadius,t.ellipseOptions&&t.ellipseOptions.pointProps||undefined,t.ellipseOptions&&t.ellipseOptions.pointProps||undefined,t.ellipseOptions&&t.ellipseOptions.ellipseProps||undefined),this.renderEditLabels(e,t);break;case ui.DRAG_POINT_FINISH:case ui.DRAG_POINT:(e=this.ellipsesManager.get(t.id))&&e.enableEdit&&(e.movePoint(t.endDragPosition,t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE:(e=this.ellipsesManager.get(t.id))&&e.enableEdit&&(e.moveEllipse(t.startDragPosition,t.endDragPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE_FINISH:(e=this.ellipsesManager.get(t.id))&&e.enableEdit&&(e.endMoveEllipse(),this.renderEditLabels(e,t));break;case ui.TRANSFORM:(e=this.ellipsesManager.get(t.id))&&e.enableEdit&&(e.transformToEllipse(),this.renderEditLabels(e,t));break;case ui.DISABLE:(e=this.ellipsesManager.get(t.id))&&(e.enableEdit=!1,this.renderEditLabels(e,t));break;case ui.ENABLE:var e;(e=this.ellipsesManager.get(t.id))&&(e.enableEdit=!0,this.renderEditLabels(e,t));break;default:return}},t.prototype.ngOnDestroy=function(){this.ellipsesManager.clear()},t.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},t.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},t.decorators=[{type:a.Component,args:[{selector:"ellipses-editor",template:'\n    <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPosition(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point)\n    }"\n      >\n      </ac-point-desc>\n    </ac-layer>\n\n    <ac-layer #editEllipsesLayer acFor="let ellipse of editEllipses$" [context]="this" [zIndex]="0">\n      <ac-ellipse-desc\n        props="{\n        position: ellipse.getCenterCallbackProperty(),\n        semiMajorAxis: ellipse.getMajorRadiusCallbackProperty(),\n        semiMinorAxis: ellipse.getMinorRadiusCallbackProperty(),\n        rotation: ellipse.getRotationCallbackProperty(),\n        material: ellipse.ellipseProps.material,\n        outline: ellipse.ellipseProps.outline,\n        outlineWidth: ellipse.ellipseProps.outlineWidth,\n        outlineColor: ellipse.ellipseProps.outlineColor,\n        height: 0\n    }"\n      >\n      </ac-ellipse-desc>\n\n      <ac-array-desc acFor="let label of ellipse.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            text: label.text,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n  ',providers:[$,Di],changeDetection:a.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:wi},{type:$},{type:bt},{type:v},{type:Di}]},t.propDecorators={editEllipsesLayer:[{type:a.ViewChild,args:["editEllipsesLayer"]}],editPointsLayer:[{type:a.ViewChild,args:["editPointsLayer"]}]},t}(),Oi=function(a){function t(t,e,i,n,o,r){var s=a.call(this)||this;return s.id=t,s.pointsLayer=e,s.polylinesLayer=i,s.coordinateConverter=n,s.editOptions=o,s.positions=[],s.polylines=[],s.doneCreation=!1,s._enableEdit=!0,s._labels=[],s._pointProps=o.pointProps,s.props=o.polylineProps,r&&2<=r.length&&s.createFromExisting(r),s}return b(t,a),Object.defineProperty(t.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var i=this.getRealPositions();this._labels=t.map(function(t,e){return t.position||(t.position=i[e]),Object.assign({},yi,t)})}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"props",{get:function(){return this.polylineProps},set:function(t){this.polylineProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointProps",{get:function(){return this._pointProps},set:function(t){this._pointProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(e){var i=this;this._enableEdit=e,this.positions.forEach(function(t){t.show=e,i.updatePointsLayer(!1,t)})},enumerable:!0,configurable:!0}),t.prototype.createFromExisting=function(t){var e=this;t.forEach(function(t){e.addPointFromExisting(t)}),this.addAllVirtualEditPoints(),this.doneCreation=!0},t.prototype.setManually=function(t,e){var i=this;if(!this.doneCreation)throw new Error("Update manually only in edit mode, after polyline is created");this.positions.forEach(function(t){return i.pointsLayer.remove(t.getId())});for(var n=[],o=0;o<t.length;o++){var r=t[o],s=null;s=r.pointProps?new di(this.id,r.position,r.pointProps):new di(this.id,r,this._pointProps),n.push(s)}this.positions=n,this.polylineProps=e||this.polylineProps,this.updatePointsLayer.apply(this,_([!0],this.positions)),this.addAllVirtualEditPoints()},t.prototype.addAllVirtualEditPoints=function(){var s=this,a=_(this.positions);a.forEach(function(t,e){if(e!==a.length-1){var i=t,n=(e+1)%a.length,o=a[n],r=s.setMiddleVirtualPoint(i,o);s.updatePointsLayer(!1,r)}})},t.prototype.setMiddleVirtualPoint=function(t,e){var i=Cesium.Cartographic.fromCartesian(t.getPosition()),n=Cesium.Cartographic.fromCartesian(e.getPosition()),o=this.coordinateConverter.midPointToCartesian3(i,n),r=new di(this.id,o,this._pointProps);r.setVirtualEditPoint(!0);var s=this.positions.indexOf(t);return this.positions.splice(s+1,0,r),r},t.prototype.updateMiddleVirtualPoint=function(t,e,i){var n=Cesium.Cartographic.fromCartesian(e.getPosition()),o=Cesium.Cartographic.fromCartesian(i.getPosition());t.setPosition(this.coordinateConverter.midPointToCartesian3(n,o))},t.prototype.changeVirtualPointToRealPoint=function(t){t.setVirtualEditPoint(!1);var e=this.positions.length,i=this.positions.indexOf(t),n=(i+1)%e,o=(i-1+e)%e,r=this.positions[n],s=this.positions[o],a=this.setMiddleVirtualPoint(s,t),p=this.setMiddleVirtualPoint(t,r);this.updatePointsLayer(!1,a,p,t)},t.prototype.renderPolylines=function(){var o=this;this.polylines.forEach(function(t){return o.polylinesLayer.remove(t.getId())}),this.polylines=[];var r=this.positions.filter(function(t){return!t.isVirtualEditPoint()});r.forEach(function(t,e){if(e!==r.length-1){var i=r[e+1],n=new hi(o.id,t.getPosition(),i.getPosition(),o.polylineProps);o.polylines.push(n),o.polylinesLayer.update(n,n.getId())}})},t.prototype.addPointFromExisting=function(t){var e=new di(this.id,t,this._pointProps);this.positions.push(e),this.updatePointsLayer(!0,e)},t.prototype.addPoint=function(t){if(!this.doneCreation){if(!this.positions.length){var e=new di(this.id,t,this._pointProps);this.positions.push(e),this.updatePointsLayer(!0,e)}this.movingPoint=new di(this.id,t.clone(),this._pointProps),this.positions.push(this.movingPoint),this.updatePointsLayer(!0,this.movingPoint)}},t.prototype.movePoint=function(t,e){if(e.setPosition(t),this.doneCreation){e.isVirtualEditPoint()&&this.changeVirtualPointToRealPoint(e);var i=this.positions.length,n=this.positions.indexOf(e);if(n<this.positions.length-1){var o=this.positions[(n+1)%i],r=this.positions[(n+2)%i];this.updateMiddleVirtualPoint(o,e,r),this.updatePointsLayer(!1,o)}if(0<n){var s=this.positions[(n-1+i)%i],a=this.positions[(n-2+i)%i];this.updateMiddleVirtualPoint(s,e,a),this.updatePointsLayer(!1,s)}}this.updatePointsLayer(!0,e)},t.prototype.moveTempMovingPoint=function(t){this.movingPoint&&this.movePoint(t,this.movingPoint)},t.prototype.moveShape=function(t,e){if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=q.getPositionsDelta(this.lastDraggedToPosition,e);this.positions.forEach(function(t){q.addDeltaToPosition(t.getPosition(),i,!0)}),this.updatePointsLayer.apply(this,_([!0],this.positions)),this.lastDraggedToPosition=e}},t.prototype.endMoveShape=function(){this.lastDraggedToPosition=undefined,this.updatePointsLayer.apply(this,_([!0],this.positions))},t.prototype.removePoint=function(t){var e=this;this.removePosition(t),this.positions.filter(function(t){return t.isVirtualEditPoint()}).forEach(function(t){return e.removePosition(t)}),this.addAllVirtualEditPoints(),this.renderPolylines()},t.prototype.addLastPoint=function(t){this.doneCreation=!0,this.removePosition(this.movingPoint),this.movingPoint=null,this.addAllVirtualEditPoints()},t.prototype.getRealPositions=function(){return this.getRealPoints().map(function(t){return t.getPosition()})},t.prototype.getRealPoints=function(){var e=this;return this.positions.filter(function(t){return!t.isVirtualEditPoint()&&t!==e.movingPoint})},t.prototype.getPositions=function(){return this.positions.map(function(t){return t.getPosition()})},t.prototype.removePosition=function(e){var t=this.positions.findIndex(function(t){return t===e});t<0||(this.positions.splice(t,1),this.pointsLayer.remove(e.getId()))},t.prototype.updatePointsLayer=function(t){var e=this;void 0===t&&(t=!0);for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];t&&this.renderPolylines(),i.forEach(function(t){return e.pointsLayer.update(t,t.getId())})},t.prototype.update=function(){this.updatePointsLayer()},t.prototype.dispose=function(){var e=this;this.positions.forEach(function(t){e.pointsLayer.remove(t.getId())}),this.polylines.forEach(function(t){return e.polylinesLayer.remove(t.getId())}),this.movingPoint&&(this.pointsLayer.remove(this.movingPoint.getId()),this.movingPoint=undefined),this.positions.length=0},t.prototype.getPointsCount=function(){return this.positions.length},t.prototype.getId=function(){return this.id},t}(le),Ri=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return b(e,t),e}(w.Observable),xi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return b(e,t),e}(Ri),ji=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return b(e,t),e}(Ri),Ni=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return b(e,t),e}(Ri),Fi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return b(e,t),e}(Ri),ki=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return b(e,t),e}(Ri),Vi=function(a){function t(t,e,i,n,o,r){var s=a.call(this)||this;if(s.id=t,s.pointsLayer=e,s.hippodromeLayer=i,s.coordinateConverter=n,s.positions=[],s.done=!1,s._enableEdit=!0,s._labels=[],s.defaultPointProps=o.pointProps,s.hippodromeProps=o.hippodromeProps,r&&2===r.length)s.createFromExisting(r);else if(r)throw new Error("Hippodrome consist of 2 points but provided "+r.length);return s}return b(t,a),Object.defineProperty(t.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var i=this.getRealPositions();this._labels=t.map(function(t,e){return t.position||(t.position=i[e]),Object.assign({},yi,t)})}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hippodromeProps",{get:function(){return this._hippodromeProps},set:function(t){this._hippodromeProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"defaultPointProps",{get:function(){return this._defaultPointProps},set:function(t){this._defaultPointProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(e){var i=this;this._enableEdit=e,this.positions.forEach(function(t){t.show=e,i.updatePointsLayer(t)})},enumerable:!0,configurable:!0}),t.prototype.createFromExisting=function(t){var e=this;t.forEach(function(t){e.addPointFromExisting(t)}),this.createHeightEditPoints(),this.updateHippdromeLayer(),this.updatePointsLayer.apply(this,_(this.positions)),this.done=!0},t.prototype.setPointsManually=function(t,e){var i=this;if(!this.done)throw new Error("Update manually only in edit mode, after polyline is created");this.hippodromeProps.width=e||this.hippodromeProps.width,this.positions.forEach(function(t){return i.pointsLayer.remove(t.getId())}),this.positions=t,this.createHeightEditPoints(),this.updatePointsLayer.apply(this,_(t)),this.updateHippdromeLayer()},t.prototype.addPointFromExisting=function(t){var e=new di(this.id,t,this.defaultPointProps);this.positions.push(e),this.updatePointsLayer(e)},t.prototype.addPoint=function(t){if(!this.done)if(!this.positions.length){var e=new di(this.id,t,this.defaultPointProps);this.positions.push(e),this.movingPoint=new di(this.id,t.clone(),this.defaultPointProps),this.positions.push(this.movingPoint),this.updatePointsLayer(e)}else this.createHeightEditPoints(),this.updatePointsLayer.apply(this,_(this.positions)),this.updateHippdromeLayer(),this.done=!0,this.movingPoint=null},t.prototype.createHeightEditPoints=function(){var e=this;this.positions.filter(function(t){return t.isVirtualEditPoint()}).forEach(function(t){return e.removePosition(t)});var t=this.getRealPoints()[0],i=this.getRealPoints()[1],n=Cesium.Cartesian3.lerp(t.getPosition(),i.getPosition(),.5,new Cesium.Cartesian3),o=this.coordinateConverter.bearingToCartesian(t.getPosition(),i.getPosition()),r=Cesium.Math.toRadians(o)-Math.PI/2;this.createMiddleEditablePoint(n,r);var s=Cesium.Math.toRadians(o)+Math.PI/2;this.createMiddleEditablePoint(n,s)},t.prototype.createMiddleEditablePoint=function(t,e){var i=q.pointByLocationDistanceAndAzimuth(t,this.hippodromeProps.width/2,e,!0),n=new di(this.id,i,this.defaultPointProps);n.setVirtualEditPoint(!0),this.positions.push(n)},t.prototype.movePoint=function(t,e){e.isVirtualEditPoint()?this.changeWidthByNewPoint(t):(e.setPosition(t),this.createHeightEditPoints(),this.updatePointsLayer.apply(this,_(this.positions)),this.updateHippdromeLayer())},t.prototype.changeWidthByNewPoint=function(t){var e=this.getRealPoints()[0],i=this.getRealPoints()[1],n=Cesium.Cartesian3.lerp(e.getPosition(),i.getPosition(),.5,new Cesium.Cartesian3),o=this.coordinateConverter.bearingToCartesian(n,t),r=o;270<o?r=o-270:180<o&&(r=o-180);var s=this.coordinateConverter.bearingToCartesian(e.getPosition(),i.getPosition());180<s&&(s=this.coordinateConverter.bearingToCartesian(i.getPosition(),e.getPosition()));var a=r<s?s-r:r-s;270<o&&(a=o-s);var p=Math.abs(q.distance(n,t)),c=Math.sin(Cesium.Math.toRadians(a))*p;this.hippodromeProps.width=2*Math.abs(c),this.createHeightEditPoints(),this.updatePointsLayer.apply(this,_(this.positions)),this.updateHippdromeLayer()},t.prototype.moveShape=function(t,e){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=q.getPositionsDelta(this.lastDraggedToPosition,e);this.getRealPoints().forEach(function(t){q.addDeltaToPosition(t.getPosition(),i,!0)}),this.createHeightEditPoints(),this.updatePointsLayer.apply(this,_(this.positions)),this.updateHippdromeLayer(),this.lastDraggedToPosition=e},t.prototype.endMoveShape=function(){var e=this;this.lastDraggedToPosition=undefined,this.createHeightEditPoints(),this.positions.forEach(function(t){return e.updatePointsLayer(t)}),this.updateHippdromeLayer()},t.prototype.endMovePoint=function(){this.createHeightEditPoints(),this.updatePointsLayer.apply(this,_(this.positions))},t.prototype.moveTempMovingPoint=function(t){this.movingPoint&&this.movePoint(t,this.movingPoint)},t.prototype.removePoint=function(t){var e=this;this.removePosition(t),this.positions.filter(function(t){return t.isVirtualEditPoint()}).forEach(function(t){return e.removePosition(t)})},t.prototype.addLastPoint=function(t){this.done=!0,this.removePosition(this.movingPoint),this.movingPoint=null},t.prototype.getRealPositions=function(){return this.getRealPoints().map(function(t){return t.getPosition()})},t.prototype.getRealPositionsCallbackProperty=function(){return new Cesium.CallbackProperty(this.getRealPositions.bind(this),!1)},t.prototype.getRealPoints=function(){return this.positions.filter(function(t){return!t.isVirtualEditPoint()})},t.prototype.getWidth=function(){return this.hippodromeProps.width},t.prototype.getPositions=function(){return this.positions.map(function(t){return t.getPosition()})},t.prototype.removePosition=function(e){var t=this.positions.findIndex(function(t){return t===e});t<0||(this.positions.splice(t,1),this.pointsLayer.remove(e.getId()))},t.prototype.updatePointsLayer=function(){for(var e=this,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];t.forEach(function(t){return e.pointsLayer.update(t,t.getId())})},t.prototype.updateHippdromeLayer=function(){this.hippodromeLayer.update(this,this.id)},t.prototype.dispose=function(){var e=this;this.hippodromeLayer.remove(this.id),this.positions.forEach(function(t){e.pointsLayer.remove(t.getId())}),this.movingPoint&&(this.pointsLayer.remove(this.movingPoint.getId()),this.movingPoint=undefined),this.positions.length=0},t.prototype.getPointsCount=function(){return this.positions.length},t.prototype.getId=function(){return this.id},t}(le),Hi={addPointEvent:G.LEFT_CLICK,addLastPointEvent:G.LEFT_DOUBLE_CLICK,removePointEvent:G.RIGHT_CLICK,dragPointEvent:G.LEFT_CLICK_DRAG,dragShapeEvent:G.LEFT_CLICK_DRAG,allowDrag:!0,pointProps:{color:Cesium.Color.WHITE.withAlpha(.9),outlineColor:Cesium.Color.BLACK,outlineWidth:1,pixelSize:15,virtualPointPixelSize:8,show:!0,showVirtual:!0},polylineProps:{material:function(){return Cesium.Color.BLACK},width:3}},Bi=function(){function t(){this.updateSubject=new w.Subject,this.updatePublisher=m.publish()(this.updateSubject),this.observablesMap=new Map}return t.prototype.init=function(t,e,i,n){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.polylinesManager=n,this.updatePublisher.connect()},t.prototype.onUpdate=function(){return this.updatePublisher},t.prototype.create=function(t,r){var s=this;void 0===t&&(t=Hi),void 0===r&&(r=100);var a=[],p=gi(),c=this.setOptions(t),l=new w.BehaviorSubject({id:p,editAction:null,editMode:li.CREATE}),u=!1;this.updateSubject.next({id:p,positions:a,editMode:li.CREATE,editAction:ui.INIT,polylineOptions:c});var e=this.mapEventsManager.register({event:G.MOUSE_MOVE,pick:U.NO_PICK,priority:r}),i=this.mapEventsManager.register({event:c.addPointEvent,pick:U.NO_PICK,priority:r}),n=this.mapEventsManager.register({event:c.addLastPointEvent,pick:U.NO_PICK,priority:r});this.observablesMap.set(p,[e,i,n]);var d=this.createEditorObservable(l,p);return e.subscribe(function(t){var e=t.movement.endPosition,i=s.coordinateConverter.screenToCartesian3(e);i&&s.updateSubject.next({id:p,positions:s.getPositions(p),editMode:li.CREATE,updatedPosition:i,editAction:ui.MOUSE_MOVE})}),i.subscribe(function(t){var e=t.movement.endPosition;if(!u){var i=s.coordinateConverter.screenToCartesian3(e);if(i){var n=s.getPositions(p);if(!n.find(function(t){return t.equals(i)})){var o={id:p,positions:n,editMode:li.CREATE,updatedPosition:i,editAction:ui.ADD_POINT};s.updateSubject.next(o),l.next(E({},o,{positions:s.getPositions(p),points:s.getPoints(p)})),c.maximumNumberOfPoints&&n.length+1===c.maximumNumberOfPoints&&(u=s.switchToEditMode(p,i,l,a,r,c,d,u))}}}}),n.subscribe(function(t){var e=t.movement.endPosition,i=s.coordinateConverter.screenToCartesian3(e);i&&(u=s.switchToEditMode(p,i,l,a,r,c,d,u))}),d},t.prototype.switchToEditMode=function(t,e,i,n,o,r,s,a){var p={id:t,positions:this.getPositions(t),editMode:li.CREATE,updatedPosition:e,editAction:ui.ADD_LAST_POINT};this.updateSubject.next(p),i.next(E({},p,{positions:this.getPositions(t),points:this.getPoints(t)}));var c={id:t,editMode:li.CREATE,editAction:ui.CHANGE_TO_EDIT};return this.updateSubject.next(c),i.next(c),this.observablesMap.has(t)&&this.observablesMap.get(t).forEach(function(t){return t.dispose()}),this.observablesMap["delete"](t),this.editPolyline(t,n,o,i,r,s),!0},t.prototype.edit=function(t,e,i){if(void 0===e&&(e=Hi),void 0===i&&(i=100),t.length<2)throw new Error("Polylines editor error edit(): polyline should have at least 2 positions");var n=gi(),o=this.setOptions(e),r=new w.BehaviorSubject({id:n,editAction:null,editMode:li.EDIT}),s={id:n,positions:t,editMode:li.EDIT,editAction:ui.INIT,polylineOptions:o};return this.updateSubject.next(s),r.next(E({},s,{positions:this.getPositions(n),points:this.getPoints(n)})),this.editPolyline(n,t,i,r,o)},t.prototype.editPolyline=function(p,t,e,c,i,n){var o,l=this,r=this.mapEventsManager.register({event:i.dragPointEvent,entityType:di,pick:U.PICK_FIRST,priority:e,pickFilter:function(t){return p===t.editedEntityId}}),s=this.mapEventsManager.register({event:i.removePointEvent,entityType:di,pick:U.PICK_FIRST,priority:e,pickFilter:function(t){return p===t.editedEntityId}});i.allowDrag&&(o=this.mapEventsManager.register({event:i.dragShapeEvent,entityType:hi,pick:U.PICK_FIRST,priority:e,pickFilter:function(t){return p===t.editedEntityId}})),o&&o.pipe(m.tap(function(t){var e=t.movement.drop;return l.cameraService.enableInputs(e)})).subscribe(function(t){var e=t.movement,i=e.startPosition,n=e.endPosition,o=e.drop,r=(t.entities,l.coordinateConverter.screenToCartesian3(n)),s=l.coordinateConverter.screenToCartesian3(i);if(r){var a={id:p,positions:l.getPositions(p),editMode:li.EDIT,updatedPosition:r,draggedPosition:s,editAction:o?ui.DRAG_SHAPE_FINISH:ui.DRAG_SHAPE};l.updateSubject.next(a),c.next(E({},a,{positions:l.getPositions(p),points:l.getPoints(p)}))}}),r.pipe(m.tap(function(t){var e=t.movement.drop;return l.cameraService.enableInputs(e)})).subscribe(function(t){var e=t.movement,i=e.endPosition,n=e.drop,o=t.entities,r=l.coordinateConverter.screenToCartesian3(i);if(r){var s=o[0],a={id:p,positions:l.getPositions(p),editMode:li.EDIT,updatedPosition:r,updatedPoint:s,editAction:n?ui.DRAG_POINT_FINISH:ui.DRAG_POINT};l.updateSubject.next(a),c.next(E({},a,{positions:l.getPositions(p),points:l.getPoints(p)}))}}),s.subscribe(function(t){var e=t.entities[0],i=_(l.getPositions(p));if(!(i.length<3)&&!(i.findIndex(function(t){return e.getPosition().equals(t)})<0)){var n={id:p,positions:i,editMode:li.EDIT,updatedPoint:e,editAction:ui.REMOVE_POINT};l.updateSubject.next(n),c.next(E({},n,{positions:l.getPositions(p),points:l.getPoints(p)}))}});var a=[r,s];return o&&a.push(o),this.observablesMap.set(p,a),this.createEditorObservable(c,p)},t.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Hi)),i=Object.assign(e,t);return i.pointProps=Object.assign({},Hi.pointProps,t.pointProps),i.polylineProps=Object.assign({},Hi.polylineProps,t.polylineProps),i},t.prototype.createEditorObservable=function(t,i){var n=this;return t.dispose=function(){var t=n.observablesMap.get(i);t&&t.forEach(function(t){return t.dispose()}),n.observablesMap["delete"](i),n.updateSubject.next({id:i,positions:n.getPositions(i),editMode:li.CREATE_OR_EDIT,editAction:ui.DISPOSE})},t.enable=function(){n.updateSubject.next({id:i,positions:n.getPositions(i),editMode:li.EDIT,editAction:ui.ENABLE})},t.disable=function(){n.updateSubject.next({id:i,positions:n.getPositions(i),editMode:li.EDIT,editAction:ui.DISABLE})},t.setManually=function(t,e){n.polylinesManager.get(i).setManually(t,e),n.updateSubject.next({id:i,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_MANUALLY})},t.setLabelsRenderFn=function(t){n.updateSubject.next({id:i,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:t})},t.updateLabels=function(t){n.updateSubject.next({id:i,editMode:li.CREATE_OR_EDIT,editAction:ui.UPDATE_EDIT_LABELS,updateLabels:t})},t.getCurrentPoints=function(){return n.getPoints(i)},t.getEditValue=function(){return t.getValue()},t.getLabels=function(){return n.polylinesManager.get(i).labels},t},t.prototype.getPositions=function(t){return this.polylinesManager.get(t).getRealPositions()},t.prototype.getPoints=function(t){return this.polylinesManager.get(t).getRealPoints()},t.decorators=[{type:a.Injectable}],t}(),Gi=function(){function t(){this.polylines=new Map}return t.prototype.createEditablePolyline=function(t,e,i,n,o,r){var s=new Oi(t,e,i,n,o,r);this.polylines.set(t,s)},t.prototype.get=function(t){return this.polylines.get(t)},t.prototype.clear=function(){this.polylines.forEach(function(t){return t.dispose()}),this.polylines.clear()},t.decorators=[{type:a.Injectable}],t}(),Ui=function(){function t(t,e,i,n,o){this.polylinesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.polylinesManager=o,this.Cesium=Cesium,this.editPoints$=new w.Subject,this.editPolylines$=new w.Subject,this.polylineLabels$=new w.Subject,this.polylinesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,o),this.startListeningToEditorUpdates()}return t.prototype.startListeningToEditorUpdates=function(){var e=this;this.polylinesEditor.onUpdate().subscribe(function(t){t.editMode===li.CREATE||t.editMode===li.CREATE_OR_EDIT?e.handleCreateUpdates(t):t.editMode===li.EDIT&&e.handleEditUpdates(t)})},t.prototype.getLabelId=function(t,e){return e.toString()},t.prototype.renderEditLabels=function(t,e,i){if(e.positions=t.getRealPositions(),e.points=t.getRealPoints(),i)return t.labels=i,void this.polylineLabelsLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.polylineLabelsLayer.update(t,t.getId()))},t.prototype.removeEditLabels=function(t){t.labels=[],this.polylineLabelsLayer.remove(t.getId())},t.prototype.handleCreateUpdates=function(t){switch(t.editAction){case ui.INIT:this.polylinesManager.createEditablePolyline(t.id,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,t.polylineOptions);break;case ui.MOUSE_MOVE:var e=this.polylinesManager.get(t.id);t.updatedPosition&&(e.moveTempMovingPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.ADD_POINT:e=this.polylinesManager.get(t.id);t.updatedPosition&&(e.addPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.ADD_LAST_POINT:e=this.polylinesManager.get(t.id);t.updatedPosition&&(e.addLastPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DISPOSE:(e=this.polylinesManager.get(t.id)).dispose(),this.removeEditLabels(e),this.editLabelsRenderFn=undefined;break;case ui.SET_EDIT_LABELS_RENDER_CALLBACK:e=this.polylinesManager.get(t.id);this.editLabelsRenderFn=t.labelsRenderFn,this.renderEditLabels(e,t);break;case ui.UPDATE_EDIT_LABELS:case ui.SET_MANUALLY:e=this.polylinesManager.get(t.id);this.renderEditLabels(e,t,t.updateLabels);break;default:return}},t.prototype.handleEditUpdates=function(t){switch(t.editAction){case ui.INIT:this.polylinesManager.createEditablePolyline(t.id,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,t.polylineOptions,t.positions);break;case ui.DRAG_POINT:(e=this.polylinesManager.get(t.id))&&e.enableEdit&&(e.movePoint(t.updatedPosition,t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DRAG_POINT_FINISH:(e=this.polylinesManager.get(t.id))&&e.enableEdit&&t.updatedPoint.isVirtualEditPoint()&&(e.changeVirtualPointToRealPoint(t.updatedPoint),this.renderEditLabels(e,t));break;case ui.REMOVE_POINT:(e=this.polylinesManager.get(t.id))&&e.enableEdit&&(e.removePoint(t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DISABLE:(e=this.polylinesManager.get(t.id))&&(e.enableEdit=!1,this.renderEditLabels(e,t));break;case ui.ENABLE:(e=this.polylinesManager.get(t.id))&&(e.enableEdit=!0,this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE:(e=this.polylinesManager.get(t.id))&&e.enableEdit&&(e.moveShape(t.draggedPosition,t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE_FINISH:var e;(e=this.polylinesManager.get(t.id))&&e.enableEdit&&(e.endMoveShape(),this.renderEditLabels(e,t));break;default:return}},t.prototype.ngOnDestroy=function(){this.polylinesManager.clear()},t.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},t.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},t.decorators=[{type:a.Component,args:[{selector:"polylines-editor",template:'\n    <ac-layer #editPolylinesLayer acFor="let polyline of editPolylines$" [context]="this">\n      <ac-polyline-primitive-desc\n        props="{\n        positions: polyline.getPositions(),\n        width: polyline.props.width,\n        material: polyline.props.material()\n    }"\n      >\n      </ac-polyline-primitive-desc>\n    </ac-layer>\n\n    <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPosition(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point)\n    }"\n      >\n      </ac-point-desc>\n    </ac-layer>\n\n    <ac-layer #polylineLabelsLayer acFor="let polylineLabels of polylineLabels$" [context]="this">\n      <ac-array-desc acFor="let label of polylineLabels.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n  ',providers:[$,Gi],changeDetection:a.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:Bi},{type:$},{type:bt},{type:v},{type:Gi}]},t.propDecorators={editPointsLayer:[{type:a.ViewChild,args:["editPointsLayer"]}],editPolylinesLayer:[{type:a.ViewChild,args:["editPolylinesLayer"]}],polylineLabelsLayer:[{type:a.ViewChild,args:["polylineLabelsLayer"]}]},t}(),zi=function(){function t(){this.hippodromes=new Map}return t.prototype.createEditableHippodrome=function(t,e,i,n,o,r){var s=new Vi(t,e,i,n,o,r);this.hippodromes.set(t,s)},t.prototype.get=function(t){return this.hippodromes.get(t)},t.prototype.clear=function(){this.hippodromes.forEach(function(t){return t.dispose()}),this.hippodromes.clear()},t.decorators=[{type:a.Injectable}],t}(),Ki={addPointEvent:G.LEFT_CLICK,dragPointEvent:G.LEFT_CLICK_DRAG,dragShapeEvent:G.LEFT_CLICK_DRAG,allowDrag:!0,hippodromeProps:{material:Cesium.Color.GREEN.withAlpha(.5),width:2e5,outline:!1},pointProps:{color:Cesium.Color.WHITE.withAlpha(.9),outlineColor:Cesium.Color.BLACK,outlineWidth:1,pixelSize:15,virtualPointPixelSize:8,show:!0,showVirtual:!0}},Wi=function(){function t(){this.updateSubject=new w.Subject,this.updatePublisher=m.publish()(this.updateSubject),this.observablesMap=new Map}return t.prototype.init=function(t,e,i,n){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.hippodromeManager=n,this.updatePublisher.connect()},t.prototype.onUpdate=function(){return this.updatePublisher},t.prototype.create=function(t,a){var p=this;void 0===t&&(t=Ki),void 0===a&&(a=100);var c=gi(),l=this.setOptions(t),u=new w.BehaviorSubject({id:c,editAction:null,editMode:li.CREATE}),d=!1;this.updateSubject.next({id:c,positions:[],editMode:li.CREATE,editAction:ui.INIT,hippodromeOptions:l});var e=this.mapEventsManager.register({event:G.MOUSE_MOVE,pick:U.NO_PICK,priority:a}),i=this.mapEventsManager.register({event:l.addPointEvent,pick:U.NO_PICK,priority:a});this.observablesMap.set(c,[e,i]);var h=this.createEditorObservable(u,c);return e.subscribe(function(t){var e=t.movement.endPosition,i=p.coordinateConverter.screenToCartesian3(e);i&&p.updateSubject.next({id:c,positions:p.getPositions(c),editMode:li.CREATE,updatedPosition:i,editAction:ui.MOUSE_MOVE})}),i.subscribe(function(t){var e=t.movement.endPosition;if(!d){var i=p.coordinateConverter.screenToCartesian3(e);if(i){var n=p.getPositions(c),o=0===p.getPositions(c).length,r={id:c,positions:n,editMode:li.CREATE,updatedPosition:i,editAction:ui.ADD_POINT};if(p.updateSubject.next(r),u.next(E({},r,{positions:p.getPositions(c),points:p.getPoints(c),width:p.getWidth(c)})),!o){var s={id:c,editMode:li.CREATE,editAction:ui.CHANGE_TO_EDIT};p.updateSubject.next(s),u.next(s),p.observablesMap.has(c)&&p.observablesMap.get(c).forEach(function(t){return t.dispose()}),p.observablesMap["delete"](c),p.editHippodrome(c,a,u,l,h),d=!0}}}}),h},t.prototype.edit=function(t,e,i){if(void 0===e&&(e=Ki),void 0===i&&(i=100),2!==t.length)throw new Error("Hippodrome editor error edit(): polygon should have 2 positions but received "+t);var n=gi(),o=this.setOptions(e),r=new w.BehaviorSubject({id:n,editAction:null,editMode:li.EDIT}),s={id:n,positions:t,editMode:li.EDIT,editAction:ui.INIT,hippodromeOptions:o};return this.updateSubject.next(s),r.next(E({},s,{positions:this.getPositions(n),points:this.getPoints(n),width:this.getWidth(n)})),this.editHippodrome(n,i,r,o)},t.prototype.editHippodrome=function(p,t,c,e,i){var n,l=this;e.allowDrag&&(n=this.mapEventsManager.register({event:e.dragShapeEvent,entityType:Vi,pick:U.PICK_FIRST,priority:t,pickFilter:function(t){return p===t.id}}));var o=this.mapEventsManager.register({event:e.dragPointEvent,entityType:di,pick:U.PICK_FIRST,priority:t,pickFilter:function(t){return p===t.editedEntityId}});o.pipe(m.tap(function(t){var e=t.movement.drop;return l.cameraService.enableInputs(e)})).subscribe(function(t){var e=t.movement,i=e.endPosition,n=e.drop,o=t.entities,r=l.coordinateConverter.screenToCartesian3(i);if(r){var s=o[0],a={id:p,positions:l.getPositions(p),editMode:li.EDIT,updatedPosition:r,updatedPoint:s,editAction:n?ui.DRAG_POINT_FINISH:ui.DRAG_POINT};l.updateSubject.next(a),c.next(E({},a,{positions:l.getPositions(p),points:l.getPoints(p),width:l.getWidth(p)}))}}),n&&n.pipe(m.tap(function(t){var e=t.movement.drop;return l.cameraService.enableInputs(e)})).subscribe(function(t){var e=t.movement,i=e.startPosition,n=e.endPosition,o=e.drop,r=(t.entities,l.coordinateConverter.screenToCartesian3(n)),s=l.coordinateConverter.screenToCartesian3(i);if(r){var a={id:p,positions:l.getPositions(p),editMode:li.EDIT,updatedPosition:r,draggedPosition:s,editAction:o?ui.DRAG_SHAPE_FINISH:ui.DRAG_SHAPE};l.updateSubject.next(a),c.next(E({},a,{positions:l.getPositions(p),points:l.getPoints(p),width:l.getWidth(p)}))}});var r=[o];return n&&r.push(n),this.observablesMap.set(p,r),this.createEditorObservable(c,p)},t.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Ki)),i=Object.assign(e,t);return i.hippodromeProps=Object.assign({},Ki.hippodromeProps,t.hippodromeProps),i.pointProps=Object.assign({},Ki.pointProps,t.pointProps),i},t.prototype.createEditorObservable=function(t,a){var p=this;return t.dispose=function(){var t=p.observablesMap.get(a);t&&t.forEach(function(t){return t.dispose()}),p.observablesMap["delete"](a),p.updateSubject.next({id:a,positions:p.getPositions(a),editMode:li.CREATE_OR_EDIT,editAction:ui.DISPOSE})},t.enable=function(){p.updateSubject.next({id:a,positions:p.getPositions(a),editMode:li.EDIT,editAction:ui.ENABLE})},t.disable=function(){p.updateSubject.next({id:a,positions:p.getPositions(a),editMode:li.EDIT,editAction:ui.DISABLE})},t.setManually=function(t,e,i,n,o){var r=new di(a,t,n||Ki.pointProps),s=new di(a,e,o||Ki.pointProps);p.hippodromeManager.get(a).setPointsManually([r,s],i),p.updateSubject.next({id:a,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_MANUALLY})},t.setLabelsRenderFn=function(t){p.updateSubject.next({id:a,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:t})},t.updateLabels=function(t){p.updateSubject.next({id:a,editMode:li.CREATE_OR_EDIT,editAction:ui.UPDATE_EDIT_LABELS,updateLabels:t})},t.getCurrentPoints=function(){return p.getPoints(a)},t.getEditValue=function(){return t.getValue()},t.getLabels=function(){return p.hippodromeManager.get(a).labels},t.getCurrentWidth=function(){return p.getWidth(a)},t},t.prototype.getPositions=function(t){return this.hippodromeManager.get(t).getRealPositions()},t.prototype.getPoints=function(t){return this.hippodromeManager.get(t).getRealPoints()},t.prototype.getWidth=function(t){return this.hippodromeManager.get(t).getWidth()},t.decorators=[{type:a.Injectable}],t}(),$i=function(){function t(t,e,i,n,o){this.hippodromesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.hippodromesManager=o,this.Cesium=Cesium,this.editPoints$=new w.Subject,this.editHippodromes$=new w.Subject,this.hippodromesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,o),this.startListeningToEditorUpdates()}return t.prototype.startListeningToEditorUpdates=function(){var e=this;this.hippodromesEditor.onUpdate().subscribe(function(t){t.editMode===li.CREATE||t.editMode===li.CREATE_OR_EDIT?e.handleCreateUpdates(t):t.editMode===li.EDIT&&e.handleEditUpdates(t)})},t.prototype.getLabelId=function(t,e){return e.toString()},t.prototype.renderEditLabels=function(t,e,i){if(e.positions=t.getRealPositions(),e.points=t.getRealPoints(),i)return t.labels=i,void this.editHippodromesLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editHippodromesLayer.update(t,t.getId()))},t.prototype.removeEditLabels=function(t){t.labels=[],this.editHippodromesLayer.update(t,t.getId())},t.prototype.handleCreateUpdates=function(t){switch(t.editAction){case ui.INIT:this.hippodromesManager.createEditableHippodrome(t.id,this.editPointsLayer,this.editHippodromesLayer,this.coordinateConverter,t.hippodromeOptions);break;case ui.MOUSE_MOVE:var e=this.hippodromesManager.get(t.id);t.updatedPosition&&(e.moveTempMovingPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.ADD_POINT:e=this.hippodromesManager.get(t.id);t.updatedPosition&&(e.addPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DISPOSE:(e=this.hippodromesManager.get(t.id)).dispose(),this.removeEditLabels(e);break;case ui.SET_EDIT_LABELS_RENDER_CALLBACK:e=this.hippodromesManager.get(t.id);this.editLabelsRenderFn=t.labelsRenderFn,this.renderEditLabels(e,t);break;case ui.UPDATE_EDIT_LABELS:case ui.SET_MANUALLY:e=this.hippodromesManager.get(t.id);this.renderEditLabels(e,t,t.updateLabels);break;default:return}},t.prototype.handleEditUpdates=function(t){switch(t.editAction){case ui.INIT:this.hippodromesManager.createEditableHippodrome(t.id,this.editPointsLayer,this.editHippodromesLayer,this.coordinateConverter,t.hippodromeOptions,t.positions);break;case ui.DRAG_POINT:(e=this.hippodromesManager.get(t.id))&&e.enableEdit&&(e.movePoint(t.updatedPosition,t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DRAG_POINT_FINISH:(e=this.hippodromesManager.get(t.id))&&e.enableEdit&&(e.endMovePoint(),this.renderEditLabels(e,t));break;case ui.DISABLE:(e=this.hippodromesManager.get(t.id))&&(e.enableEdit=!1,this.renderEditLabels(e,t));break;case ui.ENABLE:(e=this.hippodromesManager.get(t.id))&&(e.enableEdit=!0,this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE:(e=this.hippodromesManager.get(t.id))&&e.enableEdit&&(e.moveShape(t.draggedPosition,t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE_FINISH:var e;(e=this.hippodromesManager.get(t.id))&&e.enableEdit&&(e.endMoveShape(),this.renderEditLabels(e,t));break;default:return}},t.prototype.ngOnDestroy=function(){this.hippodromesManager.clear()},t.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},t.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},t.decorators=[{type:a.Component,args:[{selector:"hippodrome-editor",template:'\n    <ac-layer #editHippodromesLayer acFor="let hippodrome of editHippodromes$" [context]="this">\n      <ac-corridor-desc\n        props="{\n\t\tpositions: hippodrome.getRealPositionsCallbackProperty(),\n\t\tcornerType: Cesium.CornerType.ROUNDED,\n\t\tmaterial: hippodrome.hippodromeProps.material,\n\t\twidth : hippodrome.hippodromeProps.width,\n\t\toutline: hippodrome.hippodromeProps.outline,\n\t\toutlineColor: hippodrome.hippodromeProps.outlineColor,\n        outlineWidth: hippodrome.hippodromeProps.outlineWidth,\n        height: 0\n\t}"\n      >\n      </ac-corridor-desc>\n\n      <ac-array-desc acFor="let label of hippodrome.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n\n    <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPosition(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point)\n    }"\n      >\n      </ac-point-desc>\n    </ac-layer>\n  ',providers:[$,zi],changeDetection:a.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:Wi},{type:$},{type:bt},{type:v},{type:zi}]},t.propDecorators={editPointsLayer:[{type:a.ViewChild,args:["editPointsLayer"]}],editHippodromesLayer:[{type:a.ViewChild,args:["editHippodromesLayer"]}]},t}(),Zi=function(){function t(t,e){this.document=t,this.mapsManager=e,this.mainSubject=new w.Subject}return t.prototype.setCoordinateConverter=function(t){this.coordinateConverter=t},t.prototype.drag=function(t,e){var i=this;if(!this.coordinateConverter){var n=this.mapsManager.getMap();n&&(this.coordinateConverter=n.getCoordinateConverter())}this.cancel();var o=document.createElement("img");o.src=t,o.style.position="fixed",o.style.visibility="hidden",o.style.width="30px",o.style.height="30px",o.style["user-drag"]="none",o.style["user-select"]="none",o.style["-moz-user-select"]="none",o.style["-webkit-user-drag"]="none",o.style["-webkit-user-select"]="none",o.style["-ms-user-select"]="none",Object.assign(o.style,e),document.body.appendChild(o),this.createDragObservable(),this.dragObservable.subscribe(function(t){o.style.visibility="visible",o.style.left=t.screenPosition.x-o.clientWidth/2+"px",o.style.top=t.screenPosition.y-o.clientHeight/2+"px",i.mainSubject.next(t),t.drop&&o.remove()},function(t){o.remove()},function(){o.remove()})},t.prototype.dragUpdates=function(){return this.mainSubject},t.prototype.cancel=function(){this.stopper&&(this.stopper.next(!0),this.stopper=undefined,this.dragObservable=undefined)},t.prototype.createDragObservable=function(){var e,i,n,o=this,t=new w.Subject,r=new w.Subject,s=w.fromEvent(document,"pointerup"),a=w.fromEvent(document,"pointermove").pipe(m.map(function(t){return e=e||t.x,i=i||t.y,n={drop:!1,initialScreenPosition:{x:e,y:i},screenPosition:{x:t.x,y:t.y},mapPosition:o.coordinateConverter?o.coordinateConverter.screenToCartesian3({x:t.x,y:t.y}):undefined}}),m.takeUntil(s),m.tap(undefined,undefined,function(){if(n){var t=Object.assign({},n);t.drop=!0,r.next(t)}}));this.dragObservable=a.pipe(m.merge(r),m.takeUntil(t)),this.stopper=t},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:undefined,decorators:[{type:a.Inject,args:[s.DOCUMENT]}]},{type:Ct}]},t}(),Yi=function(){function t(t,e){this.iconDragService=e,t.nativeElement.style["user-drag"]="none",t.nativeElement.style["user-select"]="none",t.nativeElement.style["-moz-user-select"]="none",t.nativeElement.style["-webkit-user-drag"]="none",t.nativeElement.style["-webkit-user-select"]="none",t.nativeElement.style["-ms-user-select"]="none"}return t.prototype.ngOnInit=function(){"string"==typeof this.draggableToMap?this.src=this.draggableToMap:(this.src=this.draggableToMap.src,this.style=this.draggableToMap.style)},t.prototype.onMouseDown=function(){this.iconDragService.drag(this.src,this.style)},t.decorators=[{type:a.Directive,args:[{selector:"[draggableToMap]"}]}],t.ctorParameters=function(){return[{type:a.ElementRef},{type:Zi}]},t.propDecorators={draggableToMap:[{type:a.Input}],onMouseDown:[{type:a.HostListener,args:["mousedown"]}]},t}(),qi=function(){function t(t,e){this.element=t,this.cesiumService=e,this.allowDrag=!0,this.onDrag=new a.EventEmitter,this.dragStyle={"height.px":20,"width.px":20}}return t.prototype.ngOnInit=function(){this.cesiumService.getMap().getMapContainer().appendChild(this.element.nativeElement),this.allowDrag&&this.listenForDragging()},t.prototype.ngOnChanges=function(t){t.allowDrag&&t.allowDrag.currentValue&&!t.allowDrag.previousValue&&this.listenForDragging(),t.allowDrag&&!t.allowDrag.currentValue&&t.allowDrag.previousValue&&this.dragSubscription.unsubscribe()},t.prototype.ngOnDestroy=function(){this.dragSubscription&&this.dragSubscription.unsubscribe()},t.prototype.listenForDragging=function(){var e=this;this.mouseDown$=this.mouseDown$||w.fromEvent(this.element.nativeElement,"mousedown"),this.mouseMove$=this.mouseMove$||w.fromEvent(document,"mousemove"),this.mouseUp$=this.mouseUp$||w.fromEvent(document,"mouseup"),this.drag$=this.drag$||this.mouseDown$.pipe(m.switchMap(function(){return e.mouseMove$.pipe(m.tap(e.onDrag.emit),m.takeUntil(e.mouseUp$))})),this.dragSubscription=this.drag$.subscribe(function(t){e.element.nativeElement.style.left=t.x+"px",e.element.nativeElement.style.top=t.y+"px"})},t.decorators=[{type:a.Component,args:[{selector:"ac-toolbar",template:'\n        <div class="{{toolbarClass}}">\n            <div *ngIf="allowDrag">\n                <ac-toolbar-button>\n                    <ac-drag-icon></ac-drag-icon>\n                </ac-toolbar-button>\n            </div>\n\n            <ng-content></ng-content>\n        </div>\n    ',changeDetection:a.ChangeDetectionStrategy.OnPush,styles:["\n        :host {\n            position: absolute;\n            top: 20px;\n            left: 20px;\n            width: 20px;\n            height: 20px;\n            z-index: 999;\n            -webkit-user-drag: none;\n        }\n    "]}]}],t.ctorParameters=function(){return[{type:a.ElementRef},{type:B}]},t.propDecorators={toolbarClass:[{type:a.Input}],allowDrag:[{type:a.Input}],onDrag:[{type:a.Output}]},t}(),Xi=function(){function t(){}return t.decorators=[{type:a.Component,args:[{selector:"ac-drag-icon",template:'\n        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg"  x="0px" y="0px"  height="25"  width="25"\n\t viewBox="0 0 476.737 476.737" style="enable-background:new 0 0 476.737 476.737;" xml:space="preserve">\n<g>\n\t<g>\n\t\t<path style="fill:#010002;" d="M475.498,232.298l-3.401-5.149l-63.565-63.565c-6.198-6.198-16.304-6.198-22.47,0\n\t\t\tc-6.198,6.198-6.198,16.273,0,22.47l36.423,36.423H254.26V54.253l36.423,36.423c6.166,6.198,16.273,6.198,22.47,0\n\t\t\tc6.166-6.198,6.166-16.273,0-22.47L249.588,4.64l-0.159-0.095l-4.99-3.305L238.369,0h-0.064l-6.007,1.24l-4.99,3.305l-0.191,0.095\n\t\t\tl-63.565,63.565c-6.198,6.198-6.198,16.273,0,22.47s16.273,6.198,22.47,0l36.455-36.423v168.225H54.253l36.423-36.423\n\t\t\tc6.198-6.198,6.198-16.273,0-22.47s-16.273-6.198-22.47,0L4.64,227.149l-0.095,0.159l-3.305,4.99L0,238.369v0.064l1.24,6.007\n\t\t\tl3.305,4.958l0.095,0.191l63.565,63.565c6.198,6.198,16.273,6.198,22.47,0c6.198-6.166,6.198-16.273,0-22.47L54.253,254.26\n\t\t\th168.225v168.225l-36.423-36.423c-6.198-6.166-16.273-6.166-22.47,0c-6.198,6.198-6.198,16.304,0,22.47l63.565,63.565l5.149,3.432\n\t\t\tl6.007,1.208h0.064l6.07-1.24l5.149-3.401l63.565-63.565c6.166-6.198,6.166-16.304,0-22.47c-6.198-6.198-16.304-6.198-22.47,0\n\t\t\tl-36.423,36.423V254.26h168.225l-36.423,36.423c-6.166,6.166-6.166,16.273,0,22.47c6.198,6.166,16.304,6.166,22.47,0\n\t\t\tl63.565-63.565l3.432-5.149l1.208-6.007v-0.064L475.498,232.298z"/>\n\t</g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n</svg>\n    '}]}],t.ctorParameters=function(){return[]},t}(),Ji=function(){function t(){this.onClick=new a.EventEmitter}return t.prototype.ngOnInit=function(){},t.decorators=[{type:a.Component,args:[{selector:"ac-toolbar-button",template:'\n        <div (click)="onClick.emit()" class="button-container {{buttonClass}}">\n            <img *ngIf="iconUrl" [src]="iconUrl" class="icon {{iconClass}}"/>\n            <ng-content></ng-content>\n        </div>\n    ',changeDetection:a.ChangeDetectionStrategy.OnPush,styles:["\n        .button-container {\n            border-radius: 1px;\n            background-color: rgba(255, 255, 255, 0.8);\n            height: 30px;\n            width: 30px;\n            padding: 5px;\n            transition: all 0.2s;\n            cursor: pointer;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            flex-direction: column;\n        }\n\n        .button-container:hover {\n            background-color: rgba(255, 255, 255, 0.95);\n        }\n\n        .icon {\n            height: 30px;\n            width: 30px;\n        }\n    "]}]}],t.ctorParameters=function(){return[]},t.propDecorators={iconUrl:[{type:a.Input}],buttonClass:[{type:a.Input}],iconClass:[{type:a.Input}],onClick:[{type:a.Output}]},t}(),Qi=function(){function t(t,e){this.polylineEditor=t,this.coordinateConverter=e,this.lineEditOptions={},this.labelsStyle={},this.distanceLabelsStyle={},this.bearingLabelsStyle={}}return t.prototype.create=function(t){var p=this,e=void 0===t?{lineEditOptions:{},labelsStyle:{},distanceLabelsStyle:{},bearingLabelsStyle:{}}:t,i=e.lineEditOptions,n=void 0===i?{}:i,o=e.labelsStyle,c=void 0===o?{}:o,r=e.distanceLabelsStyle,l=void 0===r?{}:r,s=e.bearingLabelsStyle,u=void 0===s?{}:s,d=e.bearingStringFn,h=e.distanceStringFn,a=e.labelsRenderFn,y=this.polylineEditor.create(E({allowDrag:!1,pointProps:{showVirtual:!1,pixelSize:8},polylineProps:{width:2}},this.lineEditOptions,n));return a?y.setLabelsRenderFn(a):this.labelsRenderFn?y.setLabelsRenderFn(this.labelsRenderFn):y.setLabelsRenderFn(function(t){var e=t.positions,a=0;return e&&0!==e.length?(t.editMode===li.CREATE&&t.editAction!==ui.ADD_LAST_POINT?_(e,[t.updatedPosition]):e).reduce(function(t,e,i,n){if(0!==i){var o=n[i-1],r=p.coordinateConverter.bearingToCartesian(o,e),s=Cesium.Cartesian3.distance(o,e)/1e3;t.push(E({text:d&&d(r)||p.bearingStringFn&&p.bearingStringFn(r)||r.toFixed(2)+"°",scale:.2,font:"80px Helvetica",pixelOffset:new Cesium.Cartesian2(-20,-8),position:new Cesium.Cartesian3((e.x+o.x)/2,(e.y+o.y)/2,(e.z+o.z)/2),fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.WHITE,showBackground:!0},p.labelsStyle,c,p.bearingLabelsStyle,u),E({text:h&&h(a+s)||p.distanceStringFn&&p.distanceStringFn(a+s)||(a+s).toFixed(2)+" Km",scale:.2,font:"80px Helvetica",pixelOffset:new Cesium.Cartesian2(-35,-8),position:e,fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.WHITE,showBackground:!0},p.labelsStyle,c,p.distanceLabelsStyle,l)),a+=s}return t},[E({text:h&&h(0)||p.distanceStringFn&&p.distanceStringFn(0)||"0 Km",scale:.2,font:"80px Helvetica",pixelOffset:new Cesium.Cartesian2(-20,-8),position:e[0],fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.WHITE,showBackground:!0},p.labelsStyle,c,p.distanceLabelsStyle,l)]):[]}),y},t.decorators=[{type:a.Component,args:[{selector:"range-and-bearing",template:"\n    <polylines-editor></polylines-editor>\n  ",changeDetection:a.ChangeDetectionStrategy.OnPush,providers:[Bi]}]}],t.ctorParameters=function(){return[{type:Bi},{type:$}]},t.propDecorators={lineEditOptions:[{type:a.Input}],labelsStyle:[{type:a.Input}],distanceLabelsStyle:[{type:a.Input}],bearingLabelsStyle:[{type:a.Input}],bearingStringFn:[{type:a.Input}],distanceStringFn:[{type:a.Input}],labelsRenderFn:[{type:a.Input}]},t}(),tn={LEFT:0,MIDDLE:1,RIGHT:2};tn[tn.LEFT]="LEFT",tn[tn.MIDDLE]="MIDDLE",tn[tn.RIGHT]="RIGHT";var en=function(){function t(t,e,i){this.mapsManager=t,this.mapsZoomElements=new Map,this.defaultOptions={animationDurationInSeconds:.5,resetKeyCode:27,borderStyle:"2px solid rgba(0,0,0,0.5)",backgroundColor:"rgba(0,0,0,0.2)",autoDisableOnZoom:!0,threshold:9,keepRotation:!0,mouseButton:tn.LEFT}}return t.prototype.init=function(t,e){this.cameraService=e,this.cesiumService=t},t.prototype.activate=function(o,i){var n=this;if(void 0===o&&(o={}),!(this.cameraService&&this.cesiumService||i))throw new Error("The function must receive a mapId if the service wasn't initialized");var t,r,s=Object.assign({},this.defaultOptions,o),a=this.cameraService;if(this.cesiumService&&(t=this.cesiumService.getViewer().container,r=this.cesiumService.getMap()),i){if(!(r=this.mapsManager.getMap(i)))throw new Error("Map not found with id: "+i);a=r.getCameraService(),t=r.getCesiumViewer().container}if(!a||!t)throw new Error("The function must receive a mapId if the service wasn't initialized");this.disable(i);var p=document.createElement("div");t.style.position="relative",p.style.position="absolute",p.style.width="100%",p.style.height="100%",p.style.top="0",p.style.left="0",t.appendChild(p);var c={container:p};this.mapsZoomElements.set(i||this.cesiumService.getMap().getId(),c);var l,u={endX:0,endY:0,startX:0,startY:0};p.onmousedown=function(t){if(t.button===s.mouseButton&&!l){o&&o.onStart&&o.onStart(r);var e=t.currentTarget.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;u.startX=i,u.startY=n,(l=document.createElement("div")).className="zoom-to-rectangle-border",l.style.position="absolute",l.style.border=s.borderStyle,l.style.backgroundColor=s.backgroundColor,l.style.left=u.startX+"px",l.style.top=u.startY+"px",p.appendChild(l),c.borderElement=l}},p.onmouseup=function(t){if(l){var e=void 0;u&&Math.abs(u.endX-u.startX)*Math.abs(u.endY-u.startY)>s.threshold&&(e=n.zoomCameraToRectangle(a,u,s.animationDurationInSeconds,s)),l.remove(),l=undefined,c.borderElement=undefined,u={endX:0,endY:0,startX:0,startY:0},s.onComplete&&s.onComplete(r),s.autoDisableOnZoom&&e&&n.disable(i)}},p.onmousemove=function(t){if(l){var e=t.currentTarget.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;u.endX=i,u.endY=n,l.style.width=Math.abs(u.endX-u.startX)+"px",l.style.height=Math.abs(u.endY-u.startY)+"px",l.style.left=Math.min(u.startX,u.endX)+"px",l.style.top=Math.min(u.startY,u.endY)+"px"}};var e=function(t){t.keyCode===s.resetKeyCode&&l&&(l.remove(),l=undefined,c.borderElement=undefined,u={endX:0,endY:0,startX:0,startY:0})};document.addEventListener("keydown",e),c.resetOnEscapePressFunc=e},t.prototype.disable=function(t){if(!this.cesiumService&&!t)throw new Error("If the service was not initialized with CesiumService, mapId must be provided");var e=this.mapsZoomElements.get(t||this.cesiumService.getMap().getId());e&&(e.container.remove(),e.borderElement&&e.borderElement.remove(),e.resetOnEscapePressFunc&&document.removeEventListener("keydown",e.resetOnEscapePressFunc)),this.mapsZoomElements["delete"](t)},t.prototype.zoomCameraToRectangle=function(t,e,i,n){var o=t.getCamera(),r=o.pickEllipsoid({x:e.startX,y:e.startY}),s=o.pickEllipsoid({x:e.endX,y:e.endY});if(!r||!s)return!1;var a=Cesium.Cartographic.fromCartesian(r),p=Cesium.Cartographic.fromCartesian(s);return t.cameraFlyTo({destination:new Cesium.Rectangle(Math.min(a.longitude,p.longitude),Math.min(a.latitude,p.latitude),Math.max(a.longitude,p.longitude),Math.max(a.latitude,p.latitude)),orientation:n.keepRotation?{heading:o.heading}:undefined,duration:i}),!0},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:Ct},{type:v,decorators:[{type:a.Optional}]},{type:B,decorators:[{type:a.Optional}]}]},t}(),nn=function(){function t(){}return t.decorators=[{type:a.NgModule,args:[{imports:[s.CommonModule,ri],declarations:[$i,bi,Ii,Ti,Ui,Yi,Xi,qi,Ji,Qi],exports:[$i,bi,Ii,Ti,Ui,Yi,qi,Ji,Qi],providers:[Zi,en]}]}],t}();t.AngularCesiumModule=ri,t.AcEntity=le,t.AcNotification=ue,t.ActionType=It,t.MapLayerProviderOptions=de,t.SceneMode=g,t.KeyboardAction=ct,t.AcMapComponent=St,t.AcLayerComponent=Zt,t.AcArcDescComponent=ce,t.AcBillboardComponent=qt,t.AcBillboardDescComponent=ee,t.AcBillboardPrimitiveDescComponent=Ge,t.AcCircleDescComponent=pe,t.AcEllipseDescComponent=ie,t.AcPolylineDescComponent=ne,t.AcPolylinePrimitiveDescComponent=ze,t.AcLabelComponent=fe,t.AcLabelDescComponent=se,t.AcLabelPrimitiveDescComponent=Ue,t.AcPolygonDescComponent=Ce,t.AcPolygonComponent=Se,t.AcPolylineComponent=me,t.AcPrimitivePolylineComponent=ii,t.AcPointComponent=ve,t.AcPointDescComponent=ye,t.AcCircleComponent=be,t.AcArcComponent=Ee,t.AcEllipseComponent=ge,t.AcHtmlComponent=Pe,t.AcMapLayerProviderComponent=he,t.AcDefaultPlonterComponent=_e,t.AcBoxDescComponent=je,t.AcCorridorDescComponent=Fe,t.AcCylinderDescComponent=Ne,t.AcEllipsoidDescComponent=ke,t.AcPolylineVolumeDescComponent=Ve,t.AcWallDescComponent=He,t.AcRectangleDescComponent=Be,t.AcTileset3dComponent=xe,t.AcHtmlDescComponent=Xe,t.AcArrayDescComponent=ti,t.AcDynamicCircleDescComponent=Te,t.AcDynamicEllipseDescComponent=Ae,t.AcDynamicPolylineDescComponent=De,t.AcStaticCircleDescComponent=we,t.AcStaticEllipseDescComponent=Ie,t.AcStaticPolygonDescComponent=Le,t.AcStaticPolylineDescComponent=Oe,t.MapEventsManagerService=bt,t.DisposableObservable=si,t.CesiumEventModifier=ai,t.CesiumEvent=G,t.PickOptions=U,t.CesiumService=B,t.CameraService=v,t.CoordinateConverter=$,t.GeoUtilsService=q,t.PlonterService=mt,t.ViewerConfiguration=H,t.MapsManagerService=Ct,t.KeyboardControlService=dt,t.PREDEFINED_KEYBOARD_ACTIONS=lt,t.ScreenshotService=_t,t.SelectionManagerService=pi,t.ContextMenuService=z,t.PixelOffsetPipe=oe,t.RadiansToDegreesPipe=re,t.CesiumHeatMapMaterialCreator=ci,t.AngularCesiumWidgetsModule=nn,t.EditActions=ui,t.EditModes=li,t.EditPoint=di,t.EditPolyline=hi,t.EditArc=Ei,t.EditablePolygon=fi,t.EditableCircle=Ci,t.EditablePolyline=Oi,t.EditableEllipse=Ai,t.EditorObservable=Ri,t.PolylineEditorObservable=xi,t.PolygonEditorObservable=ji,t.CircleEditorObservable=Ni,t.EllipseEditorObservable=Fi,t.defaultLabelProps=yi,t.HippodromeEditorObservable=ki,t.EditableHippodrome=Vi,t.PolygonsEditorComponent=bi,t.CirclesEditorComponent=Ii,t.PolylinesEditorComponent=Ui,t.HippodromeEditorComponent=$i,t.EllipsesEditorComponent=Ti,t.DraggableToMapDirective=Yi,t.AcToolbarComponent=qi,t.AcToolbarButtonComponent=Ji,t.RangeAndBearingComponent=Qi,t.DEFAULT_POLYGON_OPTIONS=vi,t.PolygonsEditorService=Pi,t.DEFAULT_CIRCLE_OPTIONS=Si,t.CirclesEditorService=Mi,t.DEFAULT_POLYLINE_OPTIONS=Hi,t.PolylinesEditorService=Bi,t.DEFAULT_HIPPODROME_OPTIONS=Ki,t.HippodromeEditorService=Wi,t.DEFAULT_ELLIPSE_OPTIONS=Li,t.EllipsesEditorService=wi,t.DraggableToMapService=Zi,t.MouseButtons=tn,t.ZoomToRectangleService=en,t.ɵcg=Xi,t.ɵcd=_i,t.ɵce=Di,t.ɵcb=zi,t.ɵcc=mi,t.ɵcf=Gi,t.ɵr=y,t.ɵs=f,t.ɵbt=Qe,t.ɵbz=oi,t.ɵbs=Re,t.ɵbu=ei,t.ɵby=Je,t.ɵbw=Ye,t.ɵbx=qe,t.ɵbv=Ze,t.ɵbp=Xt,t.ɵca=Me,t.ɵbq=te,t.ɵu=At,t.ɵn=X,t.ɵe=Z,t.ɵc=et,t.ɵbe=Kt,t.ɵw=Ft,t.ɵx=kt,t.ɵy=Vt,t.ɵo=it,t.ɵz=Ht,t.ɵl=nt,t.ɵd=tt,t.ɵf=J,t.ɵbg=$t,t.ɵh=ot,t.ɵbd=zt,t.ɵv=Nt,t.ɵm=rt,t.ɵbf=Wt,t.ɵp=st,t.ɵi=at,t.ɵj=pt,t.ɵba=Bt,t.ɵk=Y,t.ɵbc=Ut,t.ɵbi=wt,t.ɵbh=Lt,t.ɵbn=jt,t.ɵbj=Ot,t.ɵbm=xt,t.ɵbl=Rt,t.ɵbk=Tt,t.ɵbb=Gt,t.ɵbo=Yt,t.ɵbr=Jt,t.ɵt=Mt,t.ɵg=ft,t.ɵq=Et,t.ɵb=S,t.ɵa=ae,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=angular-cesium.umd.min.js.map